<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hachi.Compiler.CodeGen</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.html#generateCode"><span class="hs-identifier">generateCode</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.IO.Class</span></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Char8</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.IORef</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fromString</span></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.FilePath</span></span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">UntypedPlutusCore</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UPLC</span></span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">LLVM</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">LLVM.AST</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LLVM</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">LLVM.AST.Constant</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">LLVM.AST.IntegerPredicate</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LLVM</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">LLVM.AST.Linkage</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">LLVM.Context</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">LLVM.Target</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">LLVM.PassManager</span></span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Builtin.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Builtin</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Closure</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Common.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Common</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Constant</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.CPS.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.CPS</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Driver.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Driver</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Externals.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Externals</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Globals.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Globals</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">G</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.IRBuilder.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.IRBuilder</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IR</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Library.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Library</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Monad</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Types</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.Config.html"><span class="hs-identifier">Hachi.Compiler.Config</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.FreeVars.html"><span class="hs-identifier">Hachi.Compiler.FreeVars</span></a></span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-comment">-- | `mkClosureVar` @name@ constructs a pair of @</span><span>
</span><span id="line-49"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.html#mkClosureVar"><span class="hs-identifier hs-type">mkClosureVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UPLC.Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span id="mkClosureVar"><span class="annot"><span class="annottext">mkClosureVar :: Name -&gt; (Text, Bool)
</span><a href="Hachi.Compiler.CodeGen.html#mkClosureVar"><span class="hs-identifier hs-var hs-var">mkClosureVar</span></a></span></span><span> </span><span id="local-6989586621679264076"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679264076"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Text
</span><span class="hs-identifier hs-var hs-var">nameString</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679264076"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-comment">-- | `isSimpleTerm` @term@ determines whether @term@ is &quot;simple&quot; in the context</span><span>
</span><span id="line-53"></span><span class="hs-comment">-- of a function application. Specifically, @term@ is simple if compiling</span><span>
</span><span id="line-54"></span><span class="hs-comment">-- @term@ is guaranteed not to generate code which performs calls to PLC</span><span>
</span><span id="line-55"></span><span class="hs-comment">-- functions.</span><span>
</span><span id="line-56"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.html#isSimpleTerm"><span class="hs-identifier hs-type">isSimpleTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">UPLC.Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefaultUni</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefaultFun</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-57"></span><span id="isSimpleTerm"><span class="annot"><span class="annottext">isSimpleTerm :: Term Name DefaultUni DefaultFun () -&gt; Bool
</span><a href="Hachi.Compiler.CodeGen.html#isSimpleTerm"><span class="hs-identifier hs-var hs-var">isSimpleTerm</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Error</span></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-58"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.html#isSimpleTerm"><span class="hs-identifier hs-var">isSimpleTerm</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Var</span></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-59"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.html#isSimpleTerm"><span class="hs-identifier hs-var">isSimpleTerm</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">LamAbs</span></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-60"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.html#isSimpleTerm"><span class="hs-identifier hs-var">isSimpleTerm</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Delay</span></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-61"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.html#isSimpleTerm"><span class="hs-identifier hs-var">isSimpleTerm</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Constant</span></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-62"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.html#isSimpleTerm"><span class="hs-identifier hs-var">isSimpleTerm</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builtin</span></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-63"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.html#isSimpleTerm"><span class="hs-identifier hs-var">isSimpleTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-comment">-- | `compileForce` @name continuation closure terminator@ generates code</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- which forces the closure given by @closure@ and passes the result to</span><span>
</span><span id="line-67"></span><span class="hs-comment">-- @continuation@. The computation @terminator@ is used to generate code</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- which handles the result of the continuation.</span><span>
</span><span id="line-69"></span><span id="local-6989586621679264153"><span id="local-6989586621679264154"><span class="annot"><a href="Hachi.Compiler.CodeGen.html#compileForce"><span class="hs-identifier hs-type">compileForce</span></a></span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#MonadCodeGen"><span class="hs-identifier hs-type">MonadCodeGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264154"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679264154"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#Continuation"><span class="hs-identifier hs-type">Continuation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Operand</span></span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#DynamicPtr"><span class="hs-identifier hs-type">DynamicPtr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679264154"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264153"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679264154"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264153"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-74"></span><span id="compileForce"><span class="annot"><span class="annottext">compileForce :: String
-&gt; Continuation
-&gt; Operand
-&gt; (ClosurePtr 'DynamicPtr -&gt; m a)
-&gt; m a
</span><a href="Hachi.Compiler.CodeGen.html#compileForce"><span class="hs-identifier hs-var hs-var">compileForce</span></a></span></span><span> </span><span id="local-6989586621679264066"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679264066"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679264065"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679264065"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679264064"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679264064"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679264063"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; m a
</span><a href="#local-6989586621679264063"><span class="hs-identifier hs-var">terminator</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-75"></span><span>    </span><span class="hs-comment">-- We need to determine whether evaluation of the body results in a</span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-comment">-- delay term or not - the PLC interpreter treats the latter as an</span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-comment">-- error so we should, too. For this purpose, we store some flags</span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-comment">-- in the closure that indicate whether the closure belongs to a</span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-comment">-- delay term or not. Here, we inspect those flags to determine</span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-comment">-- whether to enter the closure or print an error.</span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679264062"><span class="annot"><span class="annottext">trueBr :: Name
</span><a href="#local-6989586621679264062"><span class="hs-identifier hs-var hs-var">trueBr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">mkName</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Name) -&gt; String -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679264066"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_delay&quot;</span></span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679264060"><span class="annot"><span class="annottext">falseBr :: Name
</span><a href="#local-6989586621679264060"><span class="hs-identifier hs-var hs-var">falseBr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">mkName</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Name) -&gt; String -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679264066"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_fail&quot;</span></span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span>    </span><span id="local-6989586621679264059"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679264059"><span class="hs-identifier hs-var">flags</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ClosureComponent -&gt; Type -&gt; ClosurePtr 'DynamicPtr -&gt; m Operand
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#loadFromClosure"><span class="hs-identifier hs-var">loadFromClosure</span></a></span><span> </span><span class="annot"><span class="annottext">ClosureComponent
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureFlags"><span class="hs-identifier hs-var">ClosureFlags</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.Platform.html#iHost"><span class="hs-identifier hs-var">iHost</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Operand -&gt; ClosurePtr 'DynamicPtr
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkClosurePtr"><span class="hs-identifier hs-var">MkClosurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679264064"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>    </span><span id="local-6989586621679264054"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679264054"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IntegerPredicate -&gt; Operand -&gt; Operand -&gt; m Operand
forall (m :: * -&gt; *).
MonadIRBuilder m =&gt;
IntegerPredicate -&gt; Operand -&gt; Operand -&gt; m Operand
</span><span class="hs-identifier hs-var">icmp</span></span><span> </span><span class="annot"><span class="annottext">IntegerPredicate
</span><span class="hs-identifier hs-var">LLVM.EQ</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679264059"><span class="hs-identifier hs-var">flags</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; Operand) -&gt; Constant -&gt; Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Integer -&gt; Constant
</span><span class="hs-identifier hs-var">Int</span></span><span> </span><span class="annot"><span class="annottext">Word32
forall a. Num a =&gt; a
</span><a href="Hachi.Compiler.Platform.html#platformIntSize"><span class="hs-identifier hs-var">platformIntSize</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>    </span><span class="annot"><span class="annottext">Operand -&gt; Name -&gt; Name -&gt; m ()
forall (m :: * -&gt; *).
MonadIRBuilder m =&gt;
Operand -&gt; Name -&gt; Name -&gt; m ()
</span><span class="hs-identifier hs-var">condBr</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679264054"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679264062"><span class="hs-identifier hs-var">trueBr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679264060"><span class="hs-identifier hs-var">falseBr</span></a></span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-comment">-- Enter the closure that is returned from the body: it corresponds to a</span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-comment">-- delay term</span><span>
</span><span id="line-90"></span><span>    </span><span class="annot"><span class="annottext">Name -&gt; m ()
forall (m :: * -&gt; *). MonadIRBuilder m =&gt; Name -&gt; m ()
</span><span class="hs-identifier hs-var">emitBlockStart</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679264062"><span class="hs-identifier hs-var">trueBr</span></a></span><span>
</span><span id="line-91"></span><span>    </span><span id="local-6989586621679264046"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679264046"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Continuation
-&gt; ClosurePtr 'DynamicPtr
-&gt; ClosurePtr 'DynamicPtr
-&gt; m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *) (f :: PtrKind) (x :: PtrKind).
(MonadFail m, MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Continuation
-&gt; ClosurePtr f -&gt; ClosurePtr x -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Closure.html#compileApply"><span class="hs-identifier hs-var">compileApply</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679264065"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Operand -&gt; ClosurePtr 'DynamicPtr
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkClosurePtr"><span class="hs-identifier hs-var">MkClosurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679264064"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Operand -&gt; ClosurePtr 'DynamicPtr
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkClosurePtr"><span class="hs-identifier hs-var">MkClosurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679264064"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (ClosurePtr 'DynamicPtr)
-&gt; (ClosurePtr 'DynamicPtr -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; m a
</span><a href="#local-6989586621679264063"><span class="hs-identifier hs-var">terminator</span></a></span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-comment">-- The closure does not belong to a delay term: this is a runtime error</span><span>
</span><span id="line-94"></span><span>    </span><span class="annot"><span class="annottext">Name -&gt; m ()
forall (m :: * -&gt; *). MonadIRBuilder m =&gt; Name -&gt; m ()
</span><span class="hs-identifier hs-var">emitBlockStart</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679264060"><span class="hs-identifier hs-var">falseBr</span></a></span><span>
</span><span id="line-95"></span><span>    </span><span class="annot"><span class="annottext">m Operand -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m Operand -&gt; m ()) -&gt; m Operand -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#printf"><span class="hs-identifier hs-var">printf</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#forceErrRef"><span class="hs-identifier hs-var">forceErrRef</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-96"></span><span>    </span><span class="annot"><span class="annottext">m Operand -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m Operand -&gt; m ()) -&gt; m Operand -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Integer -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#exit"><span class="hs-identifier hs-var">exit</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>    </span><span class="annot"><span class="annottext">m ()
forall (m :: * -&gt; *). MonadIRBuilder m =&gt; m ()
</span><span class="hs-identifier hs-var">unreachable</span></span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span>    </span><span class="annot"><span class="annottext">a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679264046"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span class="hs-comment">-- | `compileNonCPS` @term@ compiles a &quot;simple&quot; @term@.</span><span>
</span><span id="line-102"></span><span id="local-6989586621679264163"><span class="annot"><a href="Hachi.Compiler.CodeGen.html#compileNonCPS"><span class="hs-identifier hs-type">compileNonCPS</span></a></span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#MonadCodeGen"><span class="hs-identifier hs-type">MonadCodeGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264163"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">UPLC.Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefaultUni</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefaultFun</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IRBuilderT</span></span><span> </span><span class="annot"><a href="#local-6989586621679264163"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#DynamicPtr"><span class="hs-identifier hs-type">DynamicPtr</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-106"></span><span class="hs-comment">-- (error): as soon as execution reaches this term, print a message indicating</span><span>
</span><span id="line-107"></span><span class="hs-comment">-- that an error condition has been reached and terminate execution</span><span>
</span><span id="line-108"></span><span id="compileNonCPS"><span class="annot"><span class="annottext">compileNonCPS :: Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.html#compileNonCPS"><span class="hs-identifier hs-var hs-var">compileNonCPS</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Error</span></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-109"></span><span>    </span><span id="local-6989586621679264038"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679264038"><span class="hs-identifier hs-var">errMsg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(CodeGenSt -&gt; Constant) -&gt; IRBuilderT m Constant
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">CodeGenSt -&gt; Constant
</span><a href="Hachi.Compiler.CodeGen.Monad.html#codeGenErrMsg"><span class="hs-identifier hs-var hs-var">codeGenErrMsg</span></a></span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-comment">-- print the error message and terminate the program</span><span>
</span><span id="line-112"></span><span>    </span><span class="annot"><span class="annottext">IRBuilderT m Operand -&gt; IRBuilderT m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IRBuilderT m Operand -&gt; IRBuilderT m ())
-&gt; IRBuilderT m Operand -&gt; IRBuilderT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; IRBuilderT m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#printf"><span class="hs-identifier hs-var">printf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679264038"><span class="hs-identifier hs-var">errMsg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-113"></span><span>    </span><span class="annot"><span class="annottext">IRBuilderT m Operand -&gt; IRBuilderT m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IRBuilderT m Operand -&gt; IRBuilderT m ())
-&gt; IRBuilderT m Operand -&gt; IRBuilderT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; IRBuilderT m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Integer -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#exit"><span class="hs-identifier hs-var">exit</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-comment">-- this part of the program should not be reachable</span><span>
</span><span id="line-116"></span><span>    </span><span class="annot"><span class="annottext">IRBuilderT m ()
forall (m :: * -&gt; *). MonadIRBuilder m =&gt; m ()
</span><span class="hs-identifier hs-var">unreachable</span></span><span>
</span><span id="line-117"></span><span>    </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ClosurePtr 'DynamicPtr -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr))
-&gt; ClosurePtr 'DynamicPtr -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; ClosurePtr 'DynamicPtr
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkClosurePtr"><span class="hs-identifier hs-var">MkClosurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">(Operand -&gt; ClosurePtr 'DynamicPtr)
-&gt; Operand -&gt; ClosurePtr 'DynamicPtr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; Operand) -&gt; Constant -&gt; Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Constant
</span><span class="hs-identifier hs-var">Null</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span>
</span><span id="line-118"></span><span class="hs-comment">-- (x): for variables, there are two possibilities:</span><span>
</span><span id="line-119"></span><span class="hs-comment">-- 1. the variable is not in scope, in which case we print an error message</span><span>
</span><span id="line-120"></span><span class="hs-comment">-- as soon as execution reaches the variable expression</span><span>
</span><span id="line-121"></span><span class="hs-comment">-- 2. the variable is in scope, in which case it represents a pointer to a</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- closure which we return up the call stack</span><span>
</span><span id="line-123"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.html#compileNonCPS"><span class="hs-identifier hs-var">compileNonCPS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Var</span></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679264033"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679264033"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><span class="annottext">Operand -&gt; ClosurePtr 'DynamicPtr
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkClosurePtr"><span class="hs-identifier hs-var">MkClosurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">(Operand -&gt; ClosurePtr 'DynamicPtr)
-&gt; IRBuilderT m Operand -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Type -&gt; IRBuilderT m Operand
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m, MonadFail m) =&gt;
Text -&gt; Type -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#lookupVar"><span class="hs-identifier hs-var">lookupVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Text
</span><span class="hs-identifier hs-var hs-var">nameString</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679264033"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span>
</span><span id="line-125"></span><span class="hs-comment">-- (lam x e): since PLC has higher-order functions, functions may escape the</span><span>
</span><span id="line-126"></span><span class="hs-comment">-- scope in which they are defined in. Therefore, we require closures which</span><span>
</span><span id="line-127"></span><span class="hs-comment">-- store pointers to the free variables. We compile functions as follows:</span><span>
</span><span id="line-128"></span><span class="hs-comment">-- 1. We generate a new LLVM function that represents the entry point of the</span><span>
</span><span id="line-129"></span><span class="hs-comment">--    closure which is executed when we enter the closure. This function</span><span>
</span><span id="line-130"></span><span class="hs-comment">--    expects a pointer to the closure and a pointer to its (sole) argument.</span><span>
</span><span id="line-131"></span><span class="hs-comment">--    We assume that all variables represent pointers to closures, so that</span><span>
</span><span id="line-132"></span><span class="hs-comment">--    the representation of the argument is uniform. The entry point assumes</span><span>
</span><span id="line-133"></span><span class="hs-comment">--    that pointers to all free variables are stored in the closure and we</span><span>
</span><span id="line-134"></span><span class="hs-comment">--    generate code to retrieve them from there before updating the local</span><span>
</span><span id="line-135"></span><span class="hs-comment">--    environment used to compile the body.</span><span>
</span><span id="line-136"></span><span class="hs-comment">-- 2. We generate code that dynamically allocates a closure. The closure will</span><span>
</span><span id="line-137"></span><span class="hs-comment">--    consist of a pointer to the entry function that we generated in step 1</span><span>
</span><span id="line-138"></span><span class="hs-comment">--    and pointers to all free variables.</span><span>
</span><span id="line-139"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.html#compileNonCPS"><span class="hs-identifier hs-var">compileNonCPS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LamAbs</span></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679264030"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679264030"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span id="local-6989586621679264029"><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264029"><span class="hs-identifier hs-var">term</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-140"></span><span>    </span><span id="local-6989586621679264028"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679264028"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IRBuilderT m String
forall (m :: * -&gt; *).
(MonadReader CodeGenSt m, MonadIO m) =&gt;
String -&gt; m String
</span><a href="Hachi.Compiler.CodeGen.Monad.html#mkFresh"><span class="hs-identifier hs-var">mkFresh</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;fun&quot;</span></span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-comment">-- TODO: the S.map here might be overly pessimistic, we might be able</span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-comment">-- to replace it with S.mapMonotonic for better performance</span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679264026"><span class="annot"><span class="annottext">fvs :: Set (Text, Bool)
</span><a href="#local-6989586621679264026"><span class="hs-identifier hs-var hs-var">fvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; (Text, Bool)) -&gt; Set Name -&gt; Set (Text, Bool)
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; (Text, Bool)
</span><a href="Hachi.Compiler.CodeGen.html#mkClosureVar"><span class="hs-identifier hs-var">mkClosureVar</span></a></span><span>
</span><span id="line-145"></span><span>            </span><span class="annot"><span class="annottext">(Set Name -&gt; Set (Text, Bool)) -&gt; Set Name -&gt; Set (Text, Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Set Name -&gt; Set Name
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.delete</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679264030"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">(Set Name -&gt; Set Name) -&gt; Set Name -&gt; Set Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun () -&gt; Set Name
forall name (uni :: * -&gt; *) fun ann.
Ord name =&gt;
Term name uni fun ann -&gt; Set name
</span><a href="Hachi.Compiler.FreeVars.html#freeVars"><span class="hs-identifier hs-var">freeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264029"><span class="hs-identifier hs-var">term</span></a></span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-comment">-- return the pointer to the new closure to the continuation</span><span>
</span><span id="line-148"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; String
-&gt; Set (Text, Bool)
-&gt; Text
-&gt; (Operand -&gt; Operand -&gt; Continuation -&gt; IRBuilderT m ())
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
Bool
-&gt; String
-&gt; Set (Text, Bool)
-&gt; Text
-&gt; (Operand -&gt; Operand -&gt; Continuation -&gt; IRBuilderT m ())
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Closure.html#compileDynamicClosure"><span class="hs-identifier hs-var">compileDynamicClosure</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679264028"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Set (Text, Bool)
</span><a href="#local-6989586621679264026"><span class="hs-identifier hs-var">fvs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Text
</span><span class="hs-identifier hs-var hs-var">UPLC.nameString</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679264030"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Operand -&gt; Operand -&gt; Continuation -&gt; IRBuilderT m ())
 -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr))
-&gt; (Operand -&gt; Operand -&gt; Continuation -&gt; IRBuilderT m ())
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-149"></span><span>        </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679264021"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679264021"><span class="hs-identifier hs-var">k'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.html#compileBody"><span class="hs-identifier hs-var">compileBody</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679264021"><span class="hs-identifier hs-var">k'</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264029"><span class="hs-identifier hs-var">term</span></a></span><span> </span><span class="annot"><span class="annottext">IRBuilderT m (ClosurePtr 'DynamicPtr)
-&gt; (ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()) -&gt; IRBuilderT m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Closure.html#retClosure"><span class="hs-identifier hs-var">retClosure</span></a></span><span>
</span><span id="line-150"></span><span class="hs-comment">-- (delay t): we compile this just like a lambda abstraction to prevent it</span><span>
</span><span id="line-151"></span><span class="hs-comment">-- from being executed straight away - a force expression is then just like</span><span>
</span><span id="line-152"></span><span class="hs-comment">-- function application, minus the argument</span><span>
</span><span id="line-153"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.html#compileNonCPS"><span class="hs-identifier hs-var">compileNonCPS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Delay</span></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679264018"><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264018"><span class="hs-identifier hs-var">term</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-154"></span><span>    </span><span id="local-6989586621679264017"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679264017"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IRBuilderT m String
forall (m :: * -&gt; *).
(MonadReader CodeGenSt m, MonadIO m) =&gt;
String -&gt; m String
</span><a href="Hachi.Compiler.CodeGen.Monad.html#mkFresh"><span class="hs-identifier hs-var">mkFresh</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;delay&quot;</span></span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span>    </span><span class="hs-comment">-- TODO: the S.map here might be overly pessimistic, we might be able</span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-comment">-- to replace it with S.mapMonotonic for better performance</span><span>
</span><span id="line-158"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679264016"><span class="annot"><span class="annottext">fvs :: Set (Text, Bool)
</span><a href="#local-6989586621679264016"><span class="hs-identifier hs-var hs-var">fvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; (Text, Bool)) -&gt; Set Name -&gt; Set (Text, Bool)
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; (Text, Bool)
</span><a href="Hachi.Compiler.CodeGen.html#mkClosureVar"><span class="hs-identifier hs-var">mkClosureVar</span></a></span><span> </span><span class="annot"><span class="annottext">(Set Name -&gt; Set (Text, Bool)) -&gt; Set Name -&gt; Set (Text, Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun () -&gt; Set Name
forall name (uni :: * -&gt; *) fun ann.
Ord name =&gt;
Term name uni fun ann -&gt; Set name
</span><a href="Hachi.Compiler.FreeVars.html#freeVars"><span class="hs-identifier hs-var">freeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264018"><span class="hs-identifier hs-var">term</span></a></span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span>    </span><span class="hs-comment">-- for now we are compiling it exactly the same way as a function and,</span><span>
</span><span id="line-161"></span><span>    </span><span class="hs-comment">-- therefore, if evaluation results in a delay term, we get a result</span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-comment">-- equivalent to the one we get when evaluation results in a function;</span><span>
</span><span id="line-163"></span><span>    </span><span class="hs-comment">-- in the future, we might want to print a different message</span><span>
</span><span id="line-164"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; String
-&gt; Set (Text, Bool)
-&gt; Text
-&gt; (Operand -&gt; Operand -&gt; Continuation -&gt; IRBuilderT m ())
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
Bool
-&gt; String
-&gt; Set (Text, Bool)
-&gt; Text
-&gt; (Operand -&gt; Operand -&gt; Continuation -&gt; IRBuilderT m ())
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Closure.html#compileDynamicClosure"><span class="hs-identifier hs-var">compileDynamicClosure</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679264017"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Set (Text, Bool)
</span><a href="#local-6989586621679264016"><span class="hs-identifier hs-var">fvs</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;_delayArg&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Operand -&gt; Operand -&gt; Continuation -&gt; IRBuilderT m ())
 -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr))
-&gt; (Operand -&gt; Operand -&gt; Continuation -&gt; IRBuilderT m ())
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-165"></span><span>        </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679264015"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679264015"><span class="hs-identifier hs-var">k'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.html#compileBody"><span class="hs-identifier hs-var">compileBody</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679264015"><span class="hs-identifier hs-var">k'</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264018"><span class="hs-identifier hs-var">term</span></a></span><span> </span><span class="annot"><span class="annottext">IRBuilderT m (ClosurePtr 'DynamicPtr)
-&gt; (ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()) -&gt; IRBuilderT m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Closure.html#retClosure"><span class="hs-identifier hs-var">retClosure</span></a></span><span>
</span><span id="line-166"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.html#compileNonCPS"><span class="hs-identifier hs-var">compileNonCPS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Constant</span></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679264014"><span class="annot"><span class="annottext">Some (ValueOf DefaultUni)
</span><a href="#local-6989586621679264014"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'StaticPtr -&gt; ClosurePtr 'DynamicPtr
forall (k :: PtrKind). ClosurePtr k -&gt; ClosurePtr 'DynamicPtr
</span><a href="Hachi.Compiler.CodeGen.Types.html#toDynamicPtr"><span class="hs-identifier hs-var">toDynamicPtr</span></a></span><span> </span><span class="annot"><span class="annottext">(ClosurePtr 'StaticPtr -&gt; ClosurePtr 'DynamicPtr)
-&gt; IRBuilderT m (ClosurePtr 'StaticPtr)
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Some (ValueOf DefaultUni) -&gt; IRBuilderT m (ClosurePtr 'StaticPtr)
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m) =&gt;
Some (ValueOf DefaultUni) -&gt; m (ClosurePtr 'StaticPtr)
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileConst"><span class="hs-identifier hs-var">compileConst</span></a></span><span> </span><span class="annot"><span class="annottext">Some (ValueOf DefaultUni)
</span><a href="#local-6989586621679264014"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-167"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.html#compileNonCPS"><span class="hs-identifier hs-var">compileNonCPS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Builtin</span></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679264011"><span class="annot"><span class="annottext">DefaultFun
</span><a href="#local-6989586621679264011"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-168"></span><span>    </span><span id="local-6989586621679264010"><span class="annot"><span class="annottext">Map DefaultFun (ClosurePtr 'StaticPtr)
</span><a href="#local-6989586621679264010"><span class="hs-identifier hs-var">builtins</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(CodeGenSt -&gt; Map DefaultFun (ClosurePtr 'StaticPtr))
-&gt; IRBuilderT m (Map DefaultFun (ClosurePtr 'StaticPtr))
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">CodeGenSt -&gt; Map DefaultFun (ClosurePtr 'StaticPtr)
</span><a href="Hachi.Compiler.CodeGen.Monad.html#codeGenBuiltins"><span class="hs-identifier hs-var hs-var">codeGenBuiltins</span></a></span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DefaultFun
-&gt; Map DefaultFun (ClosurePtr 'StaticPtr)
-&gt; Maybe (ClosurePtr 'StaticPtr)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">DefaultFun
</span><a href="#local-6989586621679264011"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Map DefaultFun (ClosurePtr 'StaticPtr)
</span><a href="#local-6989586621679264010"><span class="hs-identifier hs-var">builtins</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-170"></span><span>        </span><span class="annot"><span class="annottext">Maybe (ClosurePtr 'StaticPtr)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr))
-&gt; String -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;No such builtin: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">DefaultFun -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">DefaultFun
</span><a href="#local-6989586621679264011"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-171"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679264005"><span class="annot"><span class="annottext">ClosurePtr 'StaticPtr
</span><a href="#local-6989586621679264005"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ClosurePtr 'DynamicPtr -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr))
-&gt; ClosurePtr 'DynamicPtr -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'StaticPtr -&gt; ClosurePtr 'DynamicPtr
forall (k :: PtrKind). ClosurePtr k -&gt; ClosurePtr 'DynamicPtr
</span><a href="Hachi.Compiler.CodeGen.Types.html#toDynamicPtr"><span class="hs-identifier hs-var">toDynamicPtr</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'StaticPtr
</span><a href="#local-6989586621679264005"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-172"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.html#compileNonCPS"><span class="hs-identifier hs-var">compileNonCPS</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;compileNonCPS: called on a complex term&quot;</span></span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span class="hs-comment">-- | `compileBody` @term@ compiles @term@ to LLVM.</span><span>
</span><span id="line-175"></span><span id="local-6989586621679264181"><span class="annot"><a href="Hachi.Compiler.CodeGen.html#compileBody"><span class="hs-identifier hs-type">compileBody</span></a></span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#MonadCodeGen"><span class="hs-identifier hs-type">MonadCodeGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264181"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#Continuation"><span class="hs-identifier hs-type">Continuation</span></a></span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">UPLC.Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefaultUni</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefaultFun</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IRBuilderT</span></span><span> </span><span class="annot"><a href="#local-6989586621679264181"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#DynamicPtr"><span class="hs-identifier hs-type">DynamicPtr</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-180"></span><span id="compileBody"><span class="annot"><span class="annottext">compileBody :: Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.html#compileBody"><span class="hs-identifier hs-var hs-var">compileBody</span></a></span></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679264004"><span class="annot"><span class="annottext">t :: Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264004"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Error</span></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.html#compileNonCPS"><span class="hs-identifier hs-var">compileNonCPS</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264004"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-181"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.html#compileBody"><span class="hs-identifier hs-var">compileBody</span></a></span><span> </span><span id="local-6989586621679264003"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679264003"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Apply</span></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679264001"><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264001"><span class="hs-identifier hs-var">lhs</span></a></span></span><span> </span><span id="local-6989586621679264000"><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264000"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>    </span><span class="hs-comment">-- compiling applications is the most complicated aspect of the code</span><span>
</span><span id="line-183"></span><span>    </span><span class="hs-comment">-- generation, since the generated code involves a guaranteed function</span><span>
</span><span id="line-184"></span><span>    </span><span class="hs-comment">-- call at the end: this is, on its own, not a problem, but it is if</span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-comment">-- either operand of the application is also an application, because</span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-comment">-- we must then perform a CPS transformation to ensure that all calls</span><span>
</span><span id="line-187"></span><span>    </span><span class="hs-comment">-- are tail calls; to avoid introducing this complexity where it is</span><span>
</span><span id="line-188"></span><span>    </span><span class="hs-comment">-- not required, we perform a simple check here to see if both operands</span><span>
</span><span id="line-189"></span><span>    </span><span class="hs-comment">-- are &quot;simple&quot; and will not result in code that performs any function</span><span>
</span><span id="line-190"></span><span>    </span><span class="hs-comment">-- calls, in which case we don't need to perform a CPS transformation</span><span>
</span><span id="line-191"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun () -&gt; Bool
</span><a href="Hachi.Compiler.CodeGen.html#isSimpleTerm"><span class="hs-identifier hs-var">isSimpleTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264001"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun () -&gt; Bool
</span><a href="Hachi.Compiler.CodeGen.html#isSimpleTerm"><span class="hs-identifier hs-var">isSimpleTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264000"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-192"></span><span>        </span><span id="local-6989586621679263998"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263998"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IRBuilderT m String
forall (m :: * -&gt; *).
(MonadReader CodeGenSt m, MonadIO m) =&gt;
String -&gt; m String
</span><a href="Hachi.Compiler.CodeGen.Monad.html#mkFresh"><span class="hs-identifier hs-var">mkFresh</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;app&quot;</span></span><span>
</span><span id="line-193"></span><span>
</span><span id="line-194"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; [Operand] -&gt; IRBuilderT m ()
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m) =&gt;
String -&gt; [Operand] -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Common.html#compileTrace"><span class="hs-identifier hs-var">compileTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263998"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span>        </span><span class="hs-comment">-- both calls to `compileBody` here are guaranteed to not use `k` or</span><span>
</span><span id="line-197"></span><span>        </span><span class="hs-comment">-- make any PLC function calls, since `isSimpleTerm` is `True` for</span><span>
</span><span id="line-198"></span><span>        </span><span class="hs-comment">-- both of them</span><span>
</span><span id="line-199"></span><span>        </span><span id="local-6989586621679263996"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263996"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.html#compileNonCPS"><span class="hs-identifier hs-var">compileNonCPS</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264001"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-200"></span><span>        </span><span id="local-6989586621679263995"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263995"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.html#compileNonCPS"><span class="hs-identifier hs-var">compileNonCPS</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264000"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; [Operand] -&gt; IRBuilderT m ()
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m) =&gt;
String -&gt; [Operand] -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Common.html#compileTrace"><span class="hs-identifier hs-var">compileTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Entering closure in &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263998"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span>        </span><span class="hs-comment">-- enter the closure pointed to by l, giving it a pointer to another</span><span>
</span><span id="line-205"></span><span>        </span><span class="hs-comment">-- closure r as argument</span><span>
</span><span id="line-206"></span><span>        </span><span class="annot"><span class="annottext">Continuation
-&gt; ClosurePtr 'DynamicPtr
-&gt; ClosurePtr 'DynamicPtr
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *) (f :: PtrKind) (x :: PtrKind).
(MonadFail m, MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Continuation
-&gt; ClosurePtr f -&gt; ClosurePtr x -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Closure.html#compileApply"><span class="hs-identifier hs-var">compileApply</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679264003"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263996"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263995"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-207"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun () -&gt; Bool
</span><a href="Hachi.Compiler.CodeGen.html#isSimpleTerm"><span class="hs-identifier hs-var">isSimpleTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264001"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-208"></span><span>        </span><span id="local-6989586621679263994"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263994"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IRBuilderT m String
forall (m :: * -&gt; *).
(MonadReader CodeGenSt m, MonadIO m) =&gt;
String -&gt; m String
</span><a href="Hachi.Compiler.CodeGen.Monad.html#mkFresh"><span class="hs-identifier hs-var">mkFresh</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;app&quot;</span></span><span>
</span><span id="line-209"></span><span>        </span><span id="local-6989586621679263993"><span class="annot"><span class="annottext">Set (Text, Bool)
</span><a href="#local-6989586621679263993"><span class="hs-identifier hs-var">fvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IRBuilderT m (Set (Text, Bool))
forall (m :: * -&gt; *).
MonadReader CodeGenSt m =&gt;
m (Set (Text, Bool))
</span><a href="Hachi.Compiler.CodeGen.Monad.html#currentFreeVars"><span class="hs-identifier hs-var">currentFreeVars</span></a></span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; [Operand] -&gt; IRBuilderT m ()
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m) =&gt;
String -&gt; [Operand] -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Common.html#compileTrace"><span class="hs-identifier hs-var">compileTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263994"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span>        </span><span id="local-6989586621679263991"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263991"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.html#compileNonCPS"><span class="hs-identifier hs-var">compileNonCPS</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264001"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span>        </span><span class="hs-comment">-- generate some names for the parameters of the continuations, as well</span><span>
</span><span id="line-216"></span><span>        </span><span class="hs-comment">-- as the current continuation that we need to store as a free variable</span><span>
</span><span id="line-217"></span><span>        </span><span class="hs-comment">-- in the continuations</span><span>
</span><span id="line-218"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263990"><span class="annot"><span class="annottext">argK :: Text
</span><a href="#local-6989586621679263990"><span class="hs-identifier hs-var hs-var">argK</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263994"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_k&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263988"><span class="annot"><span class="annottext">argR :: Text
</span><a href="#local-6989586621679263988"><span class="hs-identifier hs-var hs-var">argR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263994"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_arg_r&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263987"><span class="annot"><span class="annottext">argL :: Text
</span><a href="#local-6989586621679263987"><span class="hs-identifier hs-var hs-var">argL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263994"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_arg_l&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>
</span><span id="line-222"></span><span>        </span><span class="hs-comment">-- calculate the sets of free variables of the two continuations</span><span>
</span><span id="line-223"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263986"><span class="annot"><span class="annottext">fvsR :: Set (Text, Bool)
</span><a href="#local-6989586621679263986"><span class="hs-identifier hs-var hs-var">fvsR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; (Text, Bool)) -&gt; Set Name -&gt; Set (Text, Bool)
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; (Text, Bool)
</span><a href="Hachi.Compiler.CodeGen.html#mkClosureVar"><span class="hs-identifier hs-var">mkClosureVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun () -&gt; Set Name
forall name (uni :: * -&gt; *) fun ann.
Ord name =&gt;
Term name uni fun ann -&gt; Set name
</span><a href="Hachi.Compiler.FreeVars.html#freeVars"><span class="hs-identifier hs-var">freeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264000"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>                </span><span class="annot"><span class="annottext">Set (Text, Bool) -&gt; Set (Text, Bool) -&gt; Set (Text, Bool)
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">`S.union`</span></span><span> </span><span class="annot"><span class="annottext">(Text, Bool) -&gt; Set (Text, Bool)
forall a. a -&gt; Set a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263987"><span class="hs-identifier hs-var">argL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>                </span><span class="annot"><span class="annottext">Set (Text, Bool) -&gt; Set (Text, Bool) -&gt; Set (Text, Bool)
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">`S.union`</span></span><span> </span><span class="annot"><span class="annottext">(Text, Bool) -&gt; Set (Text, Bool)
forall a. a -&gt; Set a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263990"><span class="hs-identifier hs-var">argK</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span>        </span><span class="hs-comment">-- generate code for the first continuation</span><span>
</span><span id="line-228"></span><span>        </span><span id="local-6989586621679263983"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263983"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-229"></span><span>            </span><span class="annot"><span class="annottext">Text
-&gt; Local -&gt; IRBuilderT m Continuation -&gt; IRBuilderT m Continuation
forall (m :: * -&gt; *) a.
MonadReader CodeGenSt m =&gt;
Text -&gt; Local -&gt; m a -&gt; m a
</span><a href="Hachi.Compiler.CodeGen.Monad.html#extendScope"><span class="hs-identifier hs-var">extendScope</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263990"><span class="hs-identifier hs-var">argK</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Continuation -&gt; Local
</span><a href="Hachi.Compiler.CodeGen.Types.html#LocalCont"><span class="hs-identifier hs-var">LocalCont</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679264003"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IRBuilderT m Continuation -&gt; IRBuilderT m Continuation)
-&gt; IRBuilderT m Continuation -&gt; IRBuilderT m Continuation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-230"></span><span>            </span><span class="annot"><span class="annottext">Text
-&gt; Local -&gt; IRBuilderT m Continuation -&gt; IRBuilderT m Continuation
forall (m :: * -&gt; *) a.
MonadReader CodeGenSt m =&gt;
Text -&gt; Local -&gt; m a -&gt; m a
</span><a href="Hachi.Compiler.CodeGen.Monad.html#extendScope"><span class="hs-identifier hs-var">extendScope</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263987"><span class="hs-identifier hs-var">argL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; Local
</span><a href="Hachi.Compiler.CodeGen.Types.html#LocalClosure"><span class="hs-identifier hs-var">LocalClosure</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263991"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IRBuilderT m Continuation -&gt; IRBuilderT m Continuation)
-&gt; IRBuilderT m Continuation -&gt; IRBuilderT m Continuation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-231"></span><span>            </span><span class="annot"><span class="annottext">String
-&gt; Set (Text, Bool)
-&gt; Text
-&gt; (Operand -&gt; Operand -&gt; IRBuilderT m ())
-&gt; IRBuilderT m Continuation
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
String
-&gt; Set (Text, Bool)
-&gt; Text
-&gt; (Operand -&gt; Operand -&gt; IRBuilderT m ())
-&gt; IRBuilderT m Continuation
</span><a href="Hachi.Compiler.CodeGen.CPS.html#compileDynamicCont"><span class="hs-identifier hs-var">compileDynamicCont</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263994"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_cont&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set (Text, Bool)
</span><a href="#local-6989586621679263986"><span class="hs-identifier hs-var">fvsR</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263988"><span class="hs-identifier hs-var">argR</span></a></span><span> </span><span class="annot"><span class="annottext">((Operand -&gt; Operand -&gt; IRBuilderT m ())
 -&gt; IRBuilderT m Continuation)
-&gt; (Operand -&gt; Operand -&gt; IRBuilderT m ())
-&gt; IRBuilderT m Continuation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-232"></span><span>                </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679263978"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679263978"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-233"></span><span>                    </span><span class="annot"><span class="annottext">String -&gt; [Operand] -&gt; IRBuilderT m ()
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m) =&gt;
String -&gt; [Operand] -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Common.html#compileTrace"><span class="hs-identifier hs-var">compileTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Entering closure in &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263994"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-234"></span><span>
</span><span id="line-235"></span><span>                    </span><span class="hs-comment">-- retrieve the initial continuation and the result of</span><span>
</span><span id="line-236"></span><span>                    </span><span class="hs-comment">-- evaluating the LHS from the current continuation</span><span>
</span><span id="line-237"></span><span>                    </span><span class="hs-comment">-- closure</span><span>
</span><span id="line-238"></span><span>                    </span><span id="local-6989586621679263977"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263977"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; Continuation
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkCont"><span class="hs-identifier hs-var">MkCont</span></a></span><span> </span><span class="annot"><span class="annottext">(Operand -&gt; Continuation)
-&gt; IRBuilderT m Operand -&gt; IRBuilderT m Continuation
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Type -&gt; IRBuilderT m Operand
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m, MonadFail m) =&gt;
Text -&gt; Type -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#lookupVar"><span class="hs-identifier hs-var">lookupVar</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263990"><span class="hs-identifier hs-var">argK</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#contTyPtr"><span class="hs-identifier hs-var">contTyPtr</span></a></span><span>
</span><span id="line-239"></span><span>                    </span><span id="local-6989586621679263974"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263974"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; ClosurePtr 'DynamicPtr
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkClosurePtr"><span class="hs-identifier hs-var">MkClosurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">(Operand -&gt; ClosurePtr 'DynamicPtr)
-&gt; IRBuilderT m Operand -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Type -&gt; IRBuilderT m Operand
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m, MonadFail m) =&gt;
Text -&gt; Type -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#lookupVar"><span class="hs-identifier hs-var">lookupVar</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263987"><span class="hs-identifier hs-var">argL</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span>                    </span><span class="hs-comment">-- enter the closure pointed to by `a`, giving it a</span><span>
</span><span id="line-242"></span><span>                    </span><span class="hs-comment">-- pointer to another closure `b` as argument</span><span>
</span><span id="line-243"></span><span>                    </span><span class="annot"><span class="annottext">Continuation
-&gt; ClosurePtr 'DynamicPtr
-&gt; ClosurePtr 'DynamicPtr
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *) (f :: PtrKind) (x :: PtrKind).
(MonadFail m, MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Continuation
-&gt; ClosurePtr f -&gt; ClosurePtr x -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Closure.html#compileApply"><span class="hs-identifier hs-var">compileApply</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263977"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263974"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Operand -&gt; ClosurePtr 'DynamicPtr
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkClosurePtr"><span class="hs-identifier hs-var">MkClosurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679263978"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IRBuilderT m (ClosurePtr 'DynamicPtr)
-&gt; (ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()) -&gt; IRBuilderT m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Closure.html#retClosure"><span class="hs-identifier hs-var">retClosure</span></a></span><span>
</span><span id="line-244"></span><span>
</span><span id="line-245"></span><span>        </span><span class="hs-comment">-- compile the body of the left sub-term and instruct the code</span><span>
</span><span id="line-246"></span><span>        </span><span class="hs-comment">-- generator to use `contL` as the continuation</span><span>
</span><span id="line-247"></span><span>        </span><span class="annot"><span class="annottext">Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.html#compileBody"><span class="hs-identifier hs-var">compileBody</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263983"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264000"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-248"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun () -&gt; Bool
</span><a href="Hachi.Compiler.CodeGen.html#isSimpleTerm"><span class="hs-identifier hs-var">isSimpleTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264000"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-249"></span><span>        </span><span id="local-6989586621679263973"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263973"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IRBuilderT m String
forall (m :: * -&gt; *).
(MonadReader CodeGenSt m, MonadIO m) =&gt;
String -&gt; m String
</span><a href="Hachi.Compiler.CodeGen.Monad.html#mkFresh"><span class="hs-identifier hs-var">mkFresh</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;app&quot;</span></span><span>
</span><span id="line-250"></span><span>        </span><span id="local-6989586621679263972"><span class="annot"><span class="annottext">Set (Text, Bool)
</span><a href="#local-6989586621679263972"><span class="hs-identifier hs-var">fvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IRBuilderT m (Set (Text, Bool))
forall (m :: * -&gt; *).
MonadReader CodeGenSt m =&gt;
m (Set (Text, Bool))
</span><a href="Hachi.Compiler.CodeGen.Monad.html#currentFreeVars"><span class="hs-identifier hs-var">currentFreeVars</span></a></span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; [Operand] -&gt; IRBuilderT m ()
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m) =&gt;
String -&gt; [Operand] -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Common.html#compileTrace"><span class="hs-identifier hs-var">compileTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263973"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span>        </span><span class="hs-comment">-- generate some names for the parameters of the continuations, as well</span><span>
</span><span id="line-255"></span><span>        </span><span class="hs-comment">-- as the current continuation that we need to store as a free variable</span><span>
</span><span id="line-256"></span><span>        </span><span class="hs-comment">-- in the continuations</span><span>
</span><span id="line-257"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263971"><span class="annot"><span class="annottext">argK :: Text
</span><a href="#local-6989586621679263971"><span class="hs-identifier hs-var hs-var">argK</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263973"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_k&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263970"><span class="annot"><span class="annottext">argL :: Text
</span><a href="#local-6989586621679263970"><span class="hs-identifier hs-var hs-var">argL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263973"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_arg_l&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span>        </span><span class="hs-comment">-- calculate the sets of free variables of the two continuations</span><span>
</span><span id="line-261"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263969"><span class="annot"><span class="annottext">fvsL :: Set (Text, Bool)
</span><a href="#local-6989586621679263969"><span class="hs-identifier hs-var hs-var">fvsL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; (Text, Bool)) -&gt; Set Name -&gt; Set (Text, Bool)
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; (Text, Bool)
</span><a href="Hachi.Compiler.CodeGen.html#mkClosureVar"><span class="hs-identifier hs-var">mkClosureVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set Name -&gt; Set Name -&gt; Set Name
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.union</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun () -&gt; Set Name
forall name (uni :: * -&gt; *) fun ann.
Ord name =&gt;
Term name uni fun ann -&gt; Set name
</span><a href="Hachi.Compiler.FreeVars.html#freeVars"><span class="hs-identifier hs-var">freeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264001"><span class="hs-identifier hs-var">lhs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun () -&gt; Set Name
forall name (uni :: * -&gt; *) fun ann.
Ord name =&gt;
Term name uni fun ann -&gt; Set name
</span><a href="Hachi.Compiler.FreeVars.html#freeVars"><span class="hs-identifier hs-var">freeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264000"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>                </span><span class="annot"><span class="annottext">Set (Text, Bool) -&gt; Set (Text, Bool) -&gt; Set (Text, Bool)
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">`S.union`</span></span><span> </span><span class="annot"><span class="annottext">(Text, Bool) -&gt; Set (Text, Bool)
forall a. a -&gt; Set a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263971"><span class="hs-identifier hs-var">argK</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span>        </span><span class="hs-comment">-- generate code for the first continuation</span><span>
</span><span id="line-265"></span><span>        </span><span id="local-6989586621679263968"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263968"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-266"></span><span>            </span><span class="annot"><span class="annottext">Text
-&gt; Local -&gt; IRBuilderT m Continuation -&gt; IRBuilderT m Continuation
forall (m :: * -&gt; *) a.
MonadReader CodeGenSt m =&gt;
Text -&gt; Local -&gt; m a -&gt; m a
</span><a href="Hachi.Compiler.CodeGen.Monad.html#extendScope"><span class="hs-identifier hs-var">extendScope</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263971"><span class="hs-identifier hs-var">argK</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Continuation -&gt; Local
</span><a href="Hachi.Compiler.CodeGen.Types.html#LocalCont"><span class="hs-identifier hs-var">LocalCont</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679264003"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IRBuilderT m Continuation -&gt; IRBuilderT m Continuation)
-&gt; IRBuilderT m Continuation -&gt; IRBuilderT m Continuation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-267"></span><span>            </span><span class="annot"><span class="annottext">String
-&gt; Set (Text, Bool)
-&gt; Text
-&gt; (Operand -&gt; Operand -&gt; IRBuilderT m ())
-&gt; IRBuilderT m Continuation
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
String
-&gt; Set (Text, Bool)
-&gt; Text
-&gt; (Operand -&gt; Operand -&gt; IRBuilderT m ())
-&gt; IRBuilderT m Continuation
</span><a href="Hachi.Compiler.CodeGen.CPS.html#compileDynamicCont"><span class="hs-identifier hs-var">compileDynamicCont</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263973"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_cont&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set (Text, Bool)
</span><a href="#local-6989586621679263969"><span class="hs-identifier hs-var">fvsL</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263970"><span class="hs-identifier hs-var">argL</span></a></span><span> </span><span class="annot"><span class="annottext">((Operand -&gt; Operand -&gt; IRBuilderT m ())
 -&gt; IRBuilderT m Continuation)
-&gt; (Operand -&gt; Operand -&gt; IRBuilderT m ())
-&gt; IRBuilderT m Continuation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-268"></span><span>            </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679263967"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679263967"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-269"></span><span>                </span><span class="hs-comment">-- retrieve the initial continuation and the result of</span><span>
</span><span id="line-270"></span><span>                </span><span class="hs-comment">-- evaluating the LHS from the current continuation</span><span>
</span><span id="line-271"></span><span>                </span><span class="hs-comment">-- closure</span><span>
</span><span id="line-272"></span><span>                </span><span id="local-6989586621679263966"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263966"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; Continuation
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkCont"><span class="hs-identifier hs-var">MkCont</span></a></span><span> </span><span class="annot"><span class="annottext">(Operand -&gt; Continuation)
-&gt; IRBuilderT m Operand -&gt; IRBuilderT m Continuation
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Type -&gt; IRBuilderT m Operand
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m, MonadFail m) =&gt;
Text -&gt; Type -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#lookupVar"><span class="hs-identifier hs-var">lookupVar</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263971"><span class="hs-identifier hs-var">argK</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#contTyPtr"><span class="hs-identifier hs-var">contTyPtr</span></a></span><span>
</span><span id="line-273"></span><span>
</span><span id="line-274"></span><span>                </span><span class="annot"><span class="annottext">String -&gt; [Operand] -&gt; IRBuilderT m ()
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m) =&gt;
String -&gt; [Operand] -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Common.html#compileTrace"><span class="hs-identifier hs-var">compileTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Entering closure in &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263973"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span>                </span><span class="hs-comment">-- compile the body of the right sub-term and instruct the</span><span>
</span><span id="line-277"></span><span>                </span><span class="hs-comment">-- code generator to use `contR` as the continuation</span><span>
</span><span id="line-278"></span><span>                </span><span id="local-6989586621679263965"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263965"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.html#compileNonCPS"><span class="hs-identifier hs-var">compileNonCPS</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264000"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span>                </span><span class="hs-comment">-- enter the closure pointed to by `a`, giving it a</span><span>
</span><span id="line-281"></span><span>                </span><span class="hs-comment">-- pointer to another closure `b` as argument</span><span>
</span><span id="line-282"></span><span>                </span><span class="annot"><span class="annottext">Continuation
-&gt; ClosurePtr 'DynamicPtr
-&gt; ClosurePtr 'DynamicPtr
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *) (f :: PtrKind) (x :: PtrKind).
(MonadFail m, MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Continuation
-&gt; ClosurePtr f -&gt; ClosurePtr x -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Closure.html#compileApply"><span class="hs-identifier hs-var">compileApply</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263966"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Operand -&gt; ClosurePtr 'DynamicPtr
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkClosurePtr"><span class="hs-identifier hs-var">MkClosurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679263967"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263965"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">IRBuilderT m (ClosurePtr 'DynamicPtr)
-&gt; (ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()) -&gt; IRBuilderT m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Closure.html#retClosure"><span class="hs-identifier hs-var">retClosure</span></a></span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span>        </span><span class="hs-comment">-- compile the body of the left sub-term and instruct the code</span><span>
</span><span id="line-285"></span><span>        </span><span class="hs-comment">-- generator to use `contL` as the continuation</span><span>
</span><span id="line-286"></span><span>        </span><span class="annot"><span class="annottext">Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.html#compileBody"><span class="hs-identifier hs-var">compileBody</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263968"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264001"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-287"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-288"></span><span>        </span><span class="hs-comment">-- if the operands of the function application are not &quot;simple&quot;, then</span><span>
</span><span id="line-289"></span><span>        </span><span class="hs-comment">-- we essentially need to perform some lambda-lifting; consider the</span><span>
</span><span id="line-290"></span><span>        </span><span class="hs-comment">-- following PLC program:</span><span>
</span><span id="line-291"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-292"></span><span>        </span><span class="hs-comment">-- [[f x] [g y]]</span><span>
</span><span id="line-293"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-294"></span><span>        </span><span class="hs-comment">-- Compiling [f x] will result in at least one function call and</span><span>
</span><span id="line-295"></span><span>        </span><span class="hs-comment">-- compiling [g y] will result in at least one function call; while</span><span>
</span><span id="line-296"></span><span>        </span><span class="hs-comment">-- we also need to perform a function call for the outer application.</span><span>
</span><span id="line-297"></span><span>        </span><span class="hs-comment">-- Therefore, we need to break this up into essentially the following</span><span>
</span><span id="line-298"></span><span>        </span><span class="hs-comment">-- program (with explicit continuations, using Haskell notation):</span><span>
</span><span id="line-299"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-300"></span><span>        </span><span class="hs-comment">-- \k f g x y -&gt; let _cont_l a = let _cont_r b = a k b</span><span>
</span><span id="line-301"></span><span>        </span><span class="hs-comment">--                               in g _cont_r y</span><span>
</span><span id="line-302"></span><span>        </span><span class="hs-comment">--               in f _cont_l x</span><span>
</span><span id="line-303"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-304"></span><span>        </span><span class="hs-comment">-- which is equivalent to</span><span>
</span><span id="line-305"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-306"></span><span>        </span><span class="hs-comment">-- \k f g x y -&gt; f (\a -&gt; g (\b -&gt; a k b) y) x</span><span>
</span><span id="line-307"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-308"></span><span>        </span><span class="hs-comment">-- In particular, note that `k` is free in both of the continuations</span><span>
</span><span id="line-309"></span><span>        </span><span class="hs-comment">-- and that `a` is free in the second continuation.</span><span>
</span><span id="line-310"></span><span>        </span><span id="local-6989586621679263964"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263964"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IRBuilderT m String
forall (m :: * -&gt; *).
(MonadReader CodeGenSt m, MonadIO m) =&gt;
String -&gt; m String
</span><a href="Hachi.Compiler.CodeGen.Monad.html#mkFresh"><span class="hs-identifier hs-var">mkFresh</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;app&quot;</span></span><span>
</span><span id="line-311"></span><span>        </span><span id="local-6989586621679263963"><span class="annot"><span class="annottext">Set (Text, Bool)
</span><a href="#local-6989586621679263963"><span class="hs-identifier hs-var">fvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IRBuilderT m (Set (Text, Bool))
forall (m :: * -&gt; *).
MonadReader CodeGenSt m =&gt;
m (Set (Text, Bool))
</span><a href="Hachi.Compiler.CodeGen.Monad.html#currentFreeVars"><span class="hs-identifier hs-var">currentFreeVars</span></a></span><span>
</span><span id="line-312"></span><span>
</span><span id="line-313"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; [Operand] -&gt; IRBuilderT m ()
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m) =&gt;
String -&gt; [Operand] -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Common.html#compileTrace"><span class="hs-identifier hs-var">compileTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263964"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-314"></span><span>
</span><span id="line-315"></span><span>        </span><span class="hs-comment">-- generate some names for the parameters of the continuations, as well</span><span>
</span><span id="line-316"></span><span>        </span><span class="hs-comment">-- as the current continuation that we need to store as a free variable</span><span>
</span><span id="line-317"></span><span>        </span><span class="hs-comment">-- in the continuations</span><span>
</span><span id="line-318"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263962"><span class="annot"><span class="annottext">argK :: Text
</span><a href="#local-6989586621679263962"><span class="hs-identifier hs-var hs-var">argK</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263964"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_k&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263961"><span class="annot"><span class="annottext">argR :: Text
</span><a href="#local-6989586621679263961"><span class="hs-identifier hs-var hs-var">argR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263964"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_arg_r&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263960"><span class="annot"><span class="annottext">argL :: Text
</span><a href="#local-6989586621679263960"><span class="hs-identifier hs-var hs-var">argL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263964"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_arg_l&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-321"></span><span>
</span><span id="line-322"></span><span>        </span><span class="hs-comment">-- calculate the sets of free variables of the two continuations</span><span>
</span><span id="line-323"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263959"><span class="annot"><span class="annottext">fvsR :: Set (Text, Bool)
</span><a href="#local-6989586621679263959"><span class="hs-identifier hs-var hs-var">fvsR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; (Text, Bool)) -&gt; Set Name -&gt; Set (Text, Bool)
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; (Text, Bool)
</span><a href="Hachi.Compiler.CodeGen.html#mkClosureVar"><span class="hs-identifier hs-var">mkClosureVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun () -&gt; Set Name
forall name (uni :: * -&gt; *) fun ann.
Ord name =&gt;
Term name uni fun ann -&gt; Set name
</span><a href="Hachi.Compiler.FreeVars.html#freeVars"><span class="hs-identifier hs-var">freeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264000"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span>                </span><span class="annot"><span class="annottext">Set (Text, Bool) -&gt; Set (Text, Bool) -&gt; Set (Text, Bool)
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">`S.union`</span></span><span> </span><span class="annot"><span class="annottext">(Text, Bool) -&gt; Set (Text, Bool)
forall a. a -&gt; Set a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263960"><span class="hs-identifier hs-var">argL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span>                </span><span class="annot"><span class="annottext">Set (Text, Bool) -&gt; Set (Text, Bool) -&gt; Set (Text, Bool)
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">`S.union`</span></span><span> </span><span class="annot"><span class="annottext">(Text, Bool) -&gt; Set (Text, Bool)
forall a. a -&gt; Set a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263962"><span class="hs-identifier hs-var">argK</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-326"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263958"><span class="annot"><span class="annottext">fvsL :: Set (Text, Bool)
</span><a href="#local-6989586621679263958"><span class="hs-identifier hs-var hs-var">fvsL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; (Text, Bool)) -&gt; Set Name -&gt; Set (Text, Bool)
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; (Text, Bool)
</span><a href="Hachi.Compiler.CodeGen.html#mkClosureVar"><span class="hs-identifier hs-var">mkClosureVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set Name -&gt; Set Name -&gt; Set Name
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.union</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun () -&gt; Set Name
forall name (uni :: * -&gt; *) fun ann.
Ord name =&gt;
Term name uni fun ann -&gt; Set name
</span><a href="Hachi.Compiler.FreeVars.html#freeVars"><span class="hs-identifier hs-var">freeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264001"><span class="hs-identifier hs-var">lhs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun () -&gt; Set Name
forall name (uni :: * -&gt; *) fun ann.
Ord name =&gt;
Term name uni fun ann -&gt; Set name
</span><a href="Hachi.Compiler.FreeVars.html#freeVars"><span class="hs-identifier hs-var">freeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264000"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-327"></span><span>                </span><span class="annot"><span class="annottext">Set (Text, Bool) -&gt; Set (Text, Bool) -&gt; Set (Text, Bool)
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">`S.union`</span></span><span> </span><span class="annot"><span class="annottext">(Text, Bool) -&gt; Set (Text, Bool)
forall a. a -&gt; Set a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263962"><span class="hs-identifier hs-var">argK</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span>        </span><span class="hs-comment">-- generate code for the first continuation</span><span>
</span><span id="line-330"></span><span>        </span><span id="local-6989586621679263957"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263957"><span class="hs-identifier hs-var">contL</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-331"></span><span>            </span><span class="annot"><span class="annottext">Text
-&gt; Local -&gt; IRBuilderT m Continuation -&gt; IRBuilderT m Continuation
forall (m :: * -&gt; *) a.
MonadReader CodeGenSt m =&gt;
Text -&gt; Local -&gt; m a -&gt; m a
</span><a href="Hachi.Compiler.CodeGen.Monad.html#extendScope"><span class="hs-identifier hs-var">extendScope</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263962"><span class="hs-identifier hs-var">argK</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Continuation -&gt; Local
</span><a href="Hachi.Compiler.CodeGen.Types.html#LocalCont"><span class="hs-identifier hs-var">LocalCont</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679264003"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IRBuilderT m Continuation -&gt; IRBuilderT m Continuation)
-&gt; IRBuilderT m Continuation -&gt; IRBuilderT m Continuation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-332"></span><span>            </span><span class="annot"><span class="annottext">String
-&gt; Set (Text, Bool)
-&gt; Text
-&gt; (Operand -&gt; Operand -&gt; IRBuilderT m ())
-&gt; IRBuilderT m Continuation
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
String
-&gt; Set (Text, Bool)
-&gt; Text
-&gt; (Operand -&gt; Operand -&gt; IRBuilderT m ())
-&gt; IRBuilderT m Continuation
</span><a href="Hachi.Compiler.CodeGen.CPS.html#compileDynamicCont"><span class="hs-identifier hs-var">compileDynamicCont</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263964"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_cont_l&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set (Text, Bool)
</span><a href="#local-6989586621679263958"><span class="hs-identifier hs-var">fvsL</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263960"><span class="hs-identifier hs-var">argL</span></a></span><span> </span><span class="annot"><span class="annottext">((Operand -&gt; Operand -&gt; IRBuilderT m ())
 -&gt; IRBuilderT m Continuation)
-&gt; (Operand -&gt; Operand -&gt; IRBuilderT m ())
-&gt; IRBuilderT m Continuation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-333"></span><span>            </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-334"></span><span>                </span><span class="hs-comment">-- generate code for the second continuation; we need to do</span><span>
</span><span id="line-335"></span><span>                </span><span class="hs-comment">-- this inside of the first continuation since we wish to</span><span>
</span><span id="line-336"></span><span>                </span><span class="hs-comment">-- capture its argument as a free variable</span><span>
</span><span id="line-337"></span><span>                </span><span id="local-6989586621679263956"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263956"><span class="hs-identifier hs-var">contR</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Set (Text, Bool)
-&gt; Text
-&gt; (Operand -&gt; Operand -&gt; IRBuilderT m ())
-&gt; IRBuilderT m Continuation
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
String
-&gt; Set (Text, Bool)
-&gt; Text
-&gt; (Operand -&gt; Operand -&gt; IRBuilderT m ())
-&gt; IRBuilderT m Continuation
</span><a href="Hachi.Compiler.CodeGen.CPS.html#compileDynamicCont"><span class="hs-identifier hs-var">compileDynamicCont</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263964"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_cont_r&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set (Text, Bool)
</span><a href="#local-6989586621679263959"><span class="hs-identifier hs-var">fvsR</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263961"><span class="hs-identifier hs-var">argR</span></a></span><span> </span><span class="annot"><span class="annottext">((Operand -&gt; Operand -&gt; IRBuilderT m ())
 -&gt; IRBuilderT m Continuation)
-&gt; (Operand -&gt; Operand -&gt; IRBuilderT m ())
-&gt; IRBuilderT m Continuation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-338"></span><span>                    </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679263955"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679263955"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-339"></span><span>                        </span><span class="annot"><span class="annottext">String -&gt; [Operand] -&gt; IRBuilderT m ()
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m) =&gt;
String -&gt; [Operand] -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Common.html#compileTrace"><span class="hs-identifier hs-var">compileTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Entering closure in &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263964"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span>                        </span><span class="hs-comment">-- retrieve the initial continuation and the result of</span><span>
</span><span id="line-342"></span><span>                        </span><span class="hs-comment">-- evaluating the LHS from the current continuation</span><span>
</span><span id="line-343"></span><span>                        </span><span class="hs-comment">-- closure</span><span>
</span><span id="line-344"></span><span>                        </span><span id="local-6989586621679263954"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263954"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; Continuation
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkCont"><span class="hs-identifier hs-var">MkCont</span></a></span><span> </span><span class="annot"><span class="annottext">(Operand -&gt; Continuation)
-&gt; IRBuilderT m Operand -&gt; IRBuilderT m Continuation
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Type -&gt; IRBuilderT m Operand
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m, MonadFail m) =&gt;
Text -&gt; Type -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#lookupVar"><span class="hs-identifier hs-var">lookupVar</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263962"><span class="hs-identifier hs-var">argK</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#contTyPtr"><span class="hs-identifier hs-var">contTyPtr</span></a></span><span>
</span><span id="line-345"></span><span>                        </span><span id="local-6989586621679263953"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263953"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; ClosurePtr 'DynamicPtr
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkClosurePtr"><span class="hs-identifier hs-var">MkClosurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">(Operand -&gt; ClosurePtr 'DynamicPtr)
-&gt; IRBuilderT m Operand -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Type -&gt; IRBuilderT m Operand
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m, MonadFail m) =&gt;
Text -&gt; Type -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#lookupVar"><span class="hs-identifier hs-var">lookupVar</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263960"><span class="hs-identifier hs-var">argL</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span>
</span><span id="line-346"></span><span>
</span><span id="line-347"></span><span>                        </span><span class="hs-comment">-- enter the closure pointed to by `a`, giving it a</span><span>
</span><span id="line-348"></span><span>                        </span><span class="hs-comment">-- pointer to another closure `b` as argument</span><span>
</span><span id="line-349"></span><span>                        </span><span class="annot"><span class="annottext">Continuation
-&gt; ClosurePtr 'DynamicPtr
-&gt; ClosurePtr 'DynamicPtr
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *) (f :: PtrKind) (x :: PtrKind).
(MonadFail m, MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Continuation
-&gt; ClosurePtr f -&gt; ClosurePtr x -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Closure.html#compileApply"><span class="hs-identifier hs-var">compileApply</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263954"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263953"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Operand -&gt; ClosurePtr 'DynamicPtr
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkClosurePtr"><span class="hs-identifier hs-var">MkClosurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679263955"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IRBuilderT m (ClosurePtr 'DynamicPtr)
-&gt; (ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()) -&gt; IRBuilderT m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Closure.html#retClosure"><span class="hs-identifier hs-var">retClosure</span></a></span><span>
</span><span id="line-350"></span><span>
</span><span id="line-351"></span><span>                </span><span class="hs-comment">-- compile the body of the right sub-term and instruct the</span><span>
</span><span id="line-352"></span><span>                </span><span class="hs-comment">-- code generator to use `contR` as the continuation</span><span>
</span><span id="line-353"></span><span>                </span><span id="local-6989586621679263952"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263952"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.html#compileBody"><span class="hs-identifier hs-var">compileBody</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263956"><span class="hs-identifier hs-var">contR</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264000"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-354"></span><span>                </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Closure.html#retClosure"><span class="hs-identifier hs-var">retClosure</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263952"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span>        </span><span class="hs-comment">-- compile the body of the left sub-term and instruct the code</span><span>
</span><span id="line-357"></span><span>        </span><span class="hs-comment">-- generator to use `contL` as the continuation</span><span>
</span><span id="line-358"></span><span>        </span><span class="annot"><span class="annottext">Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.html#compileBody"><span class="hs-identifier hs-var">compileBody</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263957"><span class="hs-identifier hs-var">contL</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679264001"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-359"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.html#compileBody"><span class="hs-identifier hs-var">compileBody</span></a></span><span> </span><span id="local-6989586621679263951"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263951"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Force</span></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679263949"><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679263949"><span class="hs-identifier hs-var">term</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span>    </span><span class="hs-comment">-- similarly to applications, we can generate simpler code if `term`</span><span>
</span><span id="line-361"></span><span>    </span><span class="hs-comment">-- is &quot;simple&quot;</span><span>
</span><span id="line-362"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun () -&gt; Bool
</span><a href="Hachi.Compiler.CodeGen.html#isSimpleTerm"><span class="hs-identifier hs-var">isSimpleTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679263949"><span class="hs-identifier hs-var">term</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-363"></span><span>        </span><span id="local-6989586621679263948"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263948"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IRBuilderT m String
forall (m :: * -&gt; *).
(MonadReader CodeGenSt m, MonadIO m) =&gt;
String -&gt; m String
</span><a href="Hachi.Compiler.CodeGen.Monad.html#mkFresh"><span class="hs-identifier hs-var">mkFresh</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;force&quot;</span></span><span>
</span><span id="line-364"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; [Operand] -&gt; IRBuilderT m ()
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m) =&gt;
String -&gt; [Operand] -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Common.html#compileTrace"><span class="hs-identifier hs-var">compileTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263948"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-365"></span><span>
</span><span id="line-366"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263947"><span class="annot"><span class="annottext">contBr :: Name
</span><a href="#local-6989586621679263947"><span class="hs-identifier hs-var hs-var">contBr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">mkName</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Name) -&gt; String -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263948"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_cont&quot;</span></span><span>
</span><span id="line-367"></span><span>
</span><span id="line-368"></span><span>        </span><span class="hs-comment">-- compile `term`, which we know won't result in any function</span><span>
</span><span id="line-369"></span><span>        </span><span class="hs-comment">-- calls since the check for `isSimpleTerm` passed; if force is</span><span>
</span><span id="line-370"></span><span>        </span><span class="hs-comment">-- successful (i.e. applied to a delay term), then we jump to</span><span>
</span><span id="line-371"></span><span>        </span><span class="hs-comment">-- the `contBr` label, whcih skips past the error branch</span><span>
</span><span id="line-372"></span><span>        </span><span id="local-6989586621679263946"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263946"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.html#compileNonCPS"><span class="hs-identifier hs-var">compileNonCPS</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679263949"><span class="hs-identifier hs-var">term</span></a></span><span>
</span><span id="line-373"></span><span>        </span><span id="local-6989586621679263945"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263945"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Continuation
-&gt; Operand
-&gt; (ClosurePtr 'DynamicPtr
    -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr))
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *) a.
(MonadCodeGen m, MonadIRBuilder m) =&gt;
String
-&gt; Continuation
-&gt; Operand
-&gt; (ClosurePtr 'DynamicPtr -&gt; m a)
-&gt; m a
</span><a href="Hachi.Compiler.CodeGen.html#compileForce"><span class="hs-identifier hs-var">compileForce</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263948"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263951"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; Operand
forall (k :: PtrKind) to. FromClosurePtr k to =&gt; ClosurePtr k -&gt; to
</span><a href="Hachi.Compiler.CodeGen.Types.html#closurePtr"><span class="hs-identifier hs-var">closurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263946"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((ClosurePtr 'DynamicPtr -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr))
 -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr))
-&gt; (ClosurePtr 'DynamicPtr
    -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr))
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679263943"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263943"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-374"></span><span>            </span><span class="annot"><span class="annottext">Name -&gt; IRBuilderT m ()
forall (m :: * -&gt; *). MonadIRBuilder m =&gt; Name -&gt; m ()
</span><span class="hs-identifier hs-var">br</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679263947"><span class="hs-identifier hs-var">contBr</span></a></span><span>
</span><span id="line-375"></span><span>            </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263943"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-376"></span><span>
</span><span id="line-377"></span><span>        </span><span class="annot"><span class="annottext">Name -&gt; IRBuilderT m ()
forall (m :: * -&gt; *). MonadIRBuilder m =&gt; Name -&gt; m ()
</span><span class="hs-identifier hs-var">emitBlockStart</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679263947"><span class="hs-identifier hs-var">contBr</span></a></span><span>
</span><span id="line-378"></span><span>        </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263945"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-379"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-380"></span><span>        </span><span id="local-6989586621679263941"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263941"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IRBuilderT m String
forall (m :: * -&gt; *).
(MonadReader CodeGenSt m, MonadIO m) =&gt;
String -&gt; m String
</span><a href="Hachi.Compiler.CodeGen.Monad.html#mkFresh"><span class="hs-identifier hs-var">mkFresh</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;force&quot;</span></span><span>
</span><span id="line-381"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; [Operand] -&gt; IRBuilderT m ()
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m) =&gt;
String -&gt; [Operand] -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Common.html#compileTrace"><span class="hs-identifier hs-var">compileTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263941"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-382"></span><span>
</span><span id="line-383"></span><span>        </span><span class="hs-comment">-- a `Force` term is similar to a function application, except that the</span><span>
</span><span id="line-384"></span><span>        </span><span class="hs-comment">-- function argument is meaningless and not used. Since `term` may be</span><span>
</span><span id="line-385"></span><span>        </span><span class="hs-comment">-- a function application itself</span><span>
</span><span id="line-386"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263940"><span class="annot"><span class="annottext">argK :: Text
</span><a href="#local-6989586621679263940"><span class="hs-identifier hs-var hs-var">argK</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263941"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_k&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-387"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263939"><span class="annot"><span class="annottext">arg :: Text
</span><a href="#local-6989586621679263939"><span class="hs-identifier hs-var hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263941"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_arg&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>
</span><span id="line-389"></span><span>        </span><span class="hs-comment">-- calculate the set of free variables of the continuation</span><span>
</span><span id="line-390"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263938"><span class="annot"><span class="annottext">fvs :: Set (Text, Bool)
</span><a href="#local-6989586621679263938"><span class="hs-identifier hs-var hs-var">fvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; (Text, Bool)) -&gt; Set Name -&gt; Set (Text, Bool)
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; (Text, Bool)
</span><a href="Hachi.Compiler.CodeGen.html#mkClosureVar"><span class="hs-identifier hs-var">mkClosureVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun () -&gt; Set Name
forall name (uni :: * -&gt; *) fun ann.
Ord name =&gt;
Term name uni fun ann -&gt; Set name
</span><a href="Hachi.Compiler.FreeVars.html#freeVars"><span class="hs-identifier hs-var">freeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679263949"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-391"></span><span>                </span><span class="annot"><span class="annottext">Set (Text, Bool) -&gt; Set (Text, Bool) -&gt; Set (Text, Bool)
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">`S.union`</span></span><span> </span><span class="annot"><span class="annottext">(Text, Bool) -&gt; Set (Text, Bool)
forall a. a -&gt; Set a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263940"><span class="hs-identifier hs-var">argK</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-392"></span><span>
</span><span id="line-393"></span><span>        </span><span id="local-6989586621679263937"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263937"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-394"></span><span>            </span><span class="annot"><span class="annottext">Text
-&gt; Local -&gt; IRBuilderT m Continuation -&gt; IRBuilderT m Continuation
forall (m :: * -&gt; *) a.
MonadReader CodeGenSt m =&gt;
Text -&gt; Local -&gt; m a -&gt; m a
</span><a href="Hachi.Compiler.CodeGen.Monad.html#extendScope"><span class="hs-identifier hs-var">extendScope</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263940"><span class="hs-identifier hs-var">argK</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Continuation -&gt; Local
</span><a href="Hachi.Compiler.CodeGen.Types.html#LocalCont"><span class="hs-identifier hs-var">LocalCont</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263951"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IRBuilderT m Continuation -&gt; IRBuilderT m Continuation)
-&gt; IRBuilderT m Continuation -&gt; IRBuilderT m Continuation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-395"></span><span>            </span><span class="annot"><span class="annottext">String
-&gt; Set (Text, Bool)
-&gt; Text
-&gt; (Operand -&gt; Operand -&gt; IRBuilderT m ())
-&gt; IRBuilderT m Continuation
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
String
-&gt; Set (Text, Bool)
-&gt; Text
-&gt; (Operand -&gt; Operand -&gt; IRBuilderT m ())
-&gt; IRBuilderT m Continuation
</span><a href="Hachi.Compiler.CodeGen.CPS.html#compileDynamicCont"><span class="hs-identifier hs-var">compileDynamicCont</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263941"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_cont&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set (Text, Bool)
</span><a href="#local-6989586621679263938"><span class="hs-identifier hs-var">fvs</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263939"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">((Operand -&gt; Operand -&gt; IRBuilderT m ())
 -&gt; IRBuilderT m Continuation)
-&gt; (Operand -&gt; Operand -&gt; IRBuilderT m ())
-&gt; IRBuilderT m Continuation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-396"></span><span>            </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679263936"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679263936"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-397"></span><span>                </span><span id="local-6989586621679263935"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263935"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; Continuation
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkCont"><span class="hs-identifier hs-var">MkCont</span></a></span><span> </span><span class="annot"><span class="annottext">(Operand -&gt; Continuation)
-&gt; IRBuilderT m Operand -&gt; IRBuilderT m Continuation
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Type -&gt; IRBuilderT m Operand
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m, MonadFail m) =&gt;
Text -&gt; Type -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#lookupVar"><span class="hs-identifier hs-var">lookupVar</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679263940"><span class="hs-identifier hs-var">argK</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#contTyPtr"><span class="hs-identifier hs-var">contTyPtr</span></a></span><span>
</span><span id="line-398"></span><span>                </span><span class="annot"><span class="annottext">String
-&gt; Continuation
-&gt; Operand
-&gt; (ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ())
-&gt; IRBuilderT m ()
forall (m :: * -&gt; *) a.
(MonadCodeGen m, MonadIRBuilder m) =&gt;
String
-&gt; Continuation
-&gt; Operand
-&gt; (ClosurePtr 'DynamicPtr -&gt; m a)
-&gt; m a
</span><a href="Hachi.Compiler.CodeGen.html#compileForce"><span class="hs-identifier hs-var">compileForce</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263941"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263935"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679263936"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Closure.html#retClosure"><span class="hs-identifier hs-var">retClosure</span></a></span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span>        </span><span class="hs-comment">-- Generate code for the term, this can be an arbitrary term and may</span><span>
</span><span id="line-401"></span><span>        </span><span class="hs-comment">-- not immediately be a delay term - indeed, there may not be a delay</span><span>
</span><span id="line-402"></span><span>        </span><span class="hs-comment">-- term at all!</span><span>
</span><span id="line-403"></span><span>        </span><span class="annot"><span class="annottext">Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.html#compileBody"><span class="hs-identifier hs-var">compileBody</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263937"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679263949"><span class="hs-identifier hs-var">term</span></a></span><span>
</span><span id="line-404"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.html#compileBody"><span class="hs-identifier hs-var">compileBody</span></a></span><span> </span><span id="local-6989586621679263934"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263934"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679263933"><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679263933"><span class="hs-identifier hs-var">simpleTerm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.html#compileNonCPS"><span class="hs-identifier hs-var">compileNonCPS</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679263933"><span class="hs-identifier hs-var">simpleTerm</span></a></span><span> </span><span class="annot"><span class="annottext">IRBuilderT m (ClosurePtr 'DynamicPtr)
-&gt; (ClosurePtr 'DynamicPtr
    -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr))
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Continuation
-&gt; ClosurePtr 'DynamicPtr -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall a (m :: * -&gt; *).
(ContinuationRep a, MonadCodeGen m, MonadIRBuilder m) =&gt;
Continuation -&gt; a -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.CPS.html#callCont"><span class="hs-identifier hs-var">callCont</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263934"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-405"></span><span>
</span><span id="line-406"></span><span class="hs-comment">-- | `commonEntry` @term@ generates common entry code that is the same for</span><span>
</span><span id="line-407"></span><span class="hs-comment">-- both executables and libraries.</span><span>
</span><span id="line-408"></span><span id="local-6989586621679263931"><span class="annot"><a href="Hachi.Compiler.CodeGen.html#commonEntry"><span class="hs-identifier hs-type">commonEntry</span></a></span><span>
</span><span id="line-409"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#MonadCodeGen"><span class="hs-identifier hs-type">MonadCodeGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679263931"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-410"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#Continuation"><span class="hs-identifier hs-type">Continuation</span></a></span><span>
</span><span id="line-411"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">UPLC.Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefaultUni</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefaultFun</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-412"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IRBuilderT</span></span><span> </span><span class="annot"><a href="#local-6989586621679263931"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#DynamicPtr"><span class="hs-identifier hs-type">DynamicPtr</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-413"></span><span id="commonEntry"><span class="annot"><span class="annottext">commonEntry :: Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.html#commonEntry"><span class="hs-identifier hs-var hs-var">commonEntry</span></a></span></span><span> </span><span id="local-6989586621679263929"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263929"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679263928"><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679263928"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-414"></span><span>    </span><span class="annot"><span class="annottext">IRBuilderT m ()
forall (m :: * -&gt; *). (MonadCodeGen m, MonadFail m) =&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Globals.html#generateConstantGlobals"><span class="hs-identifier hs-var">generateConstantGlobals</span></a></span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span>    </span><span class="hs-comment">-- initialise the runtime system</span><span>
</span><span id="line-417"></span><span>    </span><span class="annot"><span class="annottext">IRBuilderT m ()
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
m ()
</span><a href="Hachi.Compiler.CodeGen.Externals.html#rtsInit"><span class="hs-identifier hs-var">rtsInit</span></a></span><span>
</span><span id="line-418"></span><span>
</span><span id="line-419"></span><span>    </span><span class="hs-comment">-- generate code for all the built-in functions: it is easier for us to</span><span>
</span><span id="line-420"></span><span>    </span><span class="hs-comment">-- do this programmatically rather than in e.g. C since the functions</span><span>
</span><span id="line-421"></span><span>    </span><span class="hs-comment">-- all need to be curried; however, it may be nice to only compile the</span><span>
</span><span id="line-422"></span><span>    </span><span class="hs-comment">-- builtins we actually need for the current program in the future</span><span>
</span><span id="line-423"></span><span>    </span><span id="local-6989586621679263925"><span class="annot"><span class="annottext">Map DefaultFun (ClosurePtr 'StaticPtr)
</span><a href="#local-6989586621679263925"><span class="hs-identifier hs-var">builtins</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IRBuilderT m (Map DefaultFun (ClosurePtr 'StaticPtr))
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
m (Map DefaultFun (ClosurePtr 'StaticPtr))
</span><a href="Hachi.Compiler.CodeGen.Builtin.html#compileBuiltins"><span class="hs-identifier hs-var">compileBuiltins</span></a></span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span>    </span><span class="hs-comment">-- compile the program; the resulting Operand represent a pointer to some</span><span>
</span><span id="line-426"></span><span>    </span><span class="hs-comment">-- kind of closure (function or constant)</span><span>
</span><span id="line-427"></span><span>    </span><span class="annot"><span class="annottext">(CodeGenSt -&gt; CodeGenSt)
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679263922"><span class="annot"><span class="annottext">CodeGenSt
</span><a href="#local-6989586621679263922"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CodeGenSt
</span><a href="#local-6989586621679263922"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">codeGenBuiltins :: Map DefaultFun (ClosurePtr 'StaticPtr)
</span><a href="Hachi.Compiler.CodeGen.Monad.html#codeGenBuiltins"><span class="hs-identifier hs-var">codeGenBuiltins</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map DefaultFun (ClosurePtr 'StaticPtr)
</span><a href="#local-6989586621679263925"><span class="hs-identifier hs-var">builtins</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IRBuilderT m (ClosurePtr 'DynamicPtr)
 -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr))
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.html#compileBody"><span class="hs-identifier hs-var">compileBody</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263929"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679263928"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-428"></span><span>
</span><span id="line-429"></span><span class="hs-comment">-- | `generateEntry` @term@ generates code for @term@ surrounded by a small</span><span>
</span><span id="line-430"></span><span class="hs-comment">-- wrapper which calls the print function of the closure that results from</span><span>
</span><span id="line-431"></span><span class="hs-comment">-- executing the program generated from @term@.</span><span>
</span><span id="line-432"></span><span id="local-6989586621679264097"><span class="annot"><a href="Hachi.Compiler.CodeGen.html#generateEntry"><span class="hs-identifier hs-type">generateEntry</span></a></span><span>
</span><span id="line-433"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#MonadCodeGen"><span class="hs-identifier hs-type">MonadCodeGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264097"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-434"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span>
</span><span id="line-435"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">UPLC.Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefaultUni</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefaultFun</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679264097"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-436"></span><span id="generateEntry"><span class="annot"><span class="annottext">generateEntry :: String -&gt; Term Name DefaultUni DefaultFun () -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.html#generateEntry"><span class="hs-identifier hs-var hs-var">generateEntry</span></a></span></span><span> </span><span id="local-6989586621679263919"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263919"><span class="hs-identifier hs-var">outPath</span></a></span></span><span> </span><span id="local-6989586621679263918"><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679263918"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-437"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.Config.html#MkConfig"><span class="hs-identifier hs-type">MkConfig</span></a></span><span class="hs-special">{</span><span id="local-6989586621679263903"><span id="local-6989586621679263904"><span id="local-6989586621679263905"><span id="local-6989586621679263906"><span id="local-6989586621679263907"><span id="local-6989586621679263908"><span id="local-6989586621679263909"><span id="local-6989586621679263910"><span id="local-6989586621679263911"><span id="local-6989586621679263912"><span id="local-6989586621679263913"><span id="local-6989586621679263914"><span id="local-6989586621679263915"><span id="local-6989586621679263916"><span class="annot"><span class="annottext">Bool
String
Maybe String
Maybe Word
cfgOptimisationLevel :: Config -&gt; Maybe Word
cfgEntryPoint :: Config -&gt; Maybe String
cfgLibrary :: Config -&gt; Bool
cfgCheckOOM :: Config -&gt; Bool
cfgNoSerialise :: Config -&gt; Bool
cfgNoLink :: Config -&gt; Bool
cfgNoAssemble :: Config -&gt; Bool
cfgVerbose :: Config -&gt; Bool
cfgTrace :: Config -&gt; Bool
cfgTyped :: Config -&gt; Bool
cfgDeserialise :: Config -&gt; Bool
cfgRTS :: Config -&gt; Maybe String
cfgOutput :: Config -&gt; Maybe String
cfgInput :: Config -&gt; String
cfgOptimisationLevel :: Maybe Word
cfgEntryPoint :: Maybe String
cfgLibrary :: Bool
cfgCheckOOM :: Bool
cfgNoSerialise :: Bool
cfgNoLink :: Bool
cfgNoAssemble :: Bool
cfgVerbose :: Bool
cfgTrace :: Bool
cfgTyped :: Bool
cfgDeserialise :: Bool
cfgRTS :: Maybe String
cfgOutput :: Maybe String
cfgInput :: String
</span><a href="Hachi.Compiler.Config.html#cfgOptimisationLevel"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(CodeGenSt -&gt; Config) -&gt; m Config
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">CodeGenSt -&gt; Config
</span><a href="Hachi.Compiler.CodeGen.Monad.html#codeGenCfg"><span class="hs-identifier hs-var hs-var">codeGenCfg</span></a></span><span>
</span><span id="line-438"></span><span>
</span><span id="line-439"></span><span>    </span><span id="local-6989586621679263887"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263887"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Continuation
forall (m :: * -&gt; *). MonadCodeGen m =&gt; m Continuation
</span><a href="Hachi.Compiler.CodeGen.CPS.html#compileCpsReturn"><span class="hs-identifier hs-var">compileCpsReturn</span></a></span><span>
</span><span id="line-440"></span><span>
</span><span id="line-441"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679263905"><span class="hs-identifier hs-var">cfgLibrary</span></a></span><span>
</span><span id="line-442"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-443"></span><span>        </span><span class="annot"><span class="annottext">m Operand -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m Operand -&gt; m ()) -&gt; m Operand -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name
-&gt; [(Type, ParameterName)]
-&gt; Type
-&gt; (Global -&gt; Global)
-&gt; ([Operand] -&gt; IRBuilderT m ())
-&gt; m Operand
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Name
-&gt; [(Type, ParameterName)]
-&gt; Type
-&gt; (Global -&gt; Global)
-&gt; ([Operand] -&gt; IRBuilderT m ())
-&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#function"><span class="hs-identifier hs-var">IR.function</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;plc_entry&quot;</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Global -&gt; Global
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">(([Operand] -&gt; IRBuilderT m ()) -&gt; m Operand)
-&gt; ([Operand] -&gt; IRBuilderT m ()) -&gt; m Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">[Operand]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-444"></span><span>            </span><span id="local-6989586621679263883"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263883"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.html#commonEntry"><span class="hs-identifier hs-var">commonEntry</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263887"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679263918"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-445"></span><span>
</span><span id="line-446"></span><span>            </span><span class="annot"><span class="annottext">Operand -&gt; IRBuilderT m ()
forall (m :: * -&gt; *). MonadIRBuilder m =&gt; Operand -&gt; m ()
</span><span class="hs-identifier hs-var">ret</span></span><span> </span><span class="annot"><span class="annottext">(Operand -&gt; IRBuilderT m ()) -&gt; Operand -&gt; IRBuilderT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; Operand
forall (k :: PtrKind) to. FromClosurePtr k to =&gt; ClosurePtr k -&gt; to
</span><a href="Hachi.Compiler.CodeGen.Types.html#closurePtr"><span class="hs-identifier hs-var">closurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263883"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-447"></span><span>
</span><span id="line-448"></span><span>        </span><span id="local-6989586621679263881"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263881"><span class="hs-identifier hs-var">api</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m String
forall (m :: * -&gt; *). MonadCodeGen m =&gt; m String
</span><a href="Hachi.Compiler.CodeGen.Library.html#emitLibraryApi"><span class="hs-identifier hs-var">emitLibraryApi</span></a></span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263879"><span class="annot"><span class="annottext">headerFile :: String
</span><a href="#local-6989586621679263879"><span class="hs-identifier hs-var hs-var">headerFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
</span><span class="hs-identifier hs-var">replaceExtension</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263919"><span class="hs-identifier hs-var">outPath</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;h&quot;</span></span><span>
</span><span id="line-451"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; IO ()
</span><span class="hs-identifier hs-var">writeFile</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263879"><span class="hs-identifier hs-var">headerFile</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-452"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;#include \&quot;rts.h\&quot;\n\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span>
</span><span id="line-453"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;extern closure *plc_entry();\n\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span>
</span><span id="line-454"></span><span>            </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263881"><span class="hs-identifier hs-var">api</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\n&quot;</span></span><span>
</span><span id="line-455"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">m Operand -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m Operand -&gt; m ()) -&gt; m Operand -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name
-&gt; [(Type, ParameterName)]
-&gt; Type
-&gt; (Global -&gt; Global)
-&gt; ([Operand] -&gt; IRBuilderT m ())
-&gt; m Operand
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Name
-&gt; [(Type, ParameterName)]
-&gt; Type
-&gt; (Global -&gt; Global)
-&gt; ([Operand] -&gt; IRBuilderT m ())
-&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#function"><span class="hs-identifier hs-var">IR.function</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;main&quot;</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier hs-var">VoidType</span></span><span> </span><span class="annot"><span class="annottext">Global -&gt; Global
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">(([Operand] -&gt; IRBuilderT m ()) -&gt; m Operand)
-&gt; ([Operand] -&gt; IRBuilderT m ()) -&gt; m Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">[Operand]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-456"></span><span>        </span><span id="local-6989586621679263874"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263874"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
Continuation
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.html#commonEntry"><span class="hs-identifier hs-var">commonEntry</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679263887"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679263918"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-457"></span><span>
</span><span id="line-458"></span><span>        </span><span class="hs-comment">-- call the print code of the resulting closure</span><span>
</span><span id="line-459"></span><span>        </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadFail m, MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Closure.html#printClosure"><span class="hs-identifier hs-var">printClosure</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679263874"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-460"></span><span>        </span><span class="annot"><span class="annottext">IRBuilderT m Operand -&gt; IRBuilderT m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IRBuilderT m Operand -&gt; IRBuilderT m ())
-&gt; IRBuilderT m Operand -&gt; IRBuilderT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; IRBuilderT m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#printf"><span class="hs-identifier hs-var">printf</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#nlRef"><span class="hs-identifier hs-var">nlRef</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-461"></span><span>
</span><span id="line-462"></span><span>        </span><span class="annot"><span class="annottext">IRBuilderT m ()
forall (m :: * -&gt; *). MonadIRBuilder m =&gt; m ()
</span><span class="hs-identifier hs-var">retVoid</span></span><span>
</span><span id="line-463"></span><span>
</span><span id="line-464"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.html#compileProgram"><span class="hs-identifier hs-type">compileProgram</span></a></span><span>
</span><span id="line-465"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hachi.Compiler.Config.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span>
</span><span id="line-466"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span>
</span><span id="line-467"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Program</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">UPLC.Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefaultUni</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefaultFun</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-468"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ModuleBuilderT</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-469"></span><span id="compileProgram"><span class="annot"><span class="annottext">compileProgram :: Config
-&gt; String
-&gt; Program Name DefaultUni DefaultFun ()
-&gt; ModuleBuilderT IO ()
</span><a href="Hachi.Compiler.CodeGen.html#compileProgram"><span class="hs-identifier hs-var hs-var">compileProgram</span></a></span></span><span> </span><span id="local-6989586621679263869"><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679263869"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621679263868"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263868"><span class="hs-identifier hs-var">outPath</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Program</span></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Version ()
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679263866"><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679263866"><span class="hs-identifier hs-var">term</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-470"></span><span>    </span><span class="hs-comment">-- global definitions</span><span>
</span><span id="line-471"></span><span>    </span><span class="annot"><span class="annottext">[Definition]
-&gt; (Definition -&gt; ModuleBuilderT IO ()) -&gt; ModuleBuilderT IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[Definition]
</span><a href="Hachi.Compiler.CodeGen.Externals.html#externalDefinitions"><span class="hs-identifier hs-var">externalDefinitions</span></a></span><span> </span><span class="annot"><span class="annottext">Definition -&gt; ModuleBuilderT IO ()
forall (m :: * -&gt; *). MonadModuleBuilder m =&gt; Definition -&gt; m ()
</span><span class="hs-identifier hs-var">emitDefn</span></span><span>
</span><span id="line-472"></span><span>
</span><span id="line-473"></span><span>    </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe Type -&gt; ModuleBuilderT IO Type
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Name -&gt; Maybe Type -&gt; m Type
</span><span class="hs-identifier hs-var">typedef</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;closure&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Type -&gt; ModuleBuilderT IO Type)
-&gt; Maybe Type -&gt; ModuleBuilderT IO Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Closure.html#closureTyDef"><span class="hs-identifier hs-var">closureTyDef</span></a></span><span>
</span><span id="line-474"></span><span>    </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe Type -&gt; ModuleBuilderT IO Type
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Name -&gt; Maybe Type -&gt; m Type
</span><span class="hs-identifier hs-var">typedef</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;continuation&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Type -&gt; ModuleBuilderT IO Type)
-&gt; Maybe Type -&gt; ModuleBuilderT IO Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.CPS.html#contTyDef"><span class="hs-identifier hs-var">contTyDef</span></a></span><span>
</span><span id="line-475"></span><span>    </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe Type -&gt; ModuleBuilderT IO Type
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Name -&gt; Maybe Type -&gt; m Type
</span><span class="hs-identifier hs-var">typedef</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;bytestring&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Type -&gt; ModuleBuilderT IO Type)
-&gt; Maybe Type -&gt; ModuleBuilderT IO Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#bytestringTyDef"><span class="hs-identifier hs-var">bytestringTyDef</span></a></span><span>
</span><span id="line-476"></span><span>    </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe Type -&gt; ModuleBuilderT IO Type
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Name -&gt; Maybe Type -&gt; m Type
</span><span class="hs-identifier hs-var">typedef</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;pair&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Type -&gt; ModuleBuilderT IO Type)
-&gt; Maybe Type -&gt; ModuleBuilderT IO Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#pairTyDef"><span class="hs-identifier hs-var">pairTyDef</span></a></span><span>
</span><span id="line-477"></span><span>    </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe Type -&gt; ModuleBuilderT IO Type
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Name -&gt; Maybe Type -&gt; m Type
</span><span class="hs-identifier hs-var">typedef</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;list&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Type -&gt; ModuleBuilderT IO Type)
-&gt; Maybe Type -&gt; ModuleBuilderT IO Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#listTyDef"><span class="hs-identifier hs-var">listTyDef</span></a></span><span>
</span><span id="line-478"></span><span>    </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe Type -&gt; ModuleBuilderT IO Type
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Name -&gt; Maybe Type -&gt; m Type
</span><span class="hs-identifier hs-var">typedef</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;data&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Type -&gt; ModuleBuilderT IO Type)
-&gt; Maybe Type -&gt; ModuleBuilderT IO Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#dataTyDef"><span class="hs-identifier hs-var">dataTyDef</span></a></span><span>
</span><span id="line-479"></span><span>    </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe Type -&gt; ModuleBuilderT IO Type
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Name -&gt; Maybe Type -&gt; m Type
</span><span class="hs-identifier hs-var">typedef</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;mpz_t&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Type -&gt; ModuleBuilderT IO Type)
-&gt; Maybe Type -&gt; ModuleBuilderT IO Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#gmpTyDef"><span class="hs-identifier hs-var">gmpTyDef</span></a></span><span>
</span><span id="line-480"></span><span>
</span><span id="line-481"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679263854"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679263854"><span class="hs-identifier hs-var">errorMsg</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BasicBlock]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IRBuilderState
-&gt; IRBuilderT (ModuleBuilderT IO) Constant
-&gt; ModuleBuilderT IO (Constant, [BasicBlock])
forall (m :: * -&gt; *) a.
Monad m =&gt;
IRBuilderState -&gt; IRBuilderT m a -&gt; m (a, [BasicBlock])
</span><span class="hs-identifier hs-var">runIRBuilderT</span></span><span> </span><span class="annot"><span class="annottext">IRBuilderState
</span><span class="hs-identifier hs-var">emptyIRBuilder</span></span><span> </span><span class="annot"><span class="annottext">(IRBuilderT (ModuleBuilderT IO) Constant
 -&gt; ModuleBuilderT IO (Constant, [BasicBlock]))
-&gt; IRBuilderT (ModuleBuilderT IO) Constant
-&gt; ModuleBuilderT IO (Constant, [BasicBlock])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-482"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Name
-&gt; (Global -&gt; Global)
-&gt; IRBuilderT (ModuleBuilderT IO) Constant
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadFail m) =&gt;
String -&gt; Name -&gt; (Global -&gt; Global) -&gt; m Constant
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#globalStringPtr"><span class="hs-identifier hs-var">globalStringPtr</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Something has gone wrong.\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;errorMsg&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Global -&gt; Global) -&gt; IRBuilderT (ModuleBuilderT IO) Constant)
-&gt; (Global -&gt; Global) -&gt; IRBuilderT (ModuleBuilderT IO) Constant
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-483"></span><span>        </span><span class="annot"><span class="annottext">Linkage -&gt; Global -&gt; Global
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#setLinkage"><span class="hs-identifier hs-var">setLinkage</span></a></span><span> </span><span class="annot"><span class="annottext">Linkage
</span><span class="hs-identifier hs-var">LinkOnce</span></span><span>
</span><span id="line-484"></span><span>
</span><span id="line-485"></span><span>    </span><span class="hs-comment">-- initialise the compilation context with empty counters</span><span>
</span><span id="line-486"></span><span>    </span><span id="local-6989586621679263848"><span class="annot"><span class="annottext">IORef (Map String (IORef Integer))
</span><a href="#local-6989586621679263848"><span class="hs-identifier hs-var">counter</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (IORef (Map String (IORef Integer)))
-&gt; ModuleBuilderT IO (IORef (Map String (IORef Integer)))
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (IORef (Map String (IORef Integer)))
 -&gt; ModuleBuilderT IO (IORef (Map String (IORef Integer))))
-&gt; IO (IORef (Map String (IORef Integer)))
-&gt; ModuleBuilderT IO (IORef (Map String (IORef Integer)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map String (IORef Integer)
-&gt; IO (IORef (Map String (IORef Integer)))
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">Map String (IORef Integer)
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-487"></span><span>    </span><span id="local-6989586621679263845"><span class="annot"><span class="annottext">IORef (Map ConstantTy Constant)
</span><a href="#local-6989586621679263845"><span class="hs-identifier hs-var">constEntries</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (IORef (Map ConstantTy Constant))
-&gt; ModuleBuilderT IO (IORef (Map ConstantTy Constant))
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (IORef (Map ConstantTy Constant))
 -&gt; ModuleBuilderT IO (IORef (Map ConstantTy Constant)))
-&gt; IO (IORef (Map ConstantTy Constant))
-&gt; ModuleBuilderT IO (IORef (Map ConstantTy Constant))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map ConstantTy Constant -&gt; IO (IORef (Map ConstantTy Constant))
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">Map ConstantTy Constant
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-488"></span><span>    </span><span id="local-6989586621679263844"><span class="annot"><span class="annottext">IORef (Map ConstantTy Constant)
</span><a href="#local-6989586621679263844"><span class="hs-identifier hs-var">constPrinters</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (IORef (Map ConstantTy Constant))
-&gt; ModuleBuilderT IO (IORef (Map ConstantTy Constant))
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (IORef (Map ConstantTy Constant))
 -&gt; ModuleBuilderT IO (IORef (Map ConstantTy Constant)))
-&gt; IO (IORef (Map ConstantTy Constant))
-&gt; ModuleBuilderT IO (IORef (Map ConstantTy Constant))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map ConstantTy Constant -&gt; IO (IORef (Map ConstantTy Constant))
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">Map ConstantTy Constant
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-489"></span><span>    </span><span id="local-6989586621679263843"><span class="annot"><span class="annottext">IORef (Maybe Constant)
</span><a href="#local-6989586621679263843"><span class="hs-identifier hs-var">funPrinter</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (IORef (Maybe Constant))
-&gt; ModuleBuilderT IO (IORef (Maybe Constant))
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (IORef (Maybe Constant))
 -&gt; ModuleBuilderT IO (IORef (Maybe Constant)))
-&gt; IO (IORef (Maybe Constant))
-&gt; ModuleBuilderT IO (IORef (Maybe Constant))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe Constant -&gt; IO (IORef (Maybe Constant))
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">Maybe Constant
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-490"></span><span>
</span><span id="line-491"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263842"><span class="annot"><span class="annottext">codeGenSt :: CodeGenSt
</span><a href="#local-6989586621679263842"><span class="hs-identifier hs-var hs-var">codeGenSt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MkCodeGenSt :: Config
-&gt; Constant
-&gt; IORef (Map String (IORef Integer))
-&gt; Map Text Local
-&gt; Map DefaultFun (ClosurePtr 'StaticPtr)
-&gt; IORef (Map ConstantTy Constant)
-&gt; IORef (Map ConstantTy Constant)
-&gt; IORef (Maybe Constant)
-&gt; Set (Text, Bool)
-&gt; CodeGenSt
</span><a href="Hachi.Compiler.CodeGen.Monad.html#MkCodeGenSt"><span class="hs-identifier hs-type">MkCodeGenSt</span></a></span><span class="hs-special">{</span><span>
</span><span id="line-492"></span><span>            </span><span class="annot"><span class="annottext">codeGenCfg :: Config
</span><a href="Hachi.Compiler.CodeGen.Monad.html#codeGenCfg"><span class="hs-identifier hs-var">codeGenCfg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679263869"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-493"></span><span>            </span><span class="annot"><span class="annottext">codeGenErrMsg :: Constant
</span><a href="Hachi.Compiler.CodeGen.Monad.html#codeGenErrMsg"><span class="hs-identifier hs-var">codeGenErrMsg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679263854"><span class="hs-identifier hs-var">errorMsg</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-494"></span><span>            </span><span class="annot"><span class="annottext">codeGenCounters :: IORef (Map String (IORef Integer))
</span><a href="Hachi.Compiler.CodeGen.Monad.html#codeGenCounters"><span class="hs-identifier hs-var">codeGenCounters</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef (Map String (IORef Integer))
</span><a href="#local-6989586621679263848"><span class="hs-identifier hs-var">counter</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-495"></span><span>            </span><span class="annot"><span class="annottext">codeGenEnv :: Map Text Local
</span><a href="Hachi.Compiler.CodeGen.Monad.html#codeGenEnv"><span class="hs-identifier hs-var">codeGenEnv</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Text Local
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span class="hs-special">,</span><span>
</span><span id="line-496"></span><span>            </span><span class="annot"><span class="annottext">codeGenBuiltins :: Map DefaultFun (ClosurePtr 'StaticPtr)
</span><a href="Hachi.Compiler.CodeGen.Monad.html#codeGenBuiltins"><span class="hs-identifier hs-var">codeGenBuiltins</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map DefaultFun (ClosurePtr 'StaticPtr)
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span class="hs-special">,</span><span>
</span><span id="line-497"></span><span>            </span><span class="annot"><span class="annottext">codeGenConstEntries :: IORef (Map ConstantTy Constant)
</span><a href="Hachi.Compiler.CodeGen.Monad.html#codeGenConstEntries"><span class="hs-identifier hs-var">codeGenConstEntries</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef (Map ConstantTy Constant)
</span><a href="#local-6989586621679263845"><span class="hs-identifier hs-var">constEntries</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-498"></span><span>            </span><span class="annot"><span class="annottext">codeGenConstPrinters :: IORef (Map ConstantTy Constant)
</span><a href="Hachi.Compiler.CodeGen.Monad.html#codeGenConstPrinters"><span class="hs-identifier hs-var">codeGenConstPrinters</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef (Map ConstantTy Constant)
</span><a href="#local-6989586621679263844"><span class="hs-identifier hs-var">constPrinters</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-499"></span><span>            </span><span class="annot"><span class="annottext">codeGenFunPrinter :: IORef (Maybe Constant)
</span><a href="Hachi.Compiler.CodeGen.Monad.html#codeGenFunPrinter"><span class="hs-identifier hs-var">codeGenFunPrinter</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe Constant)
</span><a href="#local-6989586621679263843"><span class="hs-identifier hs-var">funPrinter</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-500"></span><span>            </span><span class="annot"><span class="annottext">codeGenFreeVars :: Set (Text, Bool)
</span><a href="Hachi.Compiler.CodeGen.Monad.html#codeGenFreeVars"><span class="hs-identifier hs-var">codeGenFreeVars</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set (Text, Bool)
forall a. Set a
</span><span class="hs-identifier hs-var">S.empty</span></span><span>
</span><span id="line-501"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-502"></span><span>
</span><span id="line-503"></span><span>    </span><span class="hs-comment">-- compile the program</span><span>
</span><span id="line-504"></span><span>    </span><span class="annot"><span class="annottext">ModuleBuilderT IO () -&gt; ModuleBuilderT IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ModuleBuilderT IO () -&gt; ModuleBuilderT IO ())
-&gt; ModuleBuilderT IO () -&gt; ModuleBuilderT IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ReaderT CodeGenSt (ModuleBuilderT IO) ()
-&gt; CodeGenSt -&gt; ModuleBuilderT IO ()
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CodeGen (ModuleBuilderT IO) ()
-&gt; ReaderT CodeGenSt (ModuleBuilderT IO) ()
forall (m :: * -&gt; *) a. CodeGen m a -&gt; ReaderT CodeGenSt m a
</span><a href="Hachi.Compiler.CodeGen.Monad.html#runCodeGen"><span class="hs-identifier hs-var hs-var">runCodeGen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
-&gt; Term Name DefaultUni DefaultFun ()
-&gt; CodeGen (ModuleBuilderT IO) ()
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
String -&gt; Term Name DefaultUni DefaultFun () -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.html#generateEntry"><span class="hs-identifier hs-var">generateEntry</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263868"><span class="hs-identifier hs-var">outPath</span></a></span><span> </span><span class="annot"><span class="annottext">Term Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679263866"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CodeGenSt
</span><a href="#local-6989586621679263842"><span class="hs-identifier hs-var">codeGenSt</span></a></span><span>
</span><span id="line-505"></span><span>
</span><span id="line-506"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-507"></span><span>
</span><span id="line-508"></span><span class="hs-comment">-- | `generateCode` @config path program@ generates code for @program@</span><span>
</span><span id="line-509"></span><span class="hs-comment">-- using the configuration given by @config@.</span><span>
</span><span id="line-510"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.html#generateCode"><span class="hs-identifier hs-type">generateCode</span></a></span><span>
</span><span id="line-511"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hachi.Compiler.Config.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span>
</span><span id="line-512"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Program</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">UPLC.Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefaultUni</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefaultFun</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-513"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-514"></span><span id="generateCode"><span class="annot"><span class="annottext">generateCode :: Config -&gt; Program Name DefaultUni DefaultFun () -&gt; IO ()
</span><a href="Hachi.Compiler.CodeGen.html#generateCode"><span class="hs-identifier hs-var hs-var">generateCode</span></a></span></span><span> </span><span id="local-6989586621679263831"><span class="annot"><span class="annottext">cfg :: Config
</span><a href="#local-6989586621679263831"><span class="hs-identifier hs-var">cfg</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Hachi.Compiler.Config.html#MkConfig"><span class="hs-identifier hs-type">MkConfig</span></a></span><span class="hs-special">{</span><span id="local-6989586621679263817"><span id="local-6989586621679263818"><span id="local-6989586621679263819"><span id="local-6989586621679263820"><span id="local-6989586621679263821"><span id="local-6989586621679263822"><span id="local-6989586621679263823"><span id="local-6989586621679263824"><span id="local-6989586621679263825"><span id="local-6989586621679263826"><span id="local-6989586621679263827"><span id="local-6989586621679263828"><span id="local-6989586621679263829"><span id="local-6989586621679263830"><span class="annot"><span class="annottext">Bool
String
Maybe String
Maybe Word
cfgOptimisationLevel :: Maybe Word
cfgEntryPoint :: Maybe String
cfgLibrary :: Bool
cfgCheckOOM :: Bool
cfgNoSerialise :: Bool
cfgNoLink :: Bool
cfgNoAssemble :: Bool
cfgVerbose :: Bool
cfgTrace :: Bool
cfgTyped :: Bool
cfgDeserialise :: Bool
cfgRTS :: Maybe String
cfgOutput :: Maybe String
cfgInput :: String
cfgOptimisationLevel :: Config -&gt; Maybe Word
cfgEntryPoint :: Config -&gt; Maybe String
cfgLibrary :: Config -&gt; Bool
cfgCheckOOM :: Config -&gt; Bool
cfgNoSerialise :: Config -&gt; Bool
cfgNoLink :: Config -&gt; Bool
cfgNoAssemble :: Config -&gt; Bool
cfgVerbose :: Config -&gt; Bool
cfgTrace :: Config -&gt; Bool
cfgTyped :: Config -&gt; Bool
cfgDeserialise :: Config -&gt; Bool
cfgRTS :: Config -&gt; Maybe String
cfgOutput :: Config -&gt; Maybe String
cfgInput :: Config -&gt; String
</span><a href="#local-6989586621679263817"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679263816"><span class="annot"><span class="annottext">Program Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679263816"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-515"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263815"><span class="annot"><span class="annottext">outputName :: String
</span><a href="#local-6989586621679263815"><span class="hs-identifier hs-var hs-var">outputName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe String -&gt; String
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263830"><span class="hs-identifier hs-var">cfgInput</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621679263829"><span class="hs-identifier hs-var">cfgOutput</span></a></span><span>
</span><span id="line-516"></span><span>        </span><span id="local-6989586621679263813"><span class="annot"><span class="annottext">compiler :: ModuleBuilderT IO ()
</span><a href="#local-6989586621679263813"><span class="hs-identifier hs-var hs-var">compiler</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Config
-&gt; String
-&gt; Program Name DefaultUni DefaultFun ()
-&gt; ModuleBuilderT IO ()
</span><a href="Hachi.Compiler.CodeGen.html#compileProgram"><span class="hs-identifier hs-var">compileProgram</span></a></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679263831"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263815"><span class="hs-identifier hs-var">outputName</span></a></span><span> </span><span class="annot"><span class="annottext">Program Name DefaultUni DefaultFun ()
</span><a href="#local-6989586621679263816"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-517"></span><span>        </span><span id="local-6989586621679263812"><span class="annot"><span class="annottext">passSetSpec :: PassSetSpec
</span><a href="#local-6989586621679263812"><span class="hs-identifier hs-var hs-var">passSetSpec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PassSetSpec
</span><span class="hs-identifier hs-var">defaultCuratedPassSetSpec</span></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">optLevel :: Maybe Word
</span><span class="hs-identifier hs-var">optLevel</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Word
</span><a href="#local-6989586621679263817"><span class="hs-identifier hs-var">cfgOptimisationLevel</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-518"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(Context -&gt; IO ()) -&gt; IO ()
forall a. (Context -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">withContext</span></span><span> </span><span class="annot"><span class="annottext">((Context -&gt; IO ()) -&gt; IO ()) -&gt; (Context -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679263808"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679263808"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-519"></span><span>    </span><span class="hs-comment">-- withModuleFromLLVMAssembly ctx (File &quot;wrapper.ll&quot;) $ \m -&gt; moduleAST m &gt;&gt;= print</span><span>
</span><span id="line-520"></span><span>
</span><span id="line-521"></span><span>    </span><span class="annot"><span class="annottext">PassSetSpec -&gt; (PassManager -&gt; IO ()) -&gt; IO ()
forall a. PassSetSpec -&gt; (PassManager -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">withPassManager</span></span><span> </span><span class="annot"><span class="annottext">PassSetSpec
</span><a href="#local-6989586621679263812"><span class="hs-identifier hs-var">passSetSpec</span></a></span><span> </span><span class="annot"><span class="annottext">((PassManager -&gt; IO ()) -&gt; IO ())
-&gt; (PassManager -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679263806"><span class="annot"><span class="annottext">PassManager
</span><a href="#local-6989586621679263806"><span class="hs-identifier hs-var">pm</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-522"></span><span>    </span><span class="annot"><span class="annottext">(TargetMachine -&gt; IO ()) -&gt; IO ()
forall a. (TargetMachine -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">withHostTargetMachineDefault</span></span><span> </span><span class="annot"><span class="annottext">((TargetMachine -&gt; IO ()) -&gt; IO ())
-&gt; (TargetMachine -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679263804"><span class="annot"><span class="annottext">TargetMachine
</span><a href="#local-6989586621679263804"><span class="hs-identifier hs-var">tm</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-523"></span><span>    </span><span class="annot"><span class="annottext">ShortByteString -&gt; ModuleBuilderT IO () -&gt; IO Module
forall (m :: * -&gt; *) a.
Monad m =&gt;
ShortByteString -&gt; ModuleBuilderT m a -&gt; m Module
</span><span class="hs-identifier hs-var">buildModuleT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; ShortByteString
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ShortByteString) -&gt; String -&gt; ShortByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String
</span><span class="hs-identifier hs-var">takeBaseName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263830"><span class="hs-identifier hs-var">cfgInput</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ModuleBuilderT IO ()
</span><a href="#local-6989586621679263813"><span class="hs-identifier hs-var">compiler</span></a></span><span> </span><span class="annot"><span class="annottext">IO Module -&gt; (Module -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679263801"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621679263801"><span class="hs-identifier hs-var">compiled</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-524"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; Module -&gt; (Module -&gt; IO ()) -&gt; IO ()
forall a. Context -&gt; Module -&gt; (Module -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">withModuleFromAST</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679263808"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621679263801"><span class="hs-identifier hs-var">compiled</span></a></span><span class="hs-special">{</span><span>
</span><span id="line-525"></span><span>        </span><span class="annot"><span class="annottext">moduleSourceFileName :: ShortByteString
</span><span class="hs-identifier hs-var">moduleSourceFileName</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; ShortByteString
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263830"><span class="hs-identifier hs-var">cfgInput</span></a></span><span>
</span><span id="line-526"></span><span>    </span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">((Module -&gt; IO ()) -&gt; IO ()) -&gt; (Module -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679263798"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621679263798"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-527"></span><span>        </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PassManager -&gt; Module -&gt; IO Bool
</span><span class="hs-identifier hs-var">runPassManager</span></span><span> </span><span class="annot"><span class="annottext">PassManager
</span><a href="#local-6989586621679263806"><span class="hs-identifier hs-var">pm</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621679263798"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-528"></span><span>
</span><span id="line-529"></span><span>        </span><span class="hs-comment">-- by default, we generate LLVM bitcode (the binary representation),</span><span>
</span><span id="line-530"></span><span>        </span><span class="hs-comment">-- but if the user has requested plain-text LLVM IR, we generate</span><span>
</span><span id="line-531"></span><span>        </span><span class="hs-comment">-- that instead</span><span>
</span><span id="line-532"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679263821"><span class="hs-identifier hs-var">cfgNoSerialise</span></a></span><span>
</span><span id="line-533"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-534"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263796"><span class="annot"><span class="annottext">llName :: String
</span><a href="#local-6989586621679263796"><span class="hs-identifier hs-var hs-var">llName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
</span><span class="hs-identifier hs-var">replaceExtension</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263815"><span class="hs-identifier hs-var">outputName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ll&quot;</span></span><span>
</span><span id="line-535"></span><span>            </span><span id="local-6989586621679263795"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679263795"><span class="hs-identifier hs-var">asm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Module -&gt; IO ByteString
</span><span class="hs-identifier hs-var">moduleLLVMAssembly</span></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621679263798"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-536"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; ByteString -&gt; IO ()
</span><span class="hs-identifier hs-var">BS.writeFile</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263796"><span class="hs-identifier hs-var">llName</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679263795"><span class="hs-identifier hs-var">asm</span></a></span><span>
</span><span id="line-537"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-538"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263792"><span class="annot"><span class="annottext">bcName :: String
</span><a href="#local-6989586621679263792"><span class="hs-identifier hs-var hs-var">bcName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
</span><span class="hs-identifier hs-var">replaceExtension</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263815"><span class="hs-identifier hs-var">outputName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;bc&quot;</span></span><span>
</span><span id="line-539"></span><span>            </span><span class="annot"><span class="annottext">File -&gt; Module -&gt; IO ()
</span><span class="hs-identifier hs-var">writeBitcodeToFile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; File
</span><span class="hs-identifier hs-var">File</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263792"><span class="hs-identifier hs-var">bcName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621679263798"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-540"></span><span>
</span><span id="line-541"></span><span>        </span><span class="hs-comment">-- unless we have been instructed not to assemble the LLVM IR into</span><span>
</span><span id="line-542"></span><span>        </span><span class="hs-comment">-- an object file, produce an object file</span><span>
</span><span id="line-543"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679263823"><span class="hs-identifier hs-var">cfgNoAssemble</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-544"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679263788"><span class="annot"><span class="annottext">objectFile :: String
</span><a href="#local-6989586621679263788"><span class="hs-identifier hs-var hs-var">objectFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
</span><span class="hs-identifier hs-var">replaceExtension</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263815"><span class="hs-identifier hs-var">outputName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;o&quot;</span></span><span>
</span><span id="line-545"></span><span>            </span><span class="annot"><span class="annottext">TargetMachine -&gt; File -&gt; Module -&gt; IO ()
</span><span class="hs-identifier hs-var">writeObjectToFile</span></span><span> </span><span class="annot"><span class="annottext">TargetMachine
</span><a href="#local-6989586621679263804"><span class="hs-identifier hs-var">tm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; File
</span><span class="hs-identifier hs-var">File</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263788"><span class="hs-identifier hs-var">objectFile</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621679263798"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-546"></span><span>
</span><span id="line-547"></span><span>            </span><span class="hs-comment">-- unless we have been instructed not to link together an</span><span>
</span><span id="line-548"></span><span>            </span><span class="hs-comment">-- executable, run Clang to produce an executable from the</span><span>
</span><span id="line-549"></span><span>            </span><span class="hs-comment">-- object file</span><span>
</span><span id="line-550"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679263822"><span class="hs-identifier hs-var">cfgNoLink</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679263819"><span class="hs-identifier hs-var">cfgLibrary</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-551"></span><span>                </span><span class="annot"><span class="annottext">Config -&gt; String -&gt; [String] -&gt; IO ()
</span><a href="Hachi.Compiler.CodeGen.Driver.html#linkExecutable"><span class="hs-identifier hs-var">linkExecutable</span></a></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679263831"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263815"><span class="hs-identifier hs-var">outputName</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263788"><span class="hs-identifier hs-var">objectFile</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-552"></span><span>
</span><span id="line-553"></span><span>            </span><span class="hs-comment">-- if we are compiling a library and the --entry-point option is</span><span>
</span><span id="line-554"></span><span>            </span><span class="hs-comment">-- specified, we also compile the C program and link it together</span><span>
</span><span id="line-555"></span><span>            </span><span class="hs-comment">-- with our PLC object file; this has the advantage that we know</span><span>
</span><span id="line-556"></span><span>            </span><span class="hs-comment">-- what options to pass to the C compiler already, so that a</span><span>
</span><span id="line-557"></span><span>            </span><span class="hs-comment">-- user doesn't have to figure this out by hand</span><span>
</span><span id="line-558"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679263819"><span class="hs-identifier hs-var">cfgLibrary</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621679263818"><span class="hs-identifier hs-var">cfgEntryPoint</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-559"></span><span>                </span><span class="annot"><span class="annottext">Maybe String
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-560"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679263783"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263783"><span class="hs-identifier hs-var">cFile</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-561"></span><span>                    </span><span class="hs-comment">-- compile the wrapper program to an object file</span><span>
</span><span id="line-562"></span><span>                    </span><span id="local-6989586621679263782"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263782"><span class="hs-identifier hs-var">programObj</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Config -&gt; String -&gt; IO String
</span><a href="Hachi.Compiler.CodeGen.Driver.html#buildObjectFile"><span class="hs-identifier hs-var">buildObjectFile</span></a></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679263831"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263783"><span class="hs-identifier hs-var">cFile</span></a></span><span>
</span><span id="line-563"></span><span>
</span><span id="line-564"></span><span>                    </span><span class="hs-comment">-- link everything together</span><span>
</span><span id="line-565"></span><span>                    </span><span class="annot"><span class="annottext">Config -&gt; String -&gt; [String] -&gt; IO ()
</span><a href="Hachi.Compiler.CodeGen.Driver.html#linkExecutable"><span class="hs-identifier hs-var">linkExecutable</span></a></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679263831"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263815"><span class="hs-identifier hs-var">outputName</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263782"><span class="hs-identifier hs-var">programObj</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679263788"><span class="hs-identifier hs-var">objectFile</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-566"></span><span>
</span><span id="line-567"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-568"></span></pre></body></html>