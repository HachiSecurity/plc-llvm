<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-comment">-- | This module contains code generation functions for constants.</span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hachi.Compiler.CodeGen.Constant</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Globals.html#generateConstantGlobals"><span class="hs-identifier">generateConstantGlobals</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Globals.html#forceErrRef"><span class="hs-identifier">forceErrRef</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#CompileConstant"><span class="hs-identifier">CompileConstant</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#compileConst"><span class="hs-identifier">compileConst</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstDynamic"><span class="hs-identifier">compileConstDynamic</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#retConstDynamic"><span class="hs-identifier">retConstDynamic</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#loadConstVal"><span class="hs-identifier">loadConstVal</span></a></span><span>
</span><span id="line-16"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.IORef</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Proxy</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Encoding</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">encodeUtf8</span></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">LLVM.AST</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LLVM</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">LLVM.AST.Constant</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">LLVM.AST.IntegerPredicate</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LLVM</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">LLVM.AST.Linkage</span></span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">PlutusCore</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PLC</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">PlutusCore.Data</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PLC</span></span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Closure</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Common.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Common</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.ByteString.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Constant.ByteString</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.Data.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Constant.Data</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.List.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Constant.List</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.Pair.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Constant.Pair</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.CPS.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.CPS</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Externals.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Externals</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Globals.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Globals</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">G</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.IRBuilder.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.IRBuilder</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IR</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Monad</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Types</span></a></span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="hs-keyword">class</span><span> </span><span id="CompileConstant"><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#CompileConstant"><span class="hs-identifier hs-var">CompileConstant</span></a></span></span><span> </span><span id="local-6989586621679262556"><span class="annot"><a href="#local-6989586621679262556"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-comment">-- | `constantTypeId` returns a value-level identifier for this type</span><span>
</span><span id="line-56"></span><span>    </span><span class="hs-comment">-- of constant.</span><span>
</span><span id="line-57"></span><span>    </span><span id="constantTypeId"><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#constantTypeId"><span class="hs-identifier hs-type">constantTypeId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#ConstantTy"><span class="hs-identifier hs-type">ConstantTy</span></a></span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span>    </span><span class="hs-comment">-- | `compileConstant` @name val@ generates code which initialises the</span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-comment">-- constant given by @val@. In simple cases, this may just return a</span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-comment">-- constant expression, while in other cases we may generate a global</span><span>
</span><span id="line-62"></span><span>    </span><span class="hs-comment">-- and return a pointer to it.</span><span>
</span><span id="line-63"></span><span>    </span><span id="local-6989586621679262563"><span id="compileConstant"><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstant"><span class="hs-identifier hs-type">compileConstant</span></a></span></span><span>
</span><span id="line-64"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#MonadCodeGen"><span class="hs-identifier hs-type">MonadCodeGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262563"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679262563"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262556"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262563"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Constant</span></span></span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-comment">-- | `castConstantToPtr` @val@ may generate code which casts a non-pointer</span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-comment">-- constant value to a pointer, so that it can be stored in the closure</span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-comment">-- as a free variable. This is the case for `Bool` and `()`.</span><span>
</span><span id="line-70"></span><span>    </span><span id="local-6989586621679262562"><span id="castConstantToPtr"><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#castConstantToPtr"><span class="hs-identifier hs-type">castConstantToPtr</span></a></span></span><span>
</span><span id="line-71"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679262562"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Operand</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262562"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Operand</span></span></span><span>
</span><span id="line-72"></span><span>    </span><span id="local-6989586621679262371"><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#castConstantToPtr"><span class="hs-identifier hs-var hs-var">castConstantToPtr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; m Operand
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-comment">-- | `compileLoadConstant` @closurePtr@ loads the constant from a closure</span><span>
</span><span id="line-75"></span><span>    </span><span class="hs-comment">-- given by @closurePtr@. This function must be used with</span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-comment">-- `XTypeApplications` to specify which implementation to use.</span><span>
</span><span id="line-77"></span><span>    </span><span id="local-6989586621679262559"><span id="local-6989586621679262560"><span id="compileLoadConstant"><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#compileLoadConstant"><span class="hs-identifier hs-type">compileLoadConstant</span></a></span></span><span>
</span><span id="line-78"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#MonadCodeGen"><span class="hs-identifier hs-type">MonadCodeGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262560"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679262560"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262559"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262560"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Operand</span></span></span></span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-comment">-- | `compilePrintBody` @name closurePtr@ generates code which</span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-comment">-- pretty-prints the value of the constant stored in @closurePtr@.</span><span>
</span><span id="line-83"></span><span>    </span><span id="local-6989586621679262557"><span id="local-6989586621679262558"><span id="compilePrintBody"><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#compilePrintBody"><span class="hs-identifier hs-type">compilePrintBody</span></a></span></span><span>
</span><span id="line-84"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#MonadCodeGen"><span class="hs-identifier hs-type">MonadCodeGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679262558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262557"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262558"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#ccProxy"><span class="hs-identifier hs-type">ccProxy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Proxy</span></span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#CompileConstant"><span class="hs-identifier hs-type">CompileConstant</span></a></span><span>
</span><span id="line-88"></span><span id="ccProxy"><span class="annot"><span class="annottext">ccProxy :: Proxy CompileConstant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#ccProxy"><span class="hs-identifier hs-var hs-var">ccProxy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proxy CompileConstant
forall k (t :: k). Proxy t
</span><span class="hs-identifier hs-var">Proxy</span></span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="hs-comment">-- | `compileSubConstant` @baseName value@ is a wrapper around</span><span>
</span><span id="line-91"></span><span class="hs-comment">-- `compileConstStatic` for @value@ which additionally generates a fresh</span><span>
</span><span id="line-92"></span><span class="hs-comment">-- name based on the suggestion given by @baseName@ and constructs a global</span><span>
</span><span id="line-93"></span><span class="hs-comment">-- reference to the resulting closure.</span><span>
</span><span id="line-94"></span><span id="local-6989586621679262480"><span id="local-6989586621679262481"><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#compileSubConstant"><span class="hs-identifier hs-type">compileSubConstant</span></a></span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#MonadCodeGen"><span class="hs-identifier hs-type">MonadCodeGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262481"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679262481"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#CompileConstant"><span class="hs-identifier hs-type">CompileConstant</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262480"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262480"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262481"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Constant</span></span></span></span><span>
</span><span id="line-97"></span><span id="compileSubConstant"><span class="annot"><span class="annottext">compileSubConstant :: String -&gt; a -&gt; m Constant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileSubConstant"><span class="hs-identifier hs-var hs-var">compileSubConstant</span></a></span></span><span> </span><span id="local-6989586621679262365"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262365"><span class="hs-identifier hs-var">baseName</span></a></span></span><span> </span><span id="local-6989586621679262364"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679262364"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-98"></span><span>    </span><span id="local-6989586621679262363"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262363"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; m String
forall (m :: * -&gt; *).
(MonadReader CodeGenSt m, MonadIO m) =&gt;
String -&gt; m String
</span><a href="Hachi.Compiler.CodeGen.Monad.html#mkFresh"><span class="hs-identifier hs-var">mkFresh</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262365"><span class="hs-identifier hs-var">baseName</span></a></span><span>
</span><span id="line-99"></span><span>    </span><span id="local-6989586621679262361"><span class="annot"><span class="annottext">ClosurePtr 'StaticPtr
</span><a href="#local-6989586621679262361"><span class="hs-identifier hs-var">constPtr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; a -&gt; m (ClosurePtr 'StaticPtr)
forall a (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m, CompileConstant a) =&gt;
String -&gt; a -&gt; m (ClosurePtr 'StaticPtr)
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstStatic"><span class="hs-identifier hs-var">compileConstStatic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262363"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679262364"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-comment">-- unfortunately, GHC does not seem to be smart enough to know that</span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-comment">-- MkStaticClosurePtr con &lt;- compileConstStatic name v</span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-comment">-- cannot fail and still requires a MonadFail instance</span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'StaticPtr
</span><a href="#local-6989586621679262361"><span class="hs-identifier hs-var">constPtr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-105"></span><span>        </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#MkStaticClosurePtr"><span class="hs-identifier hs-type">MkStaticClosurePtr</span></a></span><span> </span><span id="local-6989586621679262358"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262358"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Constant -&gt; m Constant
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262358"><span class="hs-identifier hs-var">con</span></a></span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679262354"><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#CompileConstant"><span class="hs-identifier hs-type">CompileConstant</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integer</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-108"></span><span>    </span><span id="local-6989586621679262350"><span class="annot"><span class="annottext">constantTypeId :: ConstantTy
</span><a href="#local-6989586621679262350"><span class="hs-identifier hs-var hs-var hs-var hs-var">constantTypeId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConstantTy
</span><a href="Hachi.Compiler.CodeGen.Monad.html#ConstInteger"><span class="hs-identifier hs-var">ConstInteger</span></a></span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-comment">-- we can just stick the integer value directly into the closure</span><span>
</span><span id="line-111"></span><span>    </span><span id="local-6989586621679262348"><span class="annot"><span class="annottext">compileConstant :: String -&gt; Integer -&gt; m Constant
</span><a href="#local-6989586621679262348"><span class="hs-identifier hs-var hs-var hs-var hs-var">compileConstant</span></a></span></span><span> </span><span id="local-6989586621679262347"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262347"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679262346"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679262346"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-112"></span><span>        </span><span class="hs-comment">-- generate a global variable for the arbitrary precision integer</span><span>
</span><span id="line-113"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262345"><span class="annot"><span class="annottext">gmpName :: Name
</span><a href="#local-6989586621679262345"><span class="hs-identifier hs-var hs-var">gmpName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">mkName</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Name) -&gt; String -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262347"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_gmp&quot;</span></span><span>
</span><span id="line-114"></span><span>        </span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Type -&gt; Constant -&gt; (Global -&gt; Global) -&gt; m Operand
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Name -&gt; Type -&gt; Constant -&gt; (Global -&gt; Global) -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#global"><span class="hs-identifier hs-var">global</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679262345"><span class="hs-identifier hs-var">gmpName</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#gmpTy"><span class="hs-identifier hs-var">gmpTy</span></a></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="Hachi.Compiler.CodeGen.Types.html#emptyGmpTy"><span class="hs-identifier hs-var">emptyGmpTy</span></a></span><span> </span><span class="annot"><span class="annottext">((Global -&gt; Global) -&gt; m Operand)
-&gt; (Global -&gt; Global) -&gt; m Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Linkage -&gt; Global -&gt; Global
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#setLinkage"><span class="hs-identifier hs-var">setLinkage</span></a></span><span> </span><span class="annot"><span class="annottext">Linkage
</span><span class="hs-identifier hs-var">Private</span></span><span>
</span><span id="line-115"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262338"><span class="annot"><span class="annottext">gmpRef :: Constant
</span><a href="#local-6989586621679262338"><span class="hs-identifier hs-var hs-var">gmpRef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Name -&gt; Constant
</span><span class="hs-identifier hs-var">GlobalReference</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#gmpTyPtr"><span class="hs-identifier hs-var">gmpTyPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679262345"><span class="hs-identifier hs-var">gmpName</span></a></span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span>        </span><span class="hs-comment">-- the arbitrary precision integer needs to be initialised, but we</span><span>
</span><span id="line-118"></span><span>        </span><span class="hs-comment">-- can only do this by calling a function from the gmp library, so</span><span>
</span><span id="line-119"></span><span>        </span><span class="hs-comment">-- it can't be done in a constant initialiser; we insert a call to</span><span>
</span><span id="line-120"></span><span>        </span><span class="hs-comment">-- the initialisation function in the current code block which may</span><span>
</span><span id="line-121"></span><span>        </span><span class="hs-comment">-- run multiple times, but since the data is immutable, this should</span><span>
</span><span id="line-122"></span><span>        </span><span class="hs-comment">-- not be a problem.... TODO: fix if it is a problem</span><span>
</span><span id="line-123"></span><span>        </span><span class="annot"><span class="annottext">Name -&gt; Constant -&gt; String -&gt; m ()
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Name -&gt; Constant -&gt; String -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Externals.GMP.html#mpzInitSetStr"><span class="hs-identifier hs-var">mpzInitSetStr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">mkName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262347"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262338"><span class="hs-identifier hs-var">gmpRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679262346"><span class="hs-identifier hs-var">val</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span>        </span><span class="hs-comment">-- return the pointer to the global</span><span>
</span><span id="line-126"></span><span>        </span><span class="annot"><span class="annottext">Constant -&gt; m Constant
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262338"><span class="hs-identifier hs-var">gmpRef</span></a></span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-comment">-- retrieve the pointer from the closure directly</span><span>
</span><span id="line-129"></span><span>    </span><span id="local-6989586621679262333"><span class="annot"><span class="annottext">compileLoadConstant :: ClosurePtr k -&gt; m Operand
</span><a href="#local-6989586621679262333"><span class="hs-identifier hs-var hs-var hs-var hs-var">compileLoadConstant</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#loadFromClosure"><span class="hs-identifier hs-var">loadFromClosure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; ClosureComponent
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureFreeVar"><span class="hs-identifier hs-var">ClosureFreeVar</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#gmpTyPtr"><span class="hs-identifier hs-var">gmpTyPtr</span></a></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span>    </span><span id="local-6989586621679262330"><span class="annot"><span class="annottext">compilePrintBody :: String -&gt; ClosurePtr k -&gt; m ()
</span><a href="#local-6989586621679262330"><span class="hs-identifier hs-var hs-var hs-var hs-var">compilePrintBody</span></a></span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679262329"><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679262329"><span class="hs-identifier hs-var">this</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-132"></span><span>        </span><span class="hs-comment">-- retrieve the pointer from the closure</span><span>
</span><span id="line-133"></span><span>        </span><span id="local-6989586621679262328"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262328"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ClosurePtr k -&gt; m Operand
forall a (m :: * -&gt; *) (k :: PtrKind).
(CompileConstant a, MonadCodeGen m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileLoadConstant"><span class="hs-identifier hs-var">compileLoadConstant</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">Integer</span></span><span> </span><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679262329"><span class="hs-identifier hs-var">this</span></a></span><span>
</span><span id="line-134"></span><span>
</span><span id="line-135"></span><span>        </span><span class="hs-comment">-- convert the arbitrary precision integer to a string</span><span>
</span><span id="line-136"></span><span>        </span><span id="local-6989586621679262327"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262327"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; Operand -&gt; Operand -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; Operand -&gt; Operand -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.GMP.html#mpzGetStr"><span class="hs-identifier hs-var">mpzGetStr</span></a></span><span>
</span><span id="line-137"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; Operand) -&gt; Constant -&gt; Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Constant
</span><span class="hs-identifier hs-var">Null</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Constant) -&gt; Type -&gt; Constant
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#ptrOf"><span class="hs-identifier hs-var">ptrOf</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#i8"><span class="hs-identifier hs-var">i8</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-138"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; Operand) -&gt; Constant -&gt; Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Integer -&gt; Constant
</span><span class="hs-identifier hs-var">Int</span></span><span> </span><span class="annot"><span class="annottext">Word32
forall a. Num a =&gt; a
</span><a href="Hachi.Compiler.Platform.html#platformIntSize"><span class="hs-identifier hs-var">platformIntSize</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">10</span></span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>            </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262328"><span class="hs-identifier hs-var">addr</span></a></span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span>        </span><span class="hs-comment">-- use printf to pretty-print it</span><span>
</span><span id="line-142"></span><span>        </span><span class="annot"><span class="annottext">m Operand -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m Operand -&gt; m ()) -&gt; m Operand -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#printf"><span class="hs-identifier hs-var">printf</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#strFormatRef"><span class="hs-identifier hs-var">strFormatRef</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262327"><span class="hs-identifier hs-var">str</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679262313"><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#CompileConstant"><span class="hs-identifier hs-type">CompileConstant</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-145"></span><span>    </span><span id="local-6989586621679262310"><span class="annot"><span class="annottext">constantTypeId :: ConstantTy
</span><a href="#local-6989586621679262310"><span class="hs-identifier hs-var hs-var hs-var hs-var">constantTypeId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConstantTy
</span><a href="Hachi.Compiler.CodeGen.Monad.html#ConstByteString"><span class="hs-identifier hs-var">ConstByteString</span></a></span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span>    </span><span id="local-6989586621679262308"><span class="annot"><span class="annottext">compileConstant :: String -&gt; ByteString -&gt; m Constant
</span><a href="#local-6989586621679262308"><span class="hs-identifier hs-var hs-var hs-var hs-var">compileConstant</span></a></span></span><span> </span><span id="local-6989586621679262307"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262307"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679262306"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679262306"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-148"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262305"><span class="annot"><span class="annottext">size :: Int
</span><a href="#local-6989586621679262305"><span class="hs-identifier hs-var hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679262306"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-149"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262303"><span class="annot"><span class="annottext">bytes :: [Word8]
</span><a href="#local-6989586621679262303"><span class="hs-identifier hs-var hs-var">bytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [Word8]
</span><span class="hs-identifier hs-var">BS.unpack</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679262306"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-150"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262301"><span class="annot"><span class="annottext">arr :: Constant
</span><a href="#local-6989586621679262301"><span class="hs-identifier hs-var hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Constant] -&gt; Constant
</span><span class="hs-identifier hs-var">Array</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#i8"><span class="hs-identifier hs-var">i8</span></a></span><span> </span><span class="annot"><span class="annottext">([Constant] -&gt; Constant) -&gt; [Constant] -&gt; Constant
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Word8 -&gt; Constant) -&gt; [Word8] -&gt; [Constant]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; Integer -&gt; Constant
</span><span class="hs-identifier hs-var">Int</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">8</span></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Constant) -&gt; (Word8 -&gt; Integer) -&gt; Word8 -&gt; Constant
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Integer
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Word8]
</span><a href="#local-6989586621679262303"><span class="hs-identifier hs-var">bytes</span></a></span><span>
</span><span id="line-151"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262298"><span class="annot"><span class="annottext">arrTy :: Type
</span><a href="#local-6989586621679262298"><span class="hs-identifier hs-var hs-var">arrTy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Type -&gt; Type
</span><span class="hs-identifier hs-var">ArrayType</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679262305"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#i8"><span class="hs-identifier hs-var">i8</span></a></span><span>
</span><span id="line-152"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262296"><span class="annot"><span class="annottext">arrName :: Name
</span><a href="#local-6989586621679262296"><span class="hs-identifier hs-var hs-var">arrName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">mkName</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Name) -&gt; String -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262307"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_data&quot;</span></span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span>        </span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Type -&gt; Constant -&gt; (Global -&gt; Global) -&gt; m Operand
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Name -&gt; Type -&gt; Constant -&gt; (Global -&gt; Global) -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#global"><span class="hs-identifier hs-var">global</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679262296"><span class="hs-identifier hs-var">arrName</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679262298"><span class="hs-identifier hs-var">arrTy</span></a></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262301"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">((Global -&gt; Global) -&gt; m Operand)
-&gt; (Global -&gt; Global) -&gt; m Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Linkage -&gt; Global -&gt; Global
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#setLinkage"><span class="hs-identifier hs-var">setLinkage</span></a></span><span> </span><span class="annot"><span class="annottext">Linkage
</span><span class="hs-identifier hs-var">Private</span></span><span>
</span><span id="line-155"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262295"><span class="annot"><span class="annottext">dataRef :: Constant
</span><a href="#local-6989586621679262295"><span class="hs-identifier hs-var hs-var">dataRef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Name -&gt; Constant
</span><span class="hs-identifier hs-var">GlobalReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#ptrOf"><span class="hs-identifier hs-var">ptrOf</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679262298"><span class="hs-identifier hs-var">arrTy</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679262296"><span class="hs-identifier hs-var">arrName</span></a></span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262294"><span class="annot"><span class="annottext">bsVal :: Constant
</span><a href="#local-6989586621679262294"><span class="hs-identifier hs-var hs-var">bsVal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Name -&gt; Bool -&gt; [Constant] -&gt; Constant
</span><span class="hs-identifier hs-var">Struct</span></span><span> </span><span class="annot"><span class="annottext">Maybe Name
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word32 -&gt; Integer -&gt; Constant
</span><span class="hs-identifier hs-var">Int</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">64</span></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Constant) -&gt; Integer -&gt; Constant
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Integer
forall a. Integral a =&gt; a -&gt; Integer
</span><span class="hs-identifier hs-var">toInteger</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679262305"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262295"><span class="hs-identifier hs-var">dataRef</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span>        </span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Type -&gt; Constant -&gt; (Global -&gt; Global) -&gt; m Operand
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Name -&gt; Type -&gt; Constant -&gt; (Global -&gt; Global) -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#global"><span class="hs-identifier hs-var">global</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">mkName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262307"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#bytestringTy"><span class="hs-identifier hs-var">bytestringTy</span></a></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262294"><span class="hs-identifier hs-var">bsVal</span></a></span><span> </span><span class="annot"><span class="annottext">((Global -&gt; Global) -&gt; m Operand)
-&gt; (Global -&gt; Global) -&gt; m Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Linkage -&gt; Global -&gt; Global
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#setLinkage"><span class="hs-identifier hs-var">setLinkage</span></a></span><span> </span><span class="annot"><span class="annottext">Linkage
</span><span class="hs-identifier hs-var">Private</span></span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span>        </span><span class="annot"><span class="annottext">Constant -&gt; m Constant
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; m Constant) -&gt; Constant -&gt; m Constant
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Name -&gt; Constant
</span><span class="hs-identifier hs-var">GlobalReference</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#bytestringTyPtr"><span class="hs-identifier hs-var">bytestringTyPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">mkName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262307"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span>    </span><span id="local-6989586621679262290"><span class="annot"><span class="annottext">compileLoadConstant :: ClosurePtr k -&gt; m Operand
</span><a href="#local-6989586621679262290"><span class="hs-identifier hs-var hs-var hs-var hs-var">compileLoadConstant</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#loadFromClosure"><span class="hs-identifier hs-var">loadFromClosure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; ClosureComponent
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureFreeVar"><span class="hs-identifier hs-var">ClosureFreeVar</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#bytestringTyPtr"><span class="hs-identifier hs-var">bytestringTyPtr</span></a></span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span>    </span><span id="local-6989586621679262289"><span class="annot"><span class="annottext">compilePrintBody :: String -&gt; ClosurePtr k -&gt; m ()
</span><a href="#local-6989586621679262289"><span class="hs-identifier hs-var hs-var hs-var hs-var">compilePrintBody</span></a></span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679262288"><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679262288"><span class="hs-identifier hs-var">this</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-166"></span><span>        </span><span id="local-6989586621679262287"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262287"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ClosurePtr k -&gt; m Operand
forall a (m :: * -&gt; *) (k :: PtrKind).
(CompileConstant a, MonadCodeGen m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileLoadConstant"><span class="hs-identifier hs-var">compileLoadConstant</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span> </span><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679262288"><span class="hs-identifier hs-var">this</span></a></span><span>
</span><span id="line-167"></span><span>        </span><span class="annot"><span class="annottext">Operand -&gt; m ()
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m) =&gt;
Operand -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Constant.ByteString.html#bsPrint"><span class="hs-identifier hs-var">bsPrint</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262287"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679262282"><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#CompileConstant"><span class="hs-identifier hs-type">CompileConstant</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-170"></span><span>    </span><span id="local-6989586621679262279"><span class="annot"><span class="annottext">constantTypeId :: ConstantTy
</span><a href="#local-6989586621679262279"><span class="hs-identifier hs-var hs-var hs-var hs-var">constantTypeId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConstantTy
</span><a href="Hachi.Compiler.CodeGen.Monad.html#ConstText"><span class="hs-identifier hs-var">ConstText</span></a></span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span>    </span><span id="local-6989586621679262277"><span class="annot"><span class="annottext">compileConstant :: String -&gt; Text -&gt; m Constant
</span><a href="#local-6989586621679262277"><span class="hs-identifier hs-var hs-var hs-var hs-var">compileConstant</span></a></span></span><span> </span><span id="local-6989586621679262276"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262276"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679262275"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679262275"><span class="hs-identifier hs-var">txt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-173"></span><span>        </span><span class="hs-comment">-- Text is strict, packed UTF-16</span><span>
</span><span id="line-174"></span><span>        </span><span class="hs-comment">-- we convert it to UTF-8 here since that is easier for us to work with</span><span>
</span><span id="line-175"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262274"><span class="annot"><span class="annottext">bd :: [Word8]
</span><a href="#local-6989586621679262274"><span class="hs-identifier hs-var hs-var">bd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [Word8]
</span><span class="hs-identifier hs-var">BS.unpack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; ByteString
</span><span class="hs-identifier hs-var">encodeUtf8</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679262275"><span class="hs-identifier hs-var">txt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Word8] -&gt; [Word8] -&gt; [Word8]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span>
</span><span id="line-176"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262273"><span class="annot"><span class="annottext">arr :: Constant
</span><a href="#local-6989586621679262273"><span class="hs-identifier hs-var hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Constant] -&gt; Constant
</span><span class="hs-identifier hs-var">Array</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#i8"><span class="hs-identifier hs-var">i8</span></a></span><span> </span><span class="annot"><span class="annottext">([Constant] -&gt; Constant) -&gt; [Constant] -&gt; Constant
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Word8 -&gt; Constant) -&gt; [Word8] -&gt; [Constant]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; Integer -&gt; Constant
</span><span class="hs-identifier hs-var">Int</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">8</span></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Constant) -&gt; (Word8 -&gt; Integer) -&gt; Word8 -&gt; Constant
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Integer
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Word8]
</span><a href="#local-6989586621679262274"><span class="hs-identifier hs-var">bd</span></a></span><span>
</span><span id="line-177"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262272"><span class="annot"><span class="annottext">arrTy :: Type
</span><a href="#local-6989586621679262272"><span class="hs-identifier hs-var hs-var">arrTy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Type -&gt; Type
</span><span class="hs-identifier hs-var">ArrayType</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Word8] -&gt; Word64
forall i a. Num i =&gt; [a] -&gt; i
</span><span class="hs-identifier hs-var">genericLength</span></span><span> </span><span class="annot"><span class="annottext">[Word8]
</span><a href="#local-6989586621679262274"><span class="hs-identifier hs-var">bd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#i8"><span class="hs-identifier hs-var">i8</span></a></span><span>
</span><span id="line-178"></span><span>
</span><span id="line-179"></span><span>        </span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Type -&gt; Constant -&gt; (Global -&gt; Global) -&gt; m Operand
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Name -&gt; Type -&gt; Constant -&gt; (Global -&gt; Global) -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#global"><span class="hs-identifier hs-var">global</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">mkName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262276"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679262272"><span class="hs-identifier hs-var">arrTy</span></a></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262273"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">((Global -&gt; Global) -&gt; m Operand)
-&gt; (Global -&gt; Global) -&gt; m Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Linkage -&gt; Global -&gt; Global
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#setLinkage"><span class="hs-identifier hs-var">setLinkage</span></a></span><span> </span><span class="annot"><span class="annottext">Linkage
</span><span class="hs-identifier hs-var">Private</span></span><span>
</span><span id="line-180"></span><span>        </span><span class="annot"><span class="annottext">Constant -&gt; m Constant
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; m Constant) -&gt; Constant -&gt; m Constant
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Name -&gt; Constant
</span><span class="hs-identifier hs-var">GlobalReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#ptrOf"><span class="hs-identifier hs-var">ptrOf</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679262272"><span class="hs-identifier hs-var">arrTy</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">mkName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262276"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span>    </span><span id="local-6989586621679262270"><span class="annot"><span class="annottext">compileLoadConstant :: ClosurePtr k -&gt; m Operand
</span><a href="#local-6989586621679262270"><span class="hs-identifier hs-var hs-var hs-var hs-var">compileLoadConstant</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#loadFromClosure"><span class="hs-identifier hs-var">loadFromClosure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; ClosureComponent
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureFreeVar"><span class="hs-identifier hs-var">ClosureFreeVar</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#ptrOf"><span class="hs-identifier hs-var">ptrOf</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#i8"><span class="hs-identifier hs-var">i8</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span>    </span><span id="local-6989586621679262269"><span class="annot"><span class="annottext">compilePrintBody :: String -&gt; ClosurePtr k -&gt; m ()
</span><a href="#local-6989586621679262269"><span class="hs-identifier hs-var hs-var hs-var hs-var">compilePrintBody</span></a></span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679262268"><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679262268"><span class="hs-identifier hs-var">this</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-185"></span><span>        </span><span id="local-6989586621679262267"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262267"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ClosurePtr k -&gt; m Operand
forall a (m :: * -&gt; *) (k :: PtrKind).
(CompileConstant a, MonadCodeGen m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileLoadConstant"><span class="hs-identifier hs-var">compileLoadConstant</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679262268"><span class="hs-identifier hs-var">this</span></a></span><span>
</span><span id="line-186"></span><span>        </span><span class="annot"><span class="annottext">m Operand -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m Operand -&gt; m ()) -&gt; m Operand -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#printf"><span class="hs-identifier hs-var">printf</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#strFormatRef"><span class="hs-identifier hs-var">strFormatRef</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262267"><span class="hs-identifier hs-var">ptr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-187"></span><span>
</span><span id="line-188"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#CompileConstant"><span class="hs-identifier hs-type">CompileConstant</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-189"></span><span>    </span><span id="local-6989586621679262261"><span class="annot"><span class="annottext">constantTypeId :: ConstantTy
</span><a href="#local-6989586621679262261"><span class="hs-identifier hs-var hs-var hs-var hs-var">constantTypeId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConstantTy
</span><a href="Hachi.Compiler.CodeGen.Monad.html#ConstUnit"><span class="hs-identifier hs-var">ConstUnit</span></a></span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span>    </span><span id="local-6989586621679262259"><span class="annot"><span class="annottext">compileConstant :: String -&gt; () -&gt; m Constant
</span><a href="#local-6989586621679262259"><span class="hs-identifier hs-var hs-var hs-var hs-var">compileConstant</span></a></span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-192"></span><span>        </span><span class="annot"><span class="annottext">Constant -&gt; m Constant
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; m Constant) -&gt; Constant -&gt; m Constant
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Constant -&gt; Type -&gt; Constant
</span><span class="hs-identifier hs-var">C.IntToPtr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; Integer -&gt; Constant
</span><span class="hs-identifier hs-var">Int</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#ptrOf"><span class="hs-identifier hs-var">ptrOf</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#i8"><span class="hs-identifier hs-var">i8</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>
</span><span id="line-194"></span><span>    </span><span id="local-6989586621679262257"><span class="annot"><span class="annottext">castConstantToPtr :: Operand -&gt; m Operand
</span><a href="#local-6989586621679262257"><span class="hs-identifier hs-var hs-var hs-var hs-var">castConstantToPtr</span></a></span></span><span> </span><span id="local-6989586621679262256"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262256"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; Type -&gt; m Operand
forall (m :: * -&gt; *).
MonadIRBuilder m =&gt;
Operand -&gt; Type -&gt; m Operand
</span><span class="hs-identifier hs-var">inttoptr</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262256"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#ptrOf"><span class="hs-identifier hs-var">ptrOf</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#i8"><span class="hs-identifier hs-var">i8</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span>    </span><span id="local-6989586621679262254"><span class="annot"><span class="annottext">compileLoadConstant :: ClosurePtr k -&gt; m Operand
</span><a href="#local-6989586621679262254"><span class="hs-identifier hs-var hs-var hs-var hs-var">compileLoadConstant</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#loadFromClosure"><span class="hs-identifier hs-var">loadFromClosure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; ClosureComponent
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureFreeVar"><span class="hs-identifier hs-var">ClosureFreeVar</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#i1"><span class="hs-identifier hs-var">i1</span></a></span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span>    </span><span id="local-6989586621679262252"><span class="annot"><span class="annottext">compilePrintBody :: String -&gt; ClosurePtr k -&gt; m ()
</span><a href="#local-6989586621679262252"><span class="hs-identifier hs-var hs-var hs-var hs-var">compilePrintBody</span></a></span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ClosurePtr k
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-199"></span><span>        </span><span class="annot"><span class="annottext">m Operand -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m Operand -&gt; m ()) -&gt; m Operand -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#printf"><span class="hs-identifier hs-var">printf</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#unitRef"><span class="hs-identifier hs-var">unitRef</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#CompileConstant"><span class="hs-identifier hs-type">CompileConstant</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-202"></span><span>    </span><span id="local-6989586621679262245"><span class="annot"><span class="annottext">constantTypeId :: ConstantTy
</span><a href="#local-6989586621679262245"><span class="hs-identifier hs-var hs-var hs-var hs-var">constantTypeId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConstantTy
</span><a href="Hachi.Compiler.CodeGen.Monad.html#ConstBool"><span class="hs-identifier hs-var">ConstBool</span></a></span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span>    </span><span class="hs-comment">-- we can just stick the boolean value directly into the closure</span><span>
</span><span id="line-205"></span><span>    </span><span id="local-6989586621679262243"><span class="annot"><span class="annottext">compileConstant :: String -&gt; Bool -&gt; m Constant
</span><a href="#local-6989586621679262243"><span class="hs-identifier hs-var hs-var hs-var hs-var">compileConstant</span></a></span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679262242"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679262242"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-206"></span><span>        </span><span class="annot"><span class="annottext">Constant -&gt; m Constant
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; m Constant) -&gt; Constant -&gt; m Constant
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Constant -&gt; Type -&gt; Constant
</span><span class="hs-identifier hs-var">C.IntToPtr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; Integer -&gt; Constant
</span><span class="hs-identifier hs-var">Int</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Constant) -&gt; Integer -&gt; Constant
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Integer
forall a. Integral a =&gt; a -&gt; Integer
</span><span class="hs-identifier hs-var">toInteger</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Integer) -&gt; Int -&gt; Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Int
forall a. Enum a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">fromEnum</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679262242"><span class="hs-identifier hs-var">val</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#ptrOf"><span class="hs-identifier hs-var">ptrOf</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#i8"><span class="hs-identifier hs-var">i8</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span>    </span><span id="local-6989586621679262240"><span class="annot"><span class="annottext">castConstantToPtr :: Operand -&gt; m Operand
</span><a href="#local-6989586621679262240"><span class="hs-identifier hs-var hs-var hs-var hs-var">castConstantToPtr</span></a></span></span><span> </span><span id="local-6989586621679262239"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262239"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; Type -&gt; m Operand
forall (m :: * -&gt; *).
MonadIRBuilder m =&gt;
Operand -&gt; Type -&gt; m Operand
</span><span class="hs-identifier hs-var">inttoptr</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262239"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#ptrOf"><span class="hs-identifier hs-var">ptrOf</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#i8"><span class="hs-identifier hs-var">i8</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span>    </span><span class="hs-comment">-- retrieve the boolean value from the closure directly</span><span>
</span><span id="line-211"></span><span>    </span><span id="local-6989586621679262238"><span class="annot"><span class="annottext">compileLoadConstant :: ClosurePtr k -&gt; m Operand
</span><a href="#local-6989586621679262238"><span class="hs-identifier hs-var hs-var hs-var hs-var">compileLoadConstant</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#loadFromClosure"><span class="hs-identifier hs-var">loadFromClosure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; ClosureComponent
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureFreeVar"><span class="hs-identifier hs-var">ClosureFreeVar</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#i1"><span class="hs-identifier hs-var">i1</span></a></span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span>    </span><span id="local-6989586621679262237"><span class="annot"><span class="annottext">compilePrintBody :: String -&gt; ClosurePtr k -&gt; m ()
</span><a href="#local-6989586621679262237"><span class="hs-identifier hs-var hs-var hs-var hs-var">compilePrintBody</span></a></span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679262236"><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679262236"><span class="hs-identifier hs-var">this</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-214"></span><span>        </span><span class="hs-comment">-- load the bit value from the closure</span><span>
</span><span id="line-215"></span><span>        </span><span id="local-6989586621679262235"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262235"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ClosurePtr k -&gt; m Operand
forall a (m :: * -&gt; *) (k :: PtrKind).
(CompileConstant a, MonadCodeGen m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileLoadConstant"><span class="hs-identifier hs-var">compileLoadConstant</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679262236"><span class="hs-identifier hs-var">this</span></a></span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span>        </span><span class="hs-comment">-- check whether it is 0, which we treat as False, while any other</span><span>
</span><span id="line-218"></span><span>        </span><span class="hs-comment">-- value should be treated as True; depending on this test,</span><span>
</span><span id="line-219"></span><span>        </span><span class="hs-comment">-- select the correct string pointer for pretty-printing</span><span>
</span><span id="line-220"></span><span>        </span><span id="local-6989586621679262234"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262234"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IntegerPredicate -&gt; Operand -&gt; Operand -&gt; m Operand
forall (m :: * -&gt; *).
MonadIRBuilder m =&gt;
IntegerPredicate -&gt; Operand -&gt; Operand -&gt; m Operand
</span><span class="hs-identifier hs-var">icmp</span></span><span> </span><span class="annot"><span class="annottext">IntegerPredicate
</span><span class="hs-identifier hs-var">LLVM.EQ</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262235"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; Operand) -&gt; Constant -&gt; Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Integer -&gt; Constant
</span><span class="hs-identifier hs-var">Int</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>        </span><span id="local-6989586621679262231"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262231"><span class="hs-identifier hs-var">bstr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; Operand -&gt; Operand -&gt; m Operand
forall (m :: * -&gt; *).
(HasCallStack, MonadIRBuilder m, MonadModuleBuilder m) =&gt;
Operand -&gt; Operand -&gt; Operand -&gt; m Operand
</span><span class="hs-identifier hs-var">select</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262234"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#falseRef"><span class="hs-identifier hs-var">falseRef</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#trueRef"><span class="hs-identifier hs-var">trueRef</span></a></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span>        </span><span class="annot"><span class="annottext">m Operand -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m Operand -&gt; m ()) -&gt; m Operand -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#printf"><span class="hs-identifier hs-var">printf</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#strFormatRef"><span class="hs-identifier hs-var">strFormatRef</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262231"><span class="hs-identifier hs-var">bstr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span class="hs-comment">-- | `compileDataConstant` @tag fieldName name value extraArgs@ generates a</span><span>
</span><span id="line-226"></span><span class="hs-comment">-- static data constant named @name@ of kind @tag@. The provided @value@ is</span><span>
</span><span id="line-227"></span><span class="hs-comment">-- compiled to another static constant and stored as argument to the data</span><span>
</span><span id="line-228"></span><span class="hs-comment">-- constant, using a name derived from @fieldName@. For `DataConstr`,</span><span>
</span><span id="line-229"></span><span class="hs-comment">-- @extra@ may include an additional argument.</span><span>
</span><span id="line-230"></span><span id="local-6989586621679262468"><span id="local-6989586621679262469"><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#compileDataConstant"><span class="hs-identifier hs-type">compileDataConstant</span></a></span><span>
</span><span id="line-231"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#MonadCodeGen"><span class="hs-identifier hs-type">MonadCodeGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262469"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679262469"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#CompileConstant"><span class="hs-identifier hs-type">CompileConstant</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262468"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.Data.html#DataTag"><span class="hs-identifier hs-type">DataTag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262468"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integer</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262469"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Constant</span></span></span></span><span>
</span><span id="line-233"></span><span id="compileDataConstant"><span class="annot"><span class="annottext">compileDataConstant :: DataTag -&gt; String -&gt; String -&gt; a -&gt; Maybe Integer -&gt; m Constant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileDataConstant"><span class="hs-identifier hs-var hs-var">compileDataConstant</span></a></span></span><span> </span><span id="local-6989586621679262226"><span class="annot"><span class="annottext">DataTag
</span><a href="#local-6989586621679262226"><span class="hs-identifier hs-var">tag</span></a></span></span><span> </span><span id="local-6989586621679262225"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262225"><span class="hs-identifier hs-var">fieldName</span></a></span></span><span> </span><span id="local-6989586621679262224"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262224"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679262223"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679262223"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span id="local-6989586621679262222"><span class="annot"><span class="annottext">Maybe Integer
</span><a href="#local-6989586621679262222"><span class="hs-identifier hs-var">extra</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-234"></span><span>    </span><span id="local-6989586621679262221"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262221"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; a -&gt; m Constant
forall (m :: * -&gt; *) a.
(MonadCodeGen m, MonadIRBuilder m, CompileConstant a) =&gt;
String -&gt; a -&gt; m Constant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileSubConstant"><span class="hs-identifier hs-var">compileSubConstant</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262225"><span class="hs-identifier hs-var">fieldName</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679262223"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span>    </span><span id="local-6989586621679262220"><span class="annot"><span class="annottext">Maybe Constant
</span><a href="#local-6989586621679262220"><span class="hs-identifier hs-var">mRef</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe Integer -&gt; (Integer -&gt; m Constant) -&gt; m (Maybe Constant)
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">Maybe Integer
</span><a href="#local-6989586621679262222"><span class="hs-identifier hs-var">extra</span></a></span><span> </span><span class="annot"><span class="annottext">((Integer -&gt; m Constant) -&gt; m (Maybe Constant))
-&gt; (Integer -&gt; m Constant) -&gt; m (Maybe Constant)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679262218"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679262218"><span class="hs-identifier hs-var">constrTag</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-237"></span><span>        </span><span id="local-6989586621679262217"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262217"><span class="hs-identifier hs-var">tagName</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; m String
forall (m :: * -&gt; *).
(MonadReader CodeGenSt m, MonadIO m) =&gt;
String -&gt; m String
</span><a href="Hachi.Compiler.CodeGen.Monad.html#mkFresh"><span class="hs-identifier hs-var">mkFresh</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tag&quot;</span></span><span>
</span><span id="line-238"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; Integer -&gt; m Constant
forall (m :: * -&gt; *) a.
(MonadCodeGen m, MonadIRBuilder m, CompileConstant a) =&gt;
String -&gt; a -&gt; m Constant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileSubConstant"><span class="hs-identifier hs-var">compileSubConstant</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262217"><span class="hs-identifier hs-var">tagName</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679262218"><span class="hs-identifier hs-var">constrTag</span></a></span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span>    </span><span class="annot"><span class="annottext">Name -&gt; DataTag -&gt; [Constant] -&gt; m Constant
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Name -&gt; DataTag -&gt; [Constant] -&gt; m Constant
</span><a href="Hachi.Compiler.CodeGen.Constant.Data.html#dataGlobal"><span class="hs-identifier hs-var">dataGlobal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">mkName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262224"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DataTag
</span><a href="#local-6989586621679262226"><span class="hs-identifier hs-var">tag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262221"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Constant -&gt; [Constant] -&gt; [Constant]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Constant]
-&gt; (Constant -&gt; [Constant]) -&gt; Maybe Constant -&gt; [Constant]
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Constant -&gt; [Constant]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe Constant
</span><a href="#local-6989586621679262220"><span class="hs-identifier hs-var">mRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679262211"><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#CompileConstant"><span class="hs-identifier hs-type">CompileConstant</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PLC.Data</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-243"></span><span>    </span><span id="local-6989586621679262208"><span class="annot"><span class="annottext">constantTypeId :: ConstantTy
</span><a href="#local-6989586621679262208"><span class="hs-identifier hs-var hs-var hs-var hs-var">constantTypeId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConstantTy
</span><a href="Hachi.Compiler.CodeGen.Monad.html#ConstData"><span class="hs-identifier hs-var">ConstData</span></a></span><span>
</span><span id="line-244"></span><span>
</span><span id="line-245"></span><span>    </span><span id="local-6989586621679262206"><span class="annot"><span class="annottext">compileConstant :: String -&gt; Data -&gt; m Constant
</span><a href="#local-6989586621679262206"><span class="hs-identifier hs-var hs-var hs-var hs-var">compileConstant</span></a></span></span><span> </span><span id="local-6989586621679262205"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262205"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Constr</span></span><span> </span><span id="local-6989586621679262203"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679262203"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679262202"><span class="annot"><span class="annottext">[Data]
</span><a href="#local-6989586621679262202"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-246"></span><span>        </span><span class="annot"><span class="annottext">DataTag
-&gt; String -&gt; String -&gt; [Data] -&gt; Maybe Integer -&gt; m Constant
forall (m :: * -&gt; *) a.
(MonadCodeGen m, MonadIRBuilder m, CompileConstant a) =&gt;
DataTag -&gt; String -&gt; String -&gt; a -&gt; Maybe Integer -&gt; m Constant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileDataConstant"><span class="hs-identifier hs-var">compileDataConstant</span></a></span><span> </span><span class="annot"><span class="annottext">DataTag
</span><a href="Hachi.Compiler.CodeGen.Constant.Data.html#DataConstr"><span class="hs-identifier hs-var">DataConstr</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;constr_list&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262205"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[Data]
</span><a href="#local-6989586621679262202"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Maybe Integer
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679262203"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstant"><span class="hs-identifier hs-var">compileConstant</span></a></span><span> </span><span id="local-6989586621679262200"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262200"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span id="local-6989586621679262198"><span class="annot"><span class="annottext">[(Data, Data)]
</span><a href="#local-6989586621679262198"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-248"></span><span>        </span><span class="annot"><span class="annottext">DataTag
-&gt; String
-&gt; String
-&gt; [(Data, Data)]
-&gt; Maybe Integer
-&gt; m Constant
forall (m :: * -&gt; *) a.
(MonadCodeGen m, MonadIRBuilder m, CompileConstant a) =&gt;
DataTag -&gt; String -&gt; String -&gt; a -&gt; Maybe Integer -&gt; m Constant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileDataConstant"><span class="hs-identifier hs-var">compileDataConstant</span></a></span><span> </span><span class="annot"><span class="annottext">DataTag
</span><a href="Hachi.Compiler.CodeGen.Constant.Data.html#DataMap"><span class="hs-identifier hs-var">DataMap</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;map_list&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262200"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[(Data, Data)]
</span><a href="#local-6989586621679262198"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Integer
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-249"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstant"><span class="hs-identifier hs-var">compileConstant</span></a></span><span> </span><span id="local-6989586621679262196"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262196"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">List</span></span><span> </span><span id="local-6989586621679262194"><span class="annot"><span class="annottext">[Data]
</span><a href="#local-6989586621679262194"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-250"></span><span>        </span><span class="annot"><span class="annottext">DataTag
-&gt; String -&gt; String -&gt; [Data] -&gt; Maybe Integer -&gt; m Constant
forall (m :: * -&gt; *) a.
(MonadCodeGen m, MonadIRBuilder m, CompileConstant a) =&gt;
DataTag -&gt; String -&gt; String -&gt; a -&gt; Maybe Integer -&gt; m Constant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileDataConstant"><span class="hs-identifier hs-var">compileDataConstant</span></a></span><span> </span><span class="annot"><span class="annottext">DataTag
</span><a href="Hachi.Compiler.CodeGen.Constant.Data.html#DataList"><span class="hs-identifier hs-var">DataList</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;list_list&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262196"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[Data]
</span><a href="#local-6989586621679262194"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Integer
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-251"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstant"><span class="hs-identifier hs-var">compileConstant</span></a></span><span> </span><span id="local-6989586621679262192"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262192"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">I</span></span><span> </span><span id="local-6989586621679262190"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679262190"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-252"></span><span>        </span><span class="annot"><span class="annottext">DataTag
-&gt; String -&gt; String -&gt; Integer -&gt; Maybe Integer -&gt; m Constant
forall (m :: * -&gt; *) a.
(MonadCodeGen m, MonadIRBuilder m, CompileConstant a) =&gt;
DataTag -&gt; String -&gt; String -&gt; a -&gt; Maybe Integer -&gt; m Constant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileDataConstant"><span class="hs-identifier hs-var">compileDataConstant</span></a></span><span> </span><span class="annot"><span class="annottext">DataTag
</span><a href="Hachi.Compiler.CodeGen.Constant.Data.html#DataI"><span class="hs-identifier hs-var">DataI</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i_integer&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262192"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679262190"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Integer
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-253"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstant"><span class="hs-identifier hs-var">compileConstant</span></a></span><span> </span><span id="local-6989586621679262188"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262188"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">B</span></span><span> </span><span id="local-6989586621679262186"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679262186"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-254"></span><span>        </span><span class="annot"><span class="annottext">DataTag
-&gt; String -&gt; String -&gt; ByteString -&gt; Maybe Integer -&gt; m Constant
forall (m :: * -&gt; *) a.
(MonadCodeGen m, MonadIRBuilder m, CompileConstant a) =&gt;
DataTag -&gt; String -&gt; String -&gt; a -&gt; Maybe Integer -&gt; m Constant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileDataConstant"><span class="hs-identifier hs-var">compileDataConstant</span></a></span><span> </span><span class="annot"><span class="annottext">DataTag
</span><a href="Hachi.Compiler.CodeGen.Constant.Data.html#DataB"><span class="hs-identifier hs-var">DataB</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;b_bytestring&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262188"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679262186"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Integer
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-255"></span><span>
</span><span id="line-256"></span><span>    </span><span id="local-6989586621679262184"><span class="annot"><span class="annottext">compileLoadConstant :: ClosurePtr k -&gt; m Operand
</span><a href="#local-6989586621679262184"><span class="hs-identifier hs-var hs-var hs-var hs-var">compileLoadConstant</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#loadFromClosure"><span class="hs-identifier hs-var">loadFromClosure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; ClosureComponent
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureFreeVar"><span class="hs-identifier hs-var">ClosureFreeVar</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#dataTyPtr"><span class="hs-identifier hs-var">dataTyPtr</span></a></span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span>    </span><span id="local-6989586621679262182"><span class="annot"><span class="annottext">compilePrintBody :: String -&gt; ClosurePtr k -&gt; m ()
</span><a href="#local-6989586621679262182"><span class="hs-identifier hs-var hs-var hs-var hs-var">compilePrintBody</span></a></span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679262181"><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679262181"><span class="hs-identifier hs-var">this</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-259"></span><span>        </span><span class="hs-comment">-- retrieve the pointer to the data structure from the closure</span><span>
</span><span id="line-260"></span><span>        </span><span id="local-6989586621679262180"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262180"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ClosurePtr k -&gt; m Operand
forall a (m :: * -&gt; *) (k :: PtrKind).
(CompileConstant a, MonadCodeGen m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileLoadConstant"><span class="hs-identifier hs-var">compileLoadConstant</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">Data</span></span><span> </span><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679262181"><span class="hs-identifier hs-var">this</span></a></span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262179"><span class="annot"><span class="annottext">handleCase :: Operand -&gt; m ()
</span><a href="#local-6989586621679262179"><span class="hs-identifier hs-var hs-var">handleCase</span></a></span></span><span> </span><span id="local-6989586621679262178"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262178"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-263"></span><span>                </span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#printf"><span class="hs-identifier hs-var">printf</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262178"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-264"></span><span>                </span><span id="local-6989586621679262177"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679262177"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Constant.Data.html#loadDataPtr"><span class="hs-identifier hs-var">loadDataPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262180"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-265"></span><span>                </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; m ()
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadFail m, MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Closure.html#printClosure"><span class="hs-identifier hs-var">printClosure</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679262177"><span class="hs-identifier hs-var">cls</span></a></span><span>
</span><span id="line-266"></span><span>                </span><span class="annot"><span class="annottext">m ()
forall (m :: * -&gt; *). MonadIRBuilder m =&gt; m ()
</span><span class="hs-identifier hs-var">retVoid</span></span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span>        </span><span class="hs-comment">-- depending on the constructor tag, use the relevant pretty-printer</span><span>
</span><span id="line-269"></span><span>        </span><span class="annot"><span class="annottext">Operand -&gt; (DataTag -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; (DataTag -&gt; m ()) -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Constant.Data.html#withDataTag"><span class="hs-identifier hs-var">withDataTag</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262180"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">((DataTag -&gt; m ()) -&gt; m ()) -&gt; (DataTag -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-270"></span><span>            </span><span class="annot"><span class="annottext">DataTag
</span><a href="Hachi.Compiler.CodeGen.Constant.Data.html#DataConstr"><span class="hs-identifier hs-var">DataConstr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-271"></span><span>                </span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#printf"><span class="hs-identifier hs-var">printf</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#dataConstrRef"><span class="hs-identifier hs-var">dataConstrRef</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-272"></span><span>                </span><span id="local-6989586621679262171"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679262171"><span class="hs-identifier hs-var">tag</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Constant.Data.html#loadConstrTag"><span class="hs-identifier hs-var">loadConstrTag</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262180"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-273"></span><span>                </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; m ()
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadFail m, MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Closure.html#printClosure"><span class="hs-identifier hs-var">printClosure</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679262171"><span class="hs-identifier hs-var">tag</span></a></span><span>
</span><span id="line-274"></span><span>                </span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#printf"><span class="hs-identifier hs-var">printf</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#spaceRef"><span class="hs-identifier hs-var">spaceRef</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-275"></span><span>                </span><span id="local-6989586621679262168"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679262168"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Constant.Data.html#loadDataPtr"><span class="hs-identifier hs-var">loadDataPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262180"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-276"></span><span>                </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; m ()
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadFail m, MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Closure.html#printClosure"><span class="hs-identifier hs-var">printClosure</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679262168"><span class="hs-identifier hs-var">cls</span></a></span><span>
</span><span id="line-277"></span><span>                </span><span class="annot"><span class="annottext">m ()
forall (m :: * -&gt; *). MonadIRBuilder m =&gt; m ()
</span><span class="hs-identifier hs-var">retVoid</span></span><span>
</span><span id="line-278"></span><span>            </span><span class="annot"><span class="annottext">DataTag
</span><a href="Hachi.Compiler.CodeGen.Constant.Data.html#DataMap"><span class="hs-identifier hs-var">DataMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; m ()
</span><a href="#local-6989586621679262179"><span class="hs-identifier hs-var">handleCase</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#dataMapRef"><span class="hs-identifier hs-var">dataMapRef</span></a></span><span>
</span><span id="line-279"></span><span>            </span><span class="annot"><span class="annottext">DataTag
</span><a href="Hachi.Compiler.CodeGen.Constant.Data.html#DataList"><span class="hs-identifier hs-var">DataList</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; m ()
</span><a href="#local-6989586621679262179"><span class="hs-identifier hs-var">handleCase</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#dataListRef"><span class="hs-identifier hs-var">dataListRef</span></a></span><span>
</span><span id="line-280"></span><span>            </span><span class="annot"><span class="annottext">DataTag
</span><a href="Hachi.Compiler.CodeGen.Constant.Data.html#DataI"><span class="hs-identifier hs-var">DataI</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; m ()
</span><a href="#local-6989586621679262179"><span class="hs-identifier hs-var">handleCase</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#dataIntegerRef"><span class="hs-identifier hs-var">dataIntegerRef</span></a></span><span>
</span><span id="line-281"></span><span>            </span><span class="annot"><span class="annottext">DataTag
</span><a href="Hachi.Compiler.CodeGen.Constant.Data.html#DataB"><span class="hs-identifier hs-var">DataB</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; m ()
</span><a href="#local-6989586621679262179"><span class="hs-identifier hs-var">handleCase</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#dataByteStringRef"><span class="hs-identifier hs-var">dataByteStringRef</span></a></span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span id="local-6989586621679262162"><span id="local-6989586621679262163"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679262158"><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#CompileConstant"><span class="hs-identifier hs-type">CompileConstant</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262163"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#CompileConstant"><span class="hs-identifier hs-type">CompileConstant</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262162"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#CompileConstant"><span class="hs-identifier hs-type">CompileConstant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679262163"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621679262162"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-284"></span><span>    </span><span id="local-6989586621679262155"><span class="annot"><span class="annottext">constantTypeId :: ConstantTy
</span><a href="#local-6989586621679262155"><span class="hs-identifier hs-var hs-var hs-var hs-var">constantTypeId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConstantTy
</span><a href="Hachi.Compiler.CodeGen.Monad.html#ConstPair"><span class="hs-identifier hs-var">ConstPair</span></a></span><span>
</span><span id="line-285"></span><span>
</span><span id="line-286"></span><span>    </span><span id="local-6989586621679262153"><span class="annot"><span class="annottext">compileConstant :: String -&gt; (a, b) -&gt; m Constant
</span><a href="#local-6989586621679262153"><span class="hs-identifier hs-var hs-var hs-var hs-var">compileConstant</span></a></span></span><span> </span><span id="local-6989586621679262152"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262152"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679262151"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679262151"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679262150"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679262150"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-287"></span><span>        </span><span class="hs-comment">-- compile the two components to constant closures; the pair is then</span><span>
</span><span id="line-288"></span><span>        </span><span class="hs-comment">-- just two pointers to those closures; we need them as closures so</span><span>
</span><span id="line-289"></span><span>        </span><span class="hs-comment">-- that they can have their respective pretty-printing functions</span><span>
</span><span id="line-290"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262149"><span class="annot"><span class="annottext">fstName :: String
</span><a href="#local-6989586621679262149"><span class="hs-identifier hs-var hs-var">fstName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262152"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_fst&quot;</span></span><span>
</span><span id="line-291"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262148"><span class="annot"><span class="annottext">sndName :: String
</span><a href="#local-6989586621679262148"><span class="hs-identifier hs-var hs-var">sndName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262152"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_snd&quot;</span></span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span>        </span><span id="local-6989586621679262147"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262147"><span class="hs-identifier hs-var">xr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; a -&gt; m Constant
forall (m :: * -&gt; *) a.
(MonadCodeGen m, MonadIRBuilder m, CompileConstant a) =&gt;
String -&gt; a -&gt; m Constant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileSubConstant"><span class="hs-identifier hs-var">compileSubConstant</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262149"><span class="hs-identifier hs-var">fstName</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679262151"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-294"></span><span>        </span><span id="local-6989586621679262146"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262146"><span class="hs-identifier hs-var">yr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; b -&gt; m Constant
forall (m :: * -&gt; *) a.
(MonadCodeGen m, MonadIRBuilder m, CompileConstant a) =&gt;
String -&gt; a -&gt; m Constant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileSubConstant"><span class="hs-identifier hs-var">compileSubConstant</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262148"><span class="hs-identifier hs-var">sndName</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679262150"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-295"></span><span>
</span><span id="line-296"></span><span>        </span><span class="hs-comment">-- create a new global for the pair of pointer-sized values</span><span>
</span><span id="line-297"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262145"><span class="annot"><span class="annottext">pairVal :: Constant
</span><a href="#local-6989586621679262145"><span class="hs-identifier hs-var hs-var">pairVal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Name -&gt; Bool -&gt; [Constant] -&gt; Constant
</span><span class="hs-identifier hs-var">Struct</span></span><span> </span><span class="annot"><span class="annottext">Maybe Name
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262147"><span class="hs-identifier hs-var">xr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262146"><span class="hs-identifier hs-var">yr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-298"></span><span>        </span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Type -&gt; Constant -&gt; (Global -&gt; Global) -&gt; m Operand
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Name -&gt; Type -&gt; Constant -&gt; (Global -&gt; Global) -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#global"><span class="hs-identifier hs-var">global</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">mkName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262152"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#pairTy"><span class="hs-identifier hs-var">pairTy</span></a></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262145"><span class="hs-identifier hs-var">pairVal</span></a></span><span> </span><span class="annot"><span class="annottext">((Global -&gt; Global) -&gt; m Operand)
-&gt; (Global -&gt; Global) -&gt; m Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Linkage -&gt; Global -&gt; Global
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#setLinkage"><span class="hs-identifier hs-var">setLinkage</span></a></span><span> </span><span class="annot"><span class="annottext">Linkage
</span><span class="hs-identifier hs-var">Private</span></span><span>
</span><span id="line-299"></span><span>
</span><span id="line-300"></span><span>        </span><span class="hs-comment">-- return a reference to the global</span><span>
</span><span id="line-301"></span><span>        </span><span class="annot"><span class="annottext">Constant -&gt; m Constant
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; m Constant) -&gt; Constant -&gt; m Constant
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Name -&gt; Constant
</span><span class="hs-identifier hs-var">GlobalReference</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#pairTyPtr"><span class="hs-identifier hs-var">pairTyPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">mkName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262152"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-302"></span><span>
</span><span id="line-303"></span><span>    </span><span class="hs-comment">-- to load a pair, we just retrieve its pointer from the closure</span><span>
</span><span id="line-304"></span><span>    </span><span id="local-6989586621679262142"><span class="annot"><span class="annottext">compileLoadConstant :: ClosurePtr k -&gt; m Operand
</span><a href="#local-6989586621679262142"><span class="hs-identifier hs-var hs-var hs-var hs-var">compileLoadConstant</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#loadFromClosure"><span class="hs-identifier hs-var">loadFromClosure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; ClosureComponent
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureFreeVar"><span class="hs-identifier hs-var">ClosureFreeVar</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#pairTyPtr"><span class="hs-identifier hs-var">pairTyPtr</span></a></span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span>    </span><span id="local-6989586621679262141"><span class="annot"><span class="annottext">compilePrintBody :: String -&gt; ClosurePtr k -&gt; m ()
</span><a href="#local-6989586621679262141"><span class="hs-identifier hs-var hs-var hs-var hs-var">compilePrintBody</span></a></span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679262140"><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679262140"><span class="hs-identifier hs-var">this</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-307"></span><span>        </span><span class="hs-comment">-- retrieve the pointer to the pair</span><span>
</span><span id="line-308"></span><span>        </span><span id="local-6989586621679262139"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262139"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ClosurePtr k -&gt; m Operand
forall a (m :: * -&gt; *) (k :: PtrKind).
(CompileConstant a, MonadCodeGen m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileLoadConstant"><span class="hs-identifier hs-var">compileLoadConstant</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679262163"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621679262162"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679262140"><span class="hs-identifier hs-var">this</span></a></span><span>
</span><span id="line-309"></span><span>
</span><span id="line-310"></span><span>        </span><span class="hs-comment">-- print the opening bracket</span><span>
</span><span id="line-311"></span><span>        </span><span class="annot"><span class="annottext">m Operand -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m Operand -&gt; m ()) -&gt; m Operand -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#printf"><span class="hs-identifier hs-var">printf</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#openParenRef"><span class="hs-identifier hs-var">openParenRef</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-312"></span><span>
</span><span id="line-313"></span><span>        </span><span class="hs-comment">-- both components must be pointers to closures; retrieve them and</span><span>
</span><span id="line-314"></span><span>        </span><span class="hs-comment">-- call their respective pretty-printing functions</span><span>
</span><span id="line-315"></span><span>        </span><span id="local-6989586621679262137"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679262137"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Constant.Pair.html#getFst"><span class="hs-identifier hs-var">getFst</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262139"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-316"></span><span>        </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; m ()
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadFail m, MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Closure.html#printClosure"><span class="hs-identifier hs-var">printClosure</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679262137"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-317"></span><span>
</span><span id="line-318"></span><span>        </span><span class="annot"><span class="annottext">m Operand -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m Operand -&gt; m ()) -&gt; m Operand -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#printf"><span class="hs-identifier hs-var">printf</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#commaRef"><span class="hs-identifier hs-var">commaRef</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span>        </span><span id="local-6989586621679262134"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679262134"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Constant.Pair.html#getSnd"><span class="hs-identifier hs-var">getSnd</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262139"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-321"></span><span>        </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; m ()
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadFail m, MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Closure.html#printClosure"><span class="hs-identifier hs-var">printClosure</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679262134"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span>        </span><span class="hs-comment">-- print the closing bracket</span><span>
</span><span id="line-324"></span><span>        </span><span class="annot"><span class="annottext">m Operand -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m Operand -&gt; m ()) -&gt; m Operand -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#printf"><span class="hs-identifier hs-var">printf</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#closeParenRef"><span class="hs-identifier hs-var">closeParenRef</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span></span></span><span>
</span><span id="line-325"></span><span>
</span><span id="line-326"></span><span id="local-6989586621679262131"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679262127"><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#CompileConstant"><span class="hs-identifier hs-type">CompileConstant</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262131"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#CompileConstant"><span class="hs-identifier hs-type">CompileConstant</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679262131"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-327"></span><span>    </span><span id="local-6989586621679262124"><span class="annot"><span class="annottext">constantTypeId :: ConstantTy
</span><a href="#local-6989586621679262124"><span class="hs-identifier hs-var hs-var hs-var hs-var">constantTypeId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConstantTy
</span><a href="Hachi.Compiler.CodeGen.Monad.html#ConstList"><span class="hs-identifier hs-var">ConstList</span></a></span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span>    </span><span class="hs-comment">-- we represent an empty list as a null pointer while a cons cell is</span><span>
</span><span id="line-330"></span><span>    </span><span class="hs-comment">-- represented as a non-null pointer to a structure containing two</span><span>
</span><span id="line-331"></span><span>    </span><span class="hs-comment">-- pointers to closures: the head and the tail</span><span>
</span><span id="line-332"></span><span>    </span><span id="local-6989586621679262122"><span class="annot"><span class="annottext">compileConstant :: String -&gt; [a] -&gt; m Constant
</span><a href="#local-6989586621679262122"><span class="hs-identifier hs-var hs-var hs-var hs-var">compileConstant</span></a></span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Constant -&gt; m Constant
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; m Constant) -&gt; Constant -&gt; m Constant
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Constant
</span><span class="hs-identifier hs-var">Null</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#listTyPtr"><span class="hs-identifier hs-var">listTyPtr</span></a></span><span>
</span><span id="line-333"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstant"><span class="hs-identifier hs-var">compileConstant</span></a></span><span> </span><span id="local-6989586621679262120"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262120"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679262119"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679262119"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679262118"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679262118"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-334"></span><span>        </span><span class="hs-comment">-- generate a static closure for the head</span><span>
</span><span id="line-335"></span><span>        </span><span id="local-6989586621679262117"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262117"><span class="hs-identifier hs-var">xr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; a -&gt; m Constant
forall (m :: * -&gt; *) a.
(MonadCodeGen m, MonadIRBuilder m, CompileConstant a) =&gt;
String -&gt; a -&gt; m Constant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileSubConstant"><span class="hs-identifier hs-var">compileSubConstant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262120"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_head&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679262119"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span>        </span><span class="hs-comment">-- generate a static closure for the tail</span><span>
</span><span id="line-338"></span><span>        </span><span id="local-6989586621679262116"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262116"><span class="hs-identifier hs-var">xsr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; [a] -&gt; m Constant
forall (m :: * -&gt; *) a.
(MonadCodeGen m, MonadIRBuilder m, CompileConstant a) =&gt;
String -&gt; a -&gt; m Constant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileSubConstant"><span class="hs-identifier hs-var">compileSubConstant</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;list&quot;</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679262118"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span>        </span><span class="hs-comment">-- create a new global for this cons cell comprised of the</span><span>
</span><span id="line-341"></span><span>        </span><span class="hs-comment">-- pointers to the head and tail</span><span>
</span><span id="line-342"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262115"><span class="annot"><span class="annottext">listVal :: Constant
</span><a href="#local-6989586621679262115"><span class="hs-identifier hs-var hs-var">listVal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Name -&gt; Bool -&gt; [Constant] -&gt; Constant
</span><span class="hs-identifier hs-var">Struct</span></span><span> </span><span class="annot"><span class="annottext">Maybe Name
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262117"><span class="hs-identifier hs-var">xr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262116"><span class="hs-identifier hs-var">xsr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-343"></span><span>        </span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Type -&gt; Constant -&gt; (Global -&gt; Global) -&gt; m Operand
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Name -&gt; Type -&gt; Constant -&gt; (Global -&gt; Global) -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#global"><span class="hs-identifier hs-var">global</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">mkName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262120"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#listTy"><span class="hs-identifier hs-var">listTy</span></a></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262115"><span class="hs-identifier hs-var">listVal</span></a></span><span> </span><span class="annot"><span class="annottext">((Global -&gt; Global) -&gt; m Operand)
-&gt; (Global -&gt; Global) -&gt; m Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Linkage -&gt; Global -&gt; Global
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#setLinkage"><span class="hs-identifier hs-var">setLinkage</span></a></span><span> </span><span class="annot"><span class="annottext">Linkage
</span><span class="hs-identifier hs-var">Private</span></span><span>
</span><span id="line-344"></span><span>
</span><span id="line-345"></span><span>        </span><span class="hs-comment">-- return a reference to the global</span><span>
</span><span id="line-346"></span><span>        </span><span class="annot"><span class="annottext">Constant -&gt; m Constant
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; m Constant) -&gt; Constant -&gt; m Constant
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Name -&gt; Constant
</span><span class="hs-identifier hs-var">GlobalReference</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#listTyPtr"><span class="hs-identifier hs-var">listTyPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">mkName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262120"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span>
</span><span id="line-348"></span><span>    </span><span class="hs-comment">-- to load a list, we just retrieve its pointer from the closure</span><span>
</span><span id="line-349"></span><span>    </span><span id="local-6989586621679262113"><span class="annot"><span class="annottext">compileLoadConstant :: ClosurePtr k -&gt; m Operand
</span><a href="#local-6989586621679262113"><span class="hs-identifier hs-var hs-var hs-var hs-var">compileLoadConstant</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#loadFromClosure"><span class="hs-identifier hs-var">loadFromClosure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; ClosureComponent
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureFreeVar"><span class="hs-identifier hs-var">ClosureFreeVar</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#listTyPtr"><span class="hs-identifier hs-var">listTyPtr</span></a></span><span>
</span><span id="line-350"></span><span>
</span><span id="line-351"></span><span>    </span><span id="local-6989586621679262112"><span class="annot"><span class="annottext">compilePrintBody :: String -&gt; ClosurePtr k -&gt; m ()
</span><a href="#local-6989586621679262112"><span class="hs-identifier hs-var hs-var hs-var hs-var">compilePrintBody</span></a></span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679262111"><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679262111"><span class="hs-identifier hs-var">this</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-352"></span><span>        </span><span class="hs-comment">-- retrieve the pointer to the pair</span><span>
</span><span id="line-353"></span><span>        </span><span id="local-6989586621679262110"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262110"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ClosurePtr k -&gt; m Operand
forall a (m :: * -&gt; *) (k :: PtrKind).
(CompileConstant a, MonadCodeGen m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileLoadConstant"><span class="hs-identifier hs-var">compileLoadConstant</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679262131"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679262111"><span class="hs-identifier hs-var">this</span></a></span><span>
</span><span id="line-354"></span><span>
</span><span id="line-355"></span><span>        </span><span class="hs-comment">-- check whether the list is empty or a cons cell and use the</span><span>
</span><span id="line-356"></span><span>        </span><span class="hs-comment">-- appropriate pretty-printing code for each case</span><span>
</span><span id="line-357"></span><span>        </span><span class="annot"><span class="annottext">Operand -&gt; m () -&gt; m () -&gt; m ()
forall (m :: * -&gt; *).
MonadIRBuilder m =&gt;
Operand -&gt; m () -&gt; m () -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Constant.List.html#listCase"><span class="hs-identifier hs-var">listCase</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262110"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#printf"><span class="hs-identifier hs-var">printf</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#emptyListRef"><span class="hs-identifier hs-var">emptyListRef</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">m Operand -&gt; m () -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">m ()
forall (m :: * -&gt; *). MonadIRBuilder m =&gt; m ()
</span><span class="hs-identifier hs-var">retVoid</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-358"></span><span>            </span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#printf"><span class="hs-identifier hs-var">printf</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#openParenRef"><span class="hs-identifier hs-var">openParenRef</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-359"></span><span>
</span><span id="line-360"></span><span>            </span><span class="hs-comment">-- list is a cons cell: both components are pointers to closures;</span><span>
</span><span id="line-361"></span><span>            </span><span class="hs-comment">-- retrieve them and call their respective pretty-printing functions</span><span>
</span><span id="line-362"></span><span>            </span><span id="local-6989586621679262107"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679262107"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Constant.List.html#getHead"><span class="hs-identifier hs-var">getHead</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262110"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-363"></span><span>            </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; m ()
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadFail m, MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Closure.html#printClosure"><span class="hs-identifier hs-var">printClosure</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679262107"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-364"></span><span>
</span><span id="line-365"></span><span>            </span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#printf"><span class="hs-identifier hs-var">printf</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#consRef"><span class="hs-identifier hs-var">consRef</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-366"></span><span>
</span><span id="line-367"></span><span>            </span><span id="local-6989586621679262104"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679262104"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Constant.List.html#getTail"><span class="hs-identifier hs-var">getTail</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262110"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-368"></span><span>            </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; m ()
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadFail m, MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Closure.html#printClosure"><span class="hs-identifier hs-var">printClosure</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679262104"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-369"></span><span>
</span><span id="line-370"></span><span>            </span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#printf"><span class="hs-identifier hs-var">printf</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#closeParenRef"><span class="hs-identifier hs-var">closeParenRef</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-371"></span><span>
</span><span id="line-372"></span><span>            </span><span class="annot"><span class="annottext">m ()
forall (m :: * -&gt; *). MonadIRBuilder m =&gt; m ()
</span><span class="hs-identifier hs-var">retVoid</span></span></span><span>
</span><span id="line-373"></span><span>
</span><span id="line-374"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-375"></span><span>
</span><span id="line-376"></span><span class="hs-comment">-- | `compileConstEntry` @name@ generates an entry function for the</span><span>
</span><span id="line-377"></span><span class="hs-comment">-- constant named @name@ where the body which loads the constant from the</span><span>
</span><span id="line-378"></span><span class="hs-comment">-- closure is generated by the builder corresponding to type @a@ which must</span><span>
</span><span id="line-379"></span><span class="hs-comment">-- be an instance of `CompileConstant`.</span><span>
</span><span id="line-380"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstEntry"><span class="hs-identifier hs-type">compileConstEntry</span></a></span><span>
</span><span id="line-381"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679262396"><span class="annot"><a href="#local-6989586621679262396"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679262397"><span class="annot"><a href="#local-6989586621679262397"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#MonadCodeGen"><span class="hs-identifier hs-type">MonadCodeGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262397"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#CompileConstant"><span class="hs-identifier hs-type">CompileConstant</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262396"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-382"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262397"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Constant</span></span><span>
</span><span id="line-383"></span><span id="compileConstEntry"><span class="annot"><span class="annottext">compileConstEntry :: m Constant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstEntry"><span class="hs-identifier hs-var hs-var">compileConstEntry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-384"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262101"><span class="annot"><span class="annottext">ty :: ConstantTy
</span><a href="#local-6989586621679262101"><span class="hs-identifier hs-var hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CompileConstant a =&gt; ConstantTy
forall a. CompileConstant a =&gt; ConstantTy
</span><a href="Hachi.Compiler.CodeGen.Constant.html#constantTypeId"><span class="hs-identifier hs-var">constantTypeId</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679262396"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-385"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262100"><span class="annot"><span class="annottext">name :: String
</span><a href="#local-6989586621679262100"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConstantTy -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ConstantTy
</span><a href="#local-6989586621679262101"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_entry&quot;</span></span><span>
</span><span id="line-386"></span><span>
</span><span id="line-387"></span><span>    </span><span class="hs-comment">-- we need to determine if the entry code for this constant type has</span><span>
</span><span id="line-388"></span><span>    </span><span class="hs-comment">-- already been generated and, if so, retrieve the reference to it;</span><span>
</span><span id="line-389"></span><span>    </span><span class="hs-comment">-- if it has not been generated, then we should do so now</span><span>
</span><span id="line-390"></span><span>    </span><span id="local-6989586621679262099"><span class="annot"><span class="annottext">IORef (Map ConstantTy Constant)
</span><a href="#local-6989586621679262099"><span class="hs-identifier hs-var">entryFunctionsRef</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(CodeGenSt -&gt; IORef (Map ConstantTy Constant))
-&gt; m (IORef (Map ConstantTy Constant))
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">CodeGenSt -&gt; IORef (Map ConstantTy Constant)
</span><a href="Hachi.Compiler.CodeGen.Monad.html#codeGenConstEntries"><span class="hs-identifier hs-var hs-var">codeGenConstEntries</span></a></span><span>
</span><span id="line-391"></span><span>    </span><span id="local-6989586621679262096"><span class="annot"><span class="annottext">Map ConstantTy Constant
</span><a href="#local-6989586621679262096"><span class="hs-identifier hs-var">entryFunctions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Map ConstantTy Constant) -&gt; m (Map ConstantTy Constant)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Map ConstantTy Constant) -&gt; m (Map ConstantTy Constant))
-&gt; IO (Map ConstantTy Constant) -&gt; m (Map ConstantTy Constant)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef (Map ConstantTy Constant) -&gt; IO (Map ConstantTy Constant)
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Map ConstantTy Constant)
</span><a href="#local-6989586621679262099"><span class="hs-identifier hs-var">entryFunctionsRef</span></a></span><span>
</span><span id="line-392"></span><span>
</span><span id="line-393"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConstantTy -&gt; Map ConstantTy Constant -&gt; Maybe Constant
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">ConstantTy
</span><a href="#local-6989586621679262101"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Map ConstantTy Constant
</span><a href="#local-6989586621679262096"><span class="hs-identifier hs-var">entryFunctions</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-394"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679262092"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262092"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Constant -&gt; m Constant
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262092"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-395"></span><span>        </span><span class="annot"><span class="annottext">Maybe Constant
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-396"></span><span>            </span><span class="hs-comment">-- generate the entry code</span><span>
</span><span id="line-397"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262091"><span class="annot"><span class="annottext">llvmName :: Name
</span><a href="#local-6989586621679262091"><span class="hs-identifier hs-var hs-var">llvmName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">mkName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262100"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-398"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262090"><span class="annot"><span class="annottext">entryParams :: [(Type, ParameterName)]
</span><a href="#local-6989586621679262090"><span class="hs-identifier hs-var hs-var">entryParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; [(Type, ParameterName)]
</span><a href="Hachi.Compiler.CodeGen.Closure.html#clsEntryParams"><span class="hs-identifier hs-var">clsEntryParams</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;unused&quot;</span></span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span>            </span><span class="annot"><span class="annottext">m Operand -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m Operand -&gt; m ()) -&gt; m Operand -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name
-&gt; [(Type, ParameterName)]
-&gt; Type
-&gt; (Global -&gt; Global)
-&gt; ([Operand] -&gt; IRBuilderT m ())
-&gt; m Operand
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Name
-&gt; [(Type, ParameterName)]
-&gt; Type
-&gt; (Global -&gt; Global)
-&gt; ([Operand] -&gt; IRBuilderT m ())
-&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#function"><span class="hs-identifier hs-var">IR.function</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679262091"><span class="hs-identifier hs-var">llvmName</span></a></span><span> </span><span class="annot"><span class="annottext">[(Type, ParameterName)]
</span><a href="#local-6989586621679262090"><span class="hs-identifier hs-var">entryParams</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Global -&gt; Global
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#plcFunOpts"><span class="hs-identifier hs-var">plcFunOpts</span></a></span><span> </span><span class="annot"><span class="annottext">(([Operand] -&gt; IRBuilderT m ()) -&gt; m Operand)
-&gt; ([Operand] -&gt; IRBuilderT m ()) -&gt; m Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-401"></span><span>                </span><span class="hs-glyph">\</span><span class="hs-special">[</span><span id="local-6989586621679262085"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262085"><span class="hs-identifier hs-var">this</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679262084"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262084"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-402"></span><span>                    </span><span class="annot"><span class="annottext">String -&gt; [Operand] -&gt; IRBuilderT m ()
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m) =&gt;
String -&gt; [Operand] -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Common.html#compileTrace"><span class="hs-identifier hs-var">compileTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262100"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span>                    </span><span id="local-6989586621679262082"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262082"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (k :: PtrKind).
(CompileConstant a, MonadCodeGen m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m Operand
forall a (m :: * -&gt; *) (k :: PtrKind).
(CompileConstant a, MonadCodeGen m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileLoadConstant"><span class="hs-identifier hs-var">compileLoadConstant</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679262396"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><span class="annottext">(ClosurePtr 'DynamicPtr -&gt; IRBuilderT m Operand)
-&gt; ClosurePtr 'DynamicPtr -&gt; IRBuilderT m Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; ClosurePtr 'DynamicPtr
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkClosurePtr"><span class="hs-identifier hs-var">MkClosurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262085"><span class="hs-identifier hs-var">this</span></a></span><span>
</span><span id="line-405"></span><span>                    </span><span id="local-6989586621679262080"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262080"><span class="hs-identifier hs-var">vc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; IRBuilderT m Operand
forall a (m :: * -&gt; *).
(CompileConstant a, MonadIRBuilder m) =&gt;
Operand -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Constant.html#castConstantToPtr"><span class="hs-identifier hs-var">castConstantToPtr</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679262396"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262082"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-406"></span><span>                    </span><span id="local-6989586621679262079"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262079"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; Type -&gt; IRBuilderT m Operand
forall (m :: * -&gt; *).
MonadIRBuilder m =&gt;
Operand -&gt; Type -&gt; m Operand
</span><span class="hs-identifier hs-var">bitcast</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262080"><span class="hs-identifier hs-var">vc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#ptrOf"><span class="hs-identifier hs-var">ptrOf</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#i8"><span class="hs-identifier hs-var">i8</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>                    </span><span class="annot"><span class="annottext">Operand -&gt; Word32 -&gt; Operand -&gt; IRBuilderT m ()
forall (m :: * -&gt; *).
MonadIRBuilder m =&gt;
Operand -&gt; Word32 -&gt; Operand -&gt; m ()
</span><span class="hs-identifier hs-var">store</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#returnRef"><span class="hs-identifier hs-var">returnRef</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262079"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-408"></span><span>
</span><span id="line-409"></span><span>                    </span><span id="local-6989586621679262075"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679262075"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Continuation -&gt; Operand -&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall a (m :: * -&gt; *).
(ContinuationRep a, MonadCodeGen m, MonadIRBuilder m) =&gt;
Continuation -&gt; a -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.CPS.html#callCont"><span class="hs-identifier hs-var">callCont</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Operand -&gt; Continuation
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkCont"><span class="hs-identifier hs-var">MkCont</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262084"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262085"><span class="hs-identifier hs-var">this</span></a></span><span>
</span><span id="line-410"></span><span>                    </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Closure.html#retClosure"><span class="hs-identifier hs-var">retClosure</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679262075"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-411"></span><span>
</span><span id="line-412"></span><span>            </span><span class="hs-comment">-- construct a reference to the entry code and store it in the</span><span>
</span><span id="line-413"></span><span>            </span><span class="hs-comment">-- global lookup table</span><span>
</span><span id="line-414"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262071"><span class="annot"><span class="annottext">ref :: Constant
</span><a href="#local-6989586621679262071"><span class="hs-identifier hs-var hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Name -&gt; Constant
</span><span class="hs-identifier hs-var">GlobalReference</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Closure.html#clsEntryTy"><span class="hs-identifier hs-var">clsEntryTy</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679262091"><span class="hs-identifier hs-var">llvmName</span></a></span><span>
</span><span id="line-415"></span><span>            </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef (Map ConstantTy Constant) -&gt; Map ConstantTy Constant -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Map ConstantTy Constant)
</span><a href="#local-6989586621679262099"><span class="hs-identifier hs-var">entryFunctionsRef</span></a></span><span> </span><span class="annot"><span class="annottext">(Map ConstantTy Constant -&gt; IO ())
-&gt; Map ConstantTy Constant -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConstantTy
-&gt; Constant -&gt; Map ConstantTy Constant -&gt; Map ConstantTy Constant
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">ConstantTy
</span><a href="#local-6989586621679262101"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262071"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Map ConstantTy Constant
</span><a href="#local-6989586621679262096"><span class="hs-identifier hs-var">entryFunctions</span></a></span><span>
</span><span id="line-416"></span><span>
</span><span id="line-417"></span><span>            </span><span class="hs-comment">-- return the reference</span><span>
</span><span id="line-418"></span><span>            </span><span class="annot"><span class="annottext">Constant -&gt; m Constant
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262071"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-419"></span><span>
</span><span id="line-420"></span><span class="hs-comment">-- | `compileConst` @value@ generates code for a constant whose @value@ is</span><span>
</span><span id="line-421"></span><span class="hs-comment">-- provided as the first argument.</span><span>
</span><span id="line-422"></span><span id="local-6989586621679262067"><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#compileConst"><span class="hs-identifier hs-type">compileConst</span></a></span><span>
</span><span id="line-423"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#MonadCodeGen"><span class="hs-identifier hs-type">MonadCodeGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262067"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679262067"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-424"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Some</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ValueOf</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefaultUni</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262067"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#StaticPtr"><span class="hs-identifier hs-type">StaticPtr</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-425"></span><span id="compileConst"><span class="annot"><span class="annottext">compileConst :: Some (ValueOf DefaultUni) -&gt; m (ClosurePtr 'StaticPtr)
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileConst"><span class="hs-identifier hs-var hs-var">compileConst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Some</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ValueOf</span></span><span> </span><span id="local-6989586621679262064"><span class="annot"><span class="annottext">DefaultUni (Esc a)
</span><a href="#local-6989586621679262064"><span class="hs-identifier hs-var">tag</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679262063"><span id="local-6989586621679262062"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679262062"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679262063"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-426"></span><span>    </span><span id="local-6989586621679262061"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262061"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; m String
forall (m :: * -&gt; *).
(MonadReader CodeGenSt m, MonadIO m) =&gt;
String -&gt; m String
</span><a href="Hachi.Compiler.CodeGen.Monad.html#mkFresh"><span class="hs-identifier hs-var">mkFresh</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;con&quot;</span></span><span>
</span><span id="line-427"></span><span>
</span><span id="line-428"></span><span>    </span><span class="annot"><span class="annottext">Proxy CompileConstant
-&gt; DefaultUni (Esc a)
-&gt; (CompileConstant a =&gt; m (ClosurePtr 'StaticPtr))
-&gt; m (ClosurePtr 'StaticPtr)
forall (uni :: * -&gt; *) (constr :: * -&gt; Constraint)
       (proxy :: (* -&gt; Constraint) -&gt; *) a r.
(Closed uni, Everywhere uni constr) =&gt;
proxy constr -&gt; uni (Esc a) -&gt; (constr a =&gt; r) -&gt; r
</span><span class="hs-identifier hs-var">bring</span></span><span> </span><span class="annot"><span class="annottext">Proxy CompileConstant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#ccProxy"><span class="hs-identifier hs-var">ccProxy</span></a></span><span> </span><span class="annot"><span class="annottext">DefaultUni (Esc a)
</span><a href="#local-6989586621679262064"><span class="hs-identifier hs-var">tag</span></a></span><span> </span><span class="annot"><span class="annottext">((CompileConstant a =&gt; m (ClosurePtr 'StaticPtr))
 -&gt; m (ClosurePtr 'StaticPtr))
-&gt; (CompileConstant a =&gt; m (ClosurePtr 'StaticPtr))
-&gt; m (ClosurePtr 'StaticPtr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; a -&gt; m (ClosurePtr 'StaticPtr)
forall a (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m, CompileConstant a) =&gt;
String -&gt; a -&gt; m (ClosurePtr 'StaticPtr)
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstStatic"><span class="hs-identifier hs-var">compileConstStatic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262061"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679262062"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-429"></span><span>
</span><span id="line-430"></span><span class="hs-comment">-- | `compileConstStatic` @name value@ generates code for a static constant</span><span>
</span><span id="line-431"></span><span class="hs-comment">-- with the name given by @name@ and the value given by @value@.</span><span>
</span><span id="line-432"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstStatic"><span class="hs-identifier hs-type">compileConstStatic</span></a></span><span>
</span><span id="line-433"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679262565"><span class="annot"><a href="#local-6989586621679262565"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679262568"><span class="annot"><a href="#local-6989586621679262568"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#MonadCodeGen"><span class="hs-identifier hs-type">MonadCodeGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262568"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679262568"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#CompileConstant"><span class="hs-identifier hs-type">CompileConstant</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262565"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262565"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262568"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#StaticPtr"><span class="hs-identifier hs-type">StaticPtr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-435"></span><span id="compileConstStatic"><span class="annot"><span class="annottext">compileConstStatic :: String -&gt; a -&gt; m (ClosurePtr 'StaticPtr)
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstStatic"><span class="hs-identifier hs-var hs-var">compileConstStatic</span></a></span></span><span> </span><span id="local-6989586621679262059"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262059"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679262058"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679262058"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-436"></span><span>    </span><span id="local-6989586621679262057"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262057"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; a -&gt; m Constant
forall a (m :: * -&gt; *).
(CompileConstant a, MonadCodeGen m, MonadIRBuilder m) =&gt;
String -&gt; a -&gt; m Constant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstant"><span class="hs-identifier hs-var">compileConstant</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262059"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679262058"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-437"></span><span>
</span><span id="line-438"></span><span>    </span><span id="local-6989586621679262056"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262056"><span class="hs-identifier hs-var">codePtr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *).
(MonadCodeGen m, CompileConstant a) =&gt;
m Constant
forall (m :: * -&gt; *).
(MonadCodeGen m, CompileConstant a) =&gt;
m Constant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstEntry"><span class="hs-identifier hs-var">compileConstEntry</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679262565"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-439"></span><span>
</span><span id="line-440"></span><span>    </span><span class="hs-comment">-- 2. generate print code</span><span>
</span><span id="line-441"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262055"><span class="annot"><span class="annottext">builder :: ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()
</span><a href="#local-6989586621679262055"><span class="hs-identifier hs-var hs-var">builder</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()
forall a (m :: * -&gt; *) (k :: PtrKind).
(CompileConstant a, MonadCodeGen m, MonadIRBuilder m) =&gt;
String -&gt; ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compilePrintBody"><span class="hs-identifier hs-var">compilePrintBody</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679262565"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262059"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-442"></span><span>    </span><span id="local-6989586621679262054"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262054"><span class="hs-identifier hs-var">printPtr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ConstantTy
-&gt; (ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()) -&gt; m Constant
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
ConstantTy
-&gt; (ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()) -&gt; m Constant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstPrint"><span class="hs-identifier hs-var">compileConstPrint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CompileConstant a =&gt; ConstantTy
forall a. CompileConstant a =&gt; ConstantTy
</span><a href="Hachi.Compiler.CodeGen.Constant.html#constantTypeId"><span class="hs-identifier hs-var">constantTypeId</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679262565"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()
</span><a href="#local-6989586621679262055"><span class="hs-identifier hs-var">builder</span></a></span><span>
</span><span id="line-443"></span><span>
</span><span id="line-444"></span><span>    </span><span class="hs-comment">-- 3. generate a static closure: this should be sufficient since constants</span><span>
</span><span id="line-445"></span><span>    </span><span class="hs-comment">-- hopefully do not contain any free variables</span><span>
</span><span id="line-446"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; String
-&gt; Constant
-&gt; Constant
-&gt; [Constant]
-&gt; m (ClosurePtr 'StaticPtr)
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Bool
-&gt; String
-&gt; Constant
-&gt; Constant
-&gt; [Constant]
-&gt; m (ClosurePtr 'StaticPtr)
</span><a href="Hachi.Compiler.CodeGen.Closure.html#compileClosure"><span class="hs-identifier hs-var">compileClosure</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262059"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262056"><span class="hs-identifier hs-var">codePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262054"><span class="hs-identifier hs-var">printPtr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262057"><span class="hs-identifier hs-var">ptr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-447"></span><span>
</span><span id="line-448"></span><span class="hs-comment">-- | `compileConstDynamic` @value@ generates code which allocates a dynamic</span><span>
</span><span id="line-449"></span><span class="hs-comment">-- closure for the value given by @value@. Note that this function must be</span><span>
</span><span id="line-450"></span><span class="hs-comment">-- used with `XTypeApplications` in order to select a type for the type</span><span>
</span><span id="line-451"></span><span class="hs-comment">-- variable @a@.</span><span>
</span><span id="line-452"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstDynamic"><span class="hs-identifier hs-type">compileConstDynamic</span></a></span><span>
</span><span id="line-453"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679262388"><span class="annot"><a href="#local-6989586621679262388"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679262389"><span class="annot"><a href="#local-6989586621679262389"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#MonadCodeGen"><span class="hs-identifier hs-type">MonadCodeGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262389"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679262389"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#CompileConstant"><span class="hs-identifier hs-type">CompileConstant</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262388"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-454"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Operand</span></span><span>
</span><span id="line-455"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262389"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#DynamicPtr"><span class="hs-identifier hs-type">DynamicPtr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-456"></span><span id="compileConstDynamic"><span class="annot"><span class="annottext">compileConstDynamic :: Operand -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstDynamic"><span class="hs-identifier hs-var hs-var">compileConstDynamic</span></a></span></span><span> </span><span id="local-6989586621679262051"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262051"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-457"></span><span>    </span><span id="local-6989586621679262050"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262050"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; m String
forall (m :: * -&gt; *).
(MonadReader CodeGenSt m, MonadIO m) =&gt;
String -&gt; m String
</span><a href="Hachi.Compiler.CodeGen.Monad.html#mkFresh"><span class="hs-identifier hs-var">mkFresh</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;con&quot;</span></span><span>
</span><span id="line-458"></span><span>
</span><span id="line-459"></span><span>    </span><span class="hs-comment">-- 1. generate entry code</span><span>
</span><span id="line-460"></span><span>    </span><span id="local-6989586621679262049"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262049"><span class="hs-identifier hs-var">codePtr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *).
(MonadCodeGen m, CompileConstant a) =&gt;
m Constant
forall (m :: * -&gt; *).
(MonadCodeGen m, CompileConstant a) =&gt;
m Constant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstEntry"><span class="hs-identifier hs-var">compileConstEntry</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679262388"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-461"></span><span>
</span><span id="line-462"></span><span>    </span><span class="hs-comment">-- 2. generate print code</span><span>
</span><span id="line-463"></span><span>    </span><span id="local-6989586621679262048"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262048"><span class="hs-identifier hs-var">printPtr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ConstantTy
-&gt; (ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()) -&gt; m Constant
forall (m :: * -&gt; *).
MonadCodeGen m =&gt;
ConstantTy
-&gt; (ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()) -&gt; m Constant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstPrint"><span class="hs-identifier hs-var">compileConstPrint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CompileConstant a =&gt; ConstantTy
forall a. CompileConstant a =&gt; ConstantTy
</span><a href="Hachi.Compiler.CodeGen.Constant.html#constantTypeId"><span class="hs-identifier hs-var">constantTypeId</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679262388"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()) -&gt; m Constant)
-&gt; (ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()) -&gt; m Constant
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-464"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()
forall a (m :: * -&gt; *) (k :: PtrKind).
(CompileConstant a, MonadCodeGen m, MonadIRBuilder m) =&gt;
String -&gt; ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compilePrintBody"><span class="hs-identifier hs-var">compilePrintBody</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679262388"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679262050"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-465"></span><span>
</span><span id="line-466"></span><span>    </span><span class="hs-comment">-- cast the value to a pointer type, if necessary</span><span>
</span><span id="line-467"></span><span>    </span><span id="local-6989586621679262047"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262047"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; m Operand
forall a (m :: * -&gt; *).
(CompileConstant a, MonadIRBuilder m) =&gt;
Operand -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Constant.html#castConstantToPtr"><span class="hs-identifier hs-var">castConstantToPtr</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679262388"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262051"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span>    </span><span class="hs-comment">-- 3. generate a dynamic closure</span><span>
</span><span id="line-470"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; Constant -&gt; Constant -&gt; [Operand] -&gt; m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m) =&gt;
Bool
-&gt; Constant -&gt; Constant -&gt; [Operand] -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Closure.html#allocateClosure"><span class="hs-identifier hs-var">allocateClosure</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262049"><span class="hs-identifier hs-var">codePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262048"><span class="hs-identifier hs-var">printPtr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262047"><span class="hs-identifier hs-var">ptr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-471"></span><span>
</span><span id="line-472"></span><span class="hs-comment">-- | `retConstDynamic` @value@ is like `compileConstDynamic`, except that a</span><span>
</span><span id="line-473"></span><span class="hs-comment">-- return instruction is inserted at the end which returns the pointer to the</span><span>
</span><span id="line-474"></span><span class="hs-comment">-- new closure.</span><span>
</span><span id="line-475"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#retConstDynamic"><span class="hs-identifier hs-type">retConstDynamic</span></a></span><span>
</span><span id="line-476"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679262045"><span class="annot"><a href="#local-6989586621679262045"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679262044"><span class="annot"><a href="#local-6989586621679262044"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#MonadCodeGen"><span class="hs-identifier hs-type">MonadCodeGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262044"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679262044"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#CompileConstant"><span class="hs-identifier hs-type">CompileConstant</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262045"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-477"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#Continuation"><span class="hs-identifier hs-type">Continuation</span></a></span><span>
</span><span id="line-478"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Operand</span></span><span>
</span><span id="line-479"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262044"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-480"></span><span id="retConstDynamic"><span class="annot"><span class="annottext">retConstDynamic :: Continuation -&gt; Operand -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Constant.html#retConstDynamic"><span class="hs-identifier hs-var hs-var">retConstDynamic</span></a></span></span><span> </span><span id="local-6989586621679262043"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679262043"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679262042"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262042"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-481"></span><span>    </span><span class="annot"><span class="annottext">Operand -&gt; m (ClosurePtr 'DynamicPtr)
forall a (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m, CompileConstant a) =&gt;
Operand -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstDynamic"><span class="hs-identifier hs-var">compileConstDynamic</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679262045"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262042"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">m (ClosurePtr 'DynamicPtr)
-&gt; (ClosurePtr 'DynamicPtr -&gt; m (ClosurePtr 'DynamicPtr))
-&gt; m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span>
</span><span id="line-482"></span><span>    </span><span class="annot"><span class="annottext">Continuation
-&gt; ClosurePtr 'DynamicPtr -&gt; m (ClosurePtr 'DynamicPtr)
forall a (m :: * -&gt; *).
(ContinuationRep a, MonadCodeGen m, MonadIRBuilder m) =&gt;
Continuation -&gt; a -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.CPS.html#callCont"><span class="hs-identifier hs-var">callCont</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679262043"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">m (ClosurePtr 'DynamicPtr)
-&gt; (ClosurePtr 'DynamicPtr -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span>
</span><span id="line-483"></span><span>    </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; m ()
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Closure.html#retClosure"><span class="hs-identifier hs-var">retClosure</span></a></span><span>
</span><span id="line-484"></span><span>
</span><span id="line-485"></span><span class="hs-comment">-- | `compileConstPrint` @name builder@ compiles a print function for a</span><span>
</span><span id="line-486"></span><span class="hs-comment">-- constant which loads the constant value from the closure using @builder@.</span><span>
</span><span id="line-487"></span><span id="local-6989586621679262395"><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstPrint"><span class="hs-identifier hs-type">compileConstPrint</span></a></span><span>
</span><span id="line-488"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#MonadCodeGen"><span class="hs-identifier hs-type">MonadCodeGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262395"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-489"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#ConstantTy"><span class="hs-identifier hs-type">ConstantTy</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#DynamicPtr"><span class="hs-identifier hs-type">DynamicPtr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IRBuilderT</span></span><span> </span><span class="annot"><a href="#local-6989586621679262395"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262395"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Constant</span></span></span><span>
</span><span id="line-490"></span><span id="compileConstPrint"><span class="annot"><span class="annottext">compileConstPrint :: ConstantTy
-&gt; (ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()) -&gt; m Constant
</span><a href="Hachi.Compiler.CodeGen.Constant.html#compileConstPrint"><span class="hs-identifier hs-var hs-var">compileConstPrint</span></a></span></span><span> </span><span id="local-6989586621679262041"><span class="annot"><span class="annottext">ConstantTy
</span><a href="#local-6989586621679262041"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621679262040"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()
</span><a href="#local-6989586621679262040"><span class="hs-identifier hs-var">bodyBuilder</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-491"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262039"><span class="annot"><span class="annottext">printName :: Name
</span><a href="#local-6989586621679262039"><span class="hs-identifier hs-var hs-var">printName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">mkName</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Name) -&gt; String -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConstantTy -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ConstantTy
</span><a href="#local-6989586621679262041"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_print&quot;</span></span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span>    </span><span class="hs-comment">-- we need to determine if the pretty-printer for this constant type has</span><span>
</span><span id="line-494"></span><span>    </span><span class="hs-comment">-- already been generated and, if so, retrieve the reference to it;</span><span>
</span><span id="line-495"></span><span>    </span><span class="hs-comment">-- if it has not been generated, then we should do so now</span><span>
</span><span id="line-496"></span><span>    </span><span id="local-6989586621679262038"><span class="annot"><span class="annottext">IORef (Map ConstantTy Constant)
</span><a href="#local-6989586621679262038"><span class="hs-identifier hs-var">prettyPrintersRef</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(CodeGenSt -&gt; IORef (Map ConstantTy Constant))
-&gt; m (IORef (Map ConstantTy Constant))
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">CodeGenSt -&gt; IORef (Map ConstantTy Constant)
</span><a href="Hachi.Compiler.CodeGen.Monad.html#codeGenConstPrinters"><span class="hs-identifier hs-var hs-var">codeGenConstPrinters</span></a></span><span>
</span><span id="line-497"></span><span>    </span><span id="local-6989586621679262036"><span class="annot"><span class="annottext">Map ConstantTy Constant
</span><a href="#local-6989586621679262036"><span class="hs-identifier hs-var">prettyPrinters</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Map ConstantTy Constant) -&gt; m (Map ConstantTy Constant)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Map ConstantTy Constant) -&gt; m (Map ConstantTy Constant))
-&gt; IO (Map ConstantTy Constant) -&gt; m (Map ConstantTy Constant)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef (Map ConstantTy Constant) -&gt; IO (Map ConstantTy Constant)
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Map ConstantTy Constant)
</span><a href="#local-6989586621679262038"><span class="hs-identifier hs-var">prettyPrintersRef</span></a></span><span>
</span><span id="line-498"></span><span>
</span><span id="line-499"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConstantTy -&gt; Map ConstantTy Constant -&gt; Maybe Constant
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">ConstantTy
</span><a href="#local-6989586621679262041"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Map ConstantTy Constant
</span><a href="#local-6989586621679262036"><span class="hs-identifier hs-var">prettyPrinters</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-500"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679262035"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262035"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Constant -&gt; m Constant
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262035"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-501"></span><span>        </span><span class="annot"><span class="annottext">Maybe Constant
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-502"></span><span>            </span><span class="hs-comment">-- generate the pretty-printing function</span><span>
</span><span id="line-503"></span><span>            </span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name
-&gt; [(Type, ParameterName)]
-&gt; Type
-&gt; (Global -&gt; Global)
-&gt; ([Operand] -&gt; IRBuilderT m ())
-&gt; m Operand
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Name
-&gt; [(Type, ParameterName)]
-&gt; Type
-&gt; (Global -&gt; Global)
-&gt; ([Operand] -&gt; IRBuilderT m ())
-&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#function"><span class="hs-identifier hs-var">IR.function</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679262039"><span class="hs-identifier hs-var">printName</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ParameterName
</span><span class="hs-string">&quot;this&quot;</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier hs-var">VoidType</span></span><span> </span><span class="annot"><span class="annottext">Global -&gt; Global
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#plcFunOpts"><span class="hs-identifier hs-var">plcFunOpts</span></a></span><span> </span><span class="annot"><span class="annottext">(([Operand] -&gt; IRBuilderT m ()) -&gt; m Operand)
-&gt; ([Operand] -&gt; IRBuilderT m ()) -&gt; m Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-504"></span><span>                </span><span class="hs-glyph">\</span><span class="hs-special">[</span><span id="local-6989586621679262033"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262033"><span class="hs-identifier hs-var">this</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-505"></span><span>                    </span><span class="annot"><span class="annottext">String -&gt; [Operand] -&gt; IRBuilderT m ()
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m) =&gt;
String -&gt; [Operand] -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Common.html#compileTrace"><span class="hs-identifier hs-var">compileTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConstantTy -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ConstantTy
</span><a href="#local-6989586621679262041"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_print&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-506"></span><span>
</span><span id="line-507"></span><span>                    </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()
</span><a href="#local-6989586621679262040"><span class="hs-identifier hs-var">bodyBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">(ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ())
-&gt; ClosurePtr 'DynamicPtr -&gt; IRBuilderT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; ClosurePtr 'DynamicPtr
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkClosurePtr"><span class="hs-identifier hs-var">MkClosurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262033"><span class="hs-identifier hs-var">this</span></a></span><span>
</span><span id="line-508"></span><span>
</span><span id="line-509"></span><span>                    </span><span class="annot"><span class="annottext">IRBuilderT m ()
forall (m :: * -&gt; *). MonadIRBuilder m =&gt; m ()
</span><span class="hs-identifier hs-var">retVoid</span></span><span>
</span><span id="line-510"></span><span>
</span><span id="line-511"></span><span>            </span><span class="hs-comment">-- construct the reference to the function and store it in the</span><span>
</span><span id="line-512"></span><span>            </span><span class="hs-comment">-- global lookup table</span><span>
</span><span id="line-513"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262032"><span class="annot"><span class="annottext">ref :: Constant
</span><a href="#local-6989586621679262032"><span class="hs-identifier hs-var hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Name -&gt; Constant
</span><span class="hs-identifier hs-var">GlobalReference</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Closure.html#printFnTy"><span class="hs-identifier hs-var">printFnTy</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679262039"><span class="hs-identifier hs-var">printName</span></a></span><span>
</span><span id="line-514"></span><span>
</span><span id="line-515"></span><span>            </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef (Map ConstantTy Constant) -&gt; Map ConstantTy Constant -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Map ConstantTy Constant)
</span><a href="#local-6989586621679262038"><span class="hs-identifier hs-var">prettyPrintersRef</span></a></span><span> </span><span class="annot"><span class="annottext">(Map ConstantTy Constant -&gt; IO ())
-&gt; Map ConstantTy Constant -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-516"></span><span>                </span><span class="annot"><span class="annottext">ConstantTy
-&gt; Constant -&gt; Map ConstantTy Constant -&gt; Map ConstantTy Constant
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">ConstantTy
</span><a href="#local-6989586621679262041"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262032"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Map ConstantTy Constant
</span><a href="#local-6989586621679262036"><span class="hs-identifier hs-var">prettyPrinters</span></a></span><span>
</span><span id="line-517"></span><span>
</span><span id="line-518"></span><span>            </span><span class="hs-comment">-- return the reference</span><span>
</span><span id="line-519"></span><span>            </span><span class="annot"><span class="annottext">Constant -&gt; m Constant
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679262032"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-520"></span><span>
</span><span id="line-521"></span><span class="hs-comment">-- | `loadConstVal` @type@ loads the value of the result register (which</span><span>
</span><span id="line-522"></span><span class="hs-comment">-- constant closures write to when entered) assuming that it is of the</span><span>
</span><span id="line-523"></span><span class="hs-comment">-- type given by @type@.</span><span>
</span><span id="line-524"></span><span id="local-6989586621679262030"><span class="annot"><a href="Hachi.Compiler.CodeGen.Constant.html#loadConstVal"><span class="hs-identifier hs-type">loadConstVal</span></a></span><span>
</span><span id="line-525"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadModuleBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679262030"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679262030"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-526"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LLVM.Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262030"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Operand</span></span></span><span>
</span><span id="line-527"></span><span id="loadConstVal"><span class="annot"><span class="annottext">loadConstVal :: Type -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Constant.html#loadConstVal"><span class="hs-identifier hs-var hs-var">loadConstVal</span></a></span></span><span> </span><span id="local-6989586621679262029"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679262029"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-528"></span><span>    </span><span class="hs-comment">-- the result register stores a pointer to some value, so we first need</span><span>
</span><span id="line-529"></span><span>    </span><span class="hs-comment">-- to load that pointer from the result register</span><span>
</span><span id="line-530"></span><span>    </span><span id="local-6989586621679262028"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262028"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; Word32 -&gt; m Operand
forall (m :: * -&gt; *).
(HasCallStack, MonadIRBuilder m, MonadModuleBuilder m) =&gt;
Operand -&gt; Word32 -&gt; m Operand
</span><span class="hs-identifier hs-var">load</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#returnRef"><span class="hs-identifier hs-var">returnRef</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">0</span></span><span>
</span><span id="line-531"></span><span>
</span><span id="line-532"></span><span>    </span><span class="hs-comment">-- we then cast it to a pointer of the appropriate type we want and load</span><span>
</span><span id="line-533"></span><span>    </span><span class="hs-comment">-- the corresponding value</span><span>
</span><span id="line-534"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="Hachi.Compiler.CodeGen.Types.html#isPtr"><span class="hs-identifier hs-var">isPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679262029"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-535"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Operand -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Type -&gt; Operand -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#castIfNeeded"><span class="hs-identifier hs-var">castIfNeeded</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679262029"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262028"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-536"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; Type -&gt; m Operand
forall (m :: * -&gt; *).
MonadIRBuilder m =&gt;
Operand -&gt; Type -&gt; m Operand
</span><span class="hs-identifier hs-var">ptrtoint</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679262028"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679262029"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-537"></span><span>
</span><span id="line-538"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-539"></span></pre></body></html>