<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hachi.Compiler.CodeGen.Closure</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-2"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Closure representation</span></span><span>
</span><span id="line-3"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier">ClosurePtr</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-4"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#closureTyDef"><span class="hs-identifier">closureTyDef</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-5"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#closureSize"><span class="hs-identifier">closureSize</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#closureTy"><span class="hs-identifier">closureTy</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier">closureTyPtr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Creating closures</span></span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#mkEntryTy"><span class="hs-identifier">mkEntryTy</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#clsEntryTy"><span class="hs-identifier">clsEntryTy</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#clsEntryParams"><span class="hs-identifier">clsEntryParams</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#varEntryTy"><span class="hs-identifier">varEntryTy</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#printFnTy"><span class="hs-identifier">printFnTy</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#mkClosureName"><span class="hs-identifier">mkClosureName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#compileClosure"><span class="hs-identifier">compileClosure</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#ptrSize"><span class="hs-identifier">ptrSize</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#bits"><span class="hs-identifier">bits</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#HasFreeVars"><span class="hs-identifier">HasFreeVars</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#allocateClosure"><span class="hs-identifier">allocateClosure</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#withFreeVars"><span class="hs-identifier">withFreeVars</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#compileDynamicClosure"><span class="hs-identifier">compileDynamicClosure</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#compileFunPrint"><span class="hs-identifier">compileFunPrint</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Loading data from closures</span></span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureComponent"><span class="hs-identifier">ClosureComponent</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#loadFromClosure"><span class="hs-identifier">loadFromClosure</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#callClosure"><span class="hs-identifier">callClosure</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#enterClosure"><span class="hs-identifier">enterClosure</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#printClosure"><span class="hs-identifier">printClosure</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#compileApply"><span class="hs-identifier">compileApply</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#lookupVar"><span class="hs-identifier">lookupVar</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Misc</span></span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#retClosure"><span class="hs-identifier">retClosure</span></a></span><span>
</span><span id="line-36"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.IORef</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Word</span></span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">LLVM.AST</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">LLVM.AST.AddrSpace</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">LLVM.AST.Constant</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">LLVM.AST.Linkage</span></span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Common.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Common</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Externals.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Externals</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Globals.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Globals</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">G</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.IRBuilder.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.IRBuilder</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IR</span></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Monad</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html"><span class="hs-identifier">Hachi.Compiler.CodeGen.Types</span></a></span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-comment">-- | `closureTyDef` is a `Type` definition for closures. Note the layout is</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- as follows:</span><span>
</span><span id="line-67"></span><span class="hs-comment">--</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- - A pointer to the code for the closure.</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- - A pointer to the print code for the closure.</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- - Closure flags.</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- - Zero or more free variables. (LLVM will accept more elements than the</span><span>
</span><span id="line-72"></span><span class="hs-comment">-- array's indicated size) https://llvm.org/docs/LangRef.html#array-type</span><span>
</span><span id="line-73"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#closureTyDef"><span class="hs-identifier hs-type">closureTyDef</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span>
</span><span id="line-74"></span><span id="closureTyDef"><span class="annot"><span class="annottext">closureTyDef :: Type
</span><a href="Hachi.Compiler.CodeGen.Closure.html#closureTyDef"><span class="hs-identifier hs-var hs-var">closureTyDef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; [Type] -&gt; Type
</span><span class="hs-identifier hs-var">StructureType</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-75"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Closure.html#clsEntryTy"><span class="hs-identifier hs-var">clsEntryTy</span></a></span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Closure.html#printFnTy"><span class="hs-identifier hs-var">printFnTy</span></a></span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.Platform.html#iHost"><span class="hs-identifier hs-var">iHost</span></a></span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Type -&gt; Type
</span><span class="hs-identifier hs-var">ArrayType</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#ptrOf"><span class="hs-identifier hs-var">ptrOf</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#i8"><span class="hs-identifier hs-var">i8</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span class="hs-comment">-- | The minimum size of a closure in words.</span><span>
</span><span id="line-82"></span><span id="local-6989586621679261467"><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#closureSize"><span class="hs-identifier hs-type">closureSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Num</span></span><span> </span><span class="annot"><a href="#local-6989586621679261467"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679261467"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-83"></span><span id="closureSize"><span class="annot"><span class="annottext">closureSize :: a
</span><a href="Hachi.Compiler.CodeGen.Closure.html#closureSize"><span class="hs-identifier hs-var hs-var">closureSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">3</span></span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span class="hs-comment">-- | Enumerates different components of a closure.</span><span>
</span><span id="line-86"></span><span class="hs-keyword">data</span><span> </span><span id="ClosureComponent"><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureComponent"><span class="hs-identifier hs-var">ClosureComponent</span></a></span></span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="ClosureCode"><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureCode"><span class="hs-identifier hs-var">ClosureCode</span></a></span></span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ClosurePrint"><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#ClosurePrint"><span class="hs-identifier hs-var">ClosurePrint</span></a></span></span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ClosureFlags"><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureFlags"><span class="hs-identifier hs-var">ClosureFlags</span></a></span></span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ClosureFreeVar"><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureFreeVar"><span class="hs-identifier hs-var">ClosureFreeVar</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integer</span></span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679261278"><span id="local-6989586621679261280"><span class="annot"><span class="annottext">ClosureComponent -&gt; ClosureComponent -&gt; Bool
(ClosureComponent -&gt; ClosureComponent -&gt; Bool)
-&gt; (ClosureComponent -&gt; ClosureComponent -&gt; Bool)
-&gt; Eq ClosureComponent
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: ClosureComponent -&gt; ClosureComponent -&gt; Bool
$c/= :: ClosureComponent -&gt; ClosureComponent -&gt; Bool
== :: ClosureComponent -&gt; ClosureComponent -&gt; Bool
$c== :: ClosureComponent -&gt; ClosureComponent -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261271"><span id="local-6989586621679261273"><span id="local-6989586621679261275"><span class="annot"><span class="annottext">Int -&gt; ClosureComponent -&gt; ShowS
[ClosureComponent] -&gt; ShowS
ClosureComponent -&gt; String
(Int -&gt; ClosureComponent -&gt; ShowS)
-&gt; (ClosureComponent -&gt; String)
-&gt; ([ClosureComponent] -&gt; ShowS)
-&gt; Show ClosureComponent
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ClosureComponent] -&gt; ShowS
$cshowList :: [ClosureComponent] -&gt; ShowS
show :: ClosureComponent -&gt; String
$cshow :: ClosureComponent -&gt; String
showsPrec :: Int -&gt; ClosureComponent -&gt; ShowS
$cshowsPrec :: Int -&gt; ClosureComponent -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span class="hs-comment">-- | `indicesForComponent` @component@ determines the indices of @component@</span><span>
</span><span id="line-94"></span><span class="hs-comment">-- within a closure.</span><span>
</span><span id="line-95"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#indicesForComponent"><span class="hs-identifier hs-type">indicesForComponent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureComponent"><span class="hs-identifier hs-type">ClosureComponent</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Operand</span></span><span class="hs-special">]</span><span>
</span><span id="line-96"></span><span id="indicesForComponent"><span class="annot"><span class="annottext">indicesForComponent :: ClosureComponent -&gt; [Operand]
</span><a href="Hachi.Compiler.CodeGen.Closure.html#indicesForComponent"><span class="hs-identifier hs-var hs-var">indicesForComponent</span></a></span></span><span> </span><span class="annot"><span class="annottext">ClosureComponent
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureCode"><span class="hs-identifier hs-var">ClosureCode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; Operand) -&gt; Constant -&gt; Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Integer -&gt; Constant
</span><span class="hs-identifier hs-var">Int</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">32</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span>
</span><span id="line-97"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#indicesForComponent"><span class="hs-identifier hs-var">indicesForComponent</span></a></span><span> </span><span class="annot"><span class="annottext">ClosureComponent
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ClosurePrint"><span class="hs-identifier hs-var">ClosurePrint</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; Operand) -&gt; Constant -&gt; Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Integer -&gt; Constant
</span><span class="hs-identifier hs-var">Int</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">32</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-98"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#indicesForComponent"><span class="hs-identifier hs-var">indicesForComponent</span></a></span><span> </span><span class="annot"><span class="annottext">ClosureComponent
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureFlags"><span class="hs-identifier hs-var">ClosureFlags</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; Operand) -&gt; Constant -&gt; Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Integer -&gt; Constant
</span><span class="hs-identifier hs-var">Int</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">32</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">2</span></span><span class="hs-special">]</span><span>
</span><span id="line-99"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#indicesForComponent"><span class="hs-identifier hs-var">indicesForComponent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureFreeVar"><span class="hs-identifier hs-type">ClosureFreeVar</span></a></span><span> </span><span id="local-6989586621679261266"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679261266"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; Operand) -&gt; Constant -&gt; Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Integer -&gt; Constant
</span><span class="hs-identifier hs-var">Int</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">32</span></span><span> </span><span class="annot"><span class="annottext">Integer
forall a. Num a =&gt; a
</span><a href="Hachi.Compiler.CodeGen.Closure.html#closureSize"><span class="hs-identifier hs-var">closureSize</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; Operand) -&gt; Constant -&gt; Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Integer -&gt; Constant
</span><span class="hs-identifier hs-var">Int</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">32</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679261266"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-101"></span><span>
</span><span id="line-102"></span><span class="hs-comment">-- | `fnTyForComponent` @component@ determines the function type for the</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- closure function identified by @component@.</span><span>
</span><span id="line-104"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#fnTyForComponent"><span class="hs-identifier hs-type">fnTyForComponent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureComponent"><span class="hs-identifier hs-type">ClosureComponent</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span>
</span><span id="line-105"></span><span id="fnTyForComponent"><span class="annot"><span class="annottext">fnTyForComponent :: ClosureComponent -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Closure.html#fnTyForComponent"><span class="hs-identifier hs-var hs-var">fnTyForComponent</span></a></span></span><span> </span><span class="annot"><span class="annottext">ClosureComponent
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureCode"><span class="hs-identifier hs-var">ClosureCode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Closure.html#clsEntryTy"><span class="hs-identifier hs-var">clsEntryTy</span></a></span><span>
</span><span id="line-106"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#fnTyForComponent"><span class="hs-identifier hs-var">fnTyForComponent</span></a></span><span> </span><span class="annot"><span class="annottext">ClosureComponent
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ClosurePrint"><span class="hs-identifier hs-var">ClosurePrint</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Closure.html#printFnTy"><span class="hs-identifier hs-var">printFnTy</span></a></span><span>
</span><span id="line-107"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#fnTyForComponent"><span class="hs-identifier hs-var">fnTyForComponent</span></a></span><span> </span><span class="annot"><span class="annottext">ClosureComponent
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Type
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;fnTyForComponent called on non-function component&quot;</span></span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span class="hs-comment">-- | `mkEntryTy` @arity@ generates a function signature for a closure</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- with @arity@-many parameters in addition to the parameter that</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- references the closure itself. In other words, the resulting</span><span>
</span><span id="line-114"></span><span class="hs-comment">-- signature has 1+@arity@ many parameters.</span><span>
</span><span id="line-115"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#mkEntryTy"><span class="hs-identifier hs-type">mkEntryTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span>
</span><span id="line-116"></span><span id="mkEntryTy"><span class="annot"><span class="annottext">mkEntryTy :: Int -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Closure.html#mkEntryTy"><span class="hs-identifier hs-var hs-var">mkEntryTy</span></a></span></span><span> </span><span id="local-6989586621679261263"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679261263"><span class="hs-identifier hs-var">arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#ptrOf"><span class="hs-identifier hs-var">ptrOf</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; Type -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; Bool -&gt; Type
</span><span class="hs-identifier hs-var">FunctionType</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679261261"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-117"></span><span>    </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679261261"><span class="annot"><span class="annottext">params :: [Type]
</span><a href="#local-6989586621679261261"><span class="hs-identifier hs-var hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; [Type]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type -&gt; [Type]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679261263"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span class="hs-comment">-- | `clsParamTys` is the list of parameter `Type`s for closure</span><span>
</span><span id="line-120"></span><span class="hs-comment">-- entry functions.</span><span>
</span><span id="line-121"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#clsParamTys"><span class="hs-identifier hs-type">clsParamTys</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span class="hs-special">]</span><span>
</span><span id="line-122"></span><span id="clsParamTys"><span class="annot"><span class="annottext">clsParamTys :: [Type]
</span><a href="Hachi.Compiler.CodeGen.Closure.html#clsParamTys"><span class="hs-identifier hs-var hs-var">clsParamTys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#contTyPtr"><span class="hs-identifier hs-var">contTyPtr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span class="hs-comment">-- | `clsEntryTy` is the `Type` of closure entry functions.</span><span>
</span><span id="line-125"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#clsEntryTy"><span class="hs-identifier hs-type">clsEntryTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span>
</span><span id="line-126"></span><span id="clsEntryTy"><span class="annot"><span class="annottext">clsEntryTy :: Type
</span><a href="Hachi.Compiler.CodeGen.Closure.html#clsEntryTy"><span class="hs-identifier hs-var hs-var">clsEntryTy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#ptrOf"><span class="hs-identifier hs-var">ptrOf</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; Type -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; Bool -&gt; Type
</span><span class="hs-identifier hs-var">FunctionType</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="Hachi.Compiler.CodeGen.Closure.html#clsParamTys"><span class="hs-identifier hs-var">clsParamTys</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span class="hs-comment">-- | `clsEntryParams` @varName@ constructs a list of parameters for a closure's</span><span>
</span><span id="line-129"></span><span class="hs-comment">-- entry function, where @varName@ is the name of the variable being bound.</span><span>
</span><span id="line-130"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#clsEntryParams"><span class="hs-identifier hs-type">clsEntryParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ParameterName</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-131"></span><span id="clsEntryParams"><span class="annot"><span class="annottext">clsEntryParams :: Text -&gt; [(Type, ParameterName)]
</span><a href="Hachi.Compiler.CodeGen.Closure.html#clsEntryParams"><span class="hs-identifier hs-var hs-var">clsEntryParams</span></a></span></span><span> </span><span id="local-6989586621679261257"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679261257"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [ParameterName] -&gt; [(Type, ParameterName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="Hachi.Compiler.CodeGen.Closure.html#clsParamTys"><span class="hs-identifier hs-var">clsParamTys</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ParameterName
</span><span class="hs-string">&quot;this&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text -&gt; ParameterName
</span><a href="Hachi.Compiler.CodeGen.Common.html#mkParamName"><span class="hs-identifier hs-var">mkParamName</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679261257"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ParameterName
</span><span class="hs-string">&quot;k&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#varEntryTy"><span class="hs-identifier hs-type">varEntryTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span>
</span><span id="line-134"></span><span id="varEntryTy"><span class="annot"><span class="annottext">varEntryTy :: Type
</span><a href="Hachi.Compiler.CodeGen.Closure.html#varEntryTy"><span class="hs-identifier hs-var hs-var">varEntryTy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Closure.html#mkEntryTy"><span class="hs-identifier hs-var">mkEntryTy</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span class="hs-comment">-- | `printFnTy` is the `Type` of closure print functions. They are similar to</span><span>
</span><span id="line-137"></span><span class="hs-comment">-- closure entry functions in that they take a pointer to the current closure</span><span>
</span><span id="line-138"></span><span class="hs-comment">-- as argument, but return nothing.</span><span>
</span><span id="line-139"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#printFnTy"><span class="hs-identifier hs-type">printFnTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span>
</span><span id="line-140"></span><span id="printFnTy"><span class="annot"><span class="annottext">printFnTy :: Type
</span><a href="Hachi.Compiler.CodeGen.Closure.html#printFnTy"><span class="hs-identifier hs-var hs-var">printFnTy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#ptrOf"><span class="hs-identifier hs-var">ptrOf</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; Type -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; Bool -&gt; Type
</span><span class="hs-identifier hs-var">FunctionType</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier hs-var">VoidType</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="hs-comment">-- | `mkClosureName` @name@ returns the name of a closure for @name@.</span><span>
</span><span id="line-143"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#mkClosureName"><span class="hs-identifier hs-type">mkClosureName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span>
</span><span id="line-144"></span><span id="mkClosureName"><span class="annot"><span class="annottext">mkClosureName :: String -&gt; Name
</span><a href="Hachi.Compiler.CodeGen.Closure.html#mkClosureName"><span class="hs-identifier hs-var hs-var">mkClosureName</span></a></span></span><span> </span><span id="local-6989586621679261254"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261254"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">mkName</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Name) -&gt; String -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261254"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_closure&quot;</span></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="hs-comment">-- | `compileClosure` @isPoly name entryPtr printPtr@ generates a global</span><span>
</span><span id="line-147"></span><span class="hs-comment">-- variable representing a closure for @name@.</span><span>
</span><span id="line-148"></span><span id="local-6989586621679261252"><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#compileClosure"><span class="hs-identifier hs-type">compileClosure</span></a></span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadModuleBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679261252"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-150"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-151"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-152"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Constant</span></span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Constant</span></span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Constant</span></span><span class="hs-special">]</span><span>
</span><span id="line-155"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679261252"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#StaticPtr"><span class="hs-identifier hs-type">StaticPtr</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-156"></span><span id="compileClosure"><span class="annot"><span class="annottext">compileClosure :: Bool
-&gt; String
-&gt; Constant
-&gt; Constant
-&gt; [Constant]
-&gt; m (ClosurePtr 'StaticPtr)
</span><a href="Hachi.Compiler.CodeGen.Closure.html#compileClosure"><span class="hs-identifier hs-var hs-var">compileClosure</span></a></span></span><span> </span><span id="local-6989586621679261251"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679261251"><span class="hs-identifier hs-var">isPoly</span></a></span></span><span> </span><span id="local-6989586621679261250"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261250"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679261249"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679261249"><span class="hs-identifier hs-var">codePtr</span></a></span></span><span> </span><span id="local-6989586621679261248"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679261248"><span class="hs-identifier hs-var">printPtr</span></a></span></span><span> </span><span id="local-6989586621679261247"><span class="annot"><span class="annottext">[Constant]
</span><a href="#local-6989586621679261247"><span class="hs-identifier hs-var">fvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261246"><span class="annot"><span class="annottext">closureName :: Name
</span><a href="#local-6989586621679261246"><span class="hs-identifier hs-var hs-var">closureName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><a href="Hachi.Compiler.CodeGen.Closure.html#mkClosureName"><span class="hs-identifier hs-var">mkClosureName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261250"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-158"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261245"><span class="annot"><span class="annottext">closureType :: Type
</span><a href="#local-6989586621679261245"><span class="hs-identifier hs-var hs-var">closureType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; [Type] -&gt; Type
</span><span class="hs-identifier hs-var">StructureType</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-159"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Closure.html#clsEntryTy"><span class="hs-identifier hs-var">clsEntryTy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Closure.html#printFnTy"><span class="hs-identifier hs-var">printFnTy</span></a></span><span>
</span><span id="line-160"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.Platform.html#iHost"><span class="hs-identifier hs-var">iHost</span></a></span><span>
</span><span id="line-161"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Type -&gt; Type
</span><span class="hs-identifier hs-var">ArrayType</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Word64) -&gt; Int -&gt; Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Constant] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Constant]
</span><a href="#local-6989586621679261247"><span class="hs-identifier hs-var">fvs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#ptrOf"><span class="hs-identifier hs-var">ptrOf</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#i8"><span class="hs-identifier hs-var">i8</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-163"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261243"><span class="annot"><span class="annottext">closureVal :: Constant
</span><a href="#local-6989586621679261243"><span class="hs-identifier hs-var hs-var">closureVal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Name -&gt; Bool -&gt; [Constant] -&gt; Constant
</span><span class="hs-identifier hs-var">Struct</span></span><span> </span><span class="annot"><span class="annottext">Maybe Name
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">([Constant] -&gt; Constant) -&gt; [Constant] -&gt; Constant
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-164"></span><span>            </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679261249"><span class="hs-identifier hs-var">codePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Constant -&gt; [Constant] -&gt; [Constant]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679261248"><span class="hs-identifier hs-var">printPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Constant -&gt; [Constant] -&gt; [Constant]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Integer -&gt; Constant
</span><span class="hs-identifier hs-var">Int</span></span><span> </span><span class="annot"><span class="annottext">Word32
forall a. Num a =&gt; a
</span><a href="Hachi.Compiler.Platform.html#platformIntSize"><span class="hs-identifier hs-var">platformIntSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Integer
forall a. Integral a =&gt; a -&gt; Integer
</span><span class="hs-identifier hs-var">toInteger</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Integer) -&gt; Int -&gt; Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Int
forall a. Enum a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">fromEnum</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679261251"><span class="hs-identifier hs-var">isPoly</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Constant -&gt; [Constant] -&gt; [Constant]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span>
</span><span id="line-165"></span><span>            </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type -&gt; [Constant] -&gt; Constant
</span><span class="hs-identifier hs-var">Array</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#ptrOf"><span class="hs-identifier hs-var">ptrOf</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#i8"><span class="hs-identifier hs-var">i8</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Constant] -&gt; Constant) -&gt; [Constant] -&gt; Constant
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; Constant) -&gt; [Constant] -&gt; [Constant]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Constant -&gt; Type -&gt; Constant
</span><span class="hs-operator hs-var">`C.BitCast`</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#ptrOf"><span class="hs-identifier hs-var">ptrOf</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#i8"><span class="hs-identifier hs-var">i8</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Constant]
</span><a href="#local-6989586621679261247"><span class="hs-identifier hs-var">fvs</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span>    </span><span class="annot"><span class="annottext">m Operand -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m Operand -&gt; m ()) -&gt; m Operand -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Type -&gt; Constant -&gt; (Global -&gt; Global) -&gt; m Operand
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Name -&gt; Type -&gt; Constant -&gt; (Global -&gt; Global) -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#global"><span class="hs-identifier hs-var">global</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679261246"><span class="hs-identifier hs-var">closureName</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679261245"><span class="hs-identifier hs-var">closureType</span></a></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679261243"><span class="hs-identifier hs-var">closureVal</span></a></span><span> </span><span class="annot"><span class="annottext">((Global -&gt; Global) -&gt; m Operand)
-&gt; (Global -&gt; Global) -&gt; m Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Linkage -&gt; Global -&gt; Global
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#setLinkage"><span class="hs-identifier hs-var">setLinkage</span></a></span><span> </span><span class="annot"><span class="annottext">Linkage
</span><span class="hs-identifier hs-var">Private</span></span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span>    </span><span class="annot"><span class="annottext">ClosurePtr 'StaticPtr -&gt; m (ClosurePtr 'StaticPtr)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ClosurePtr 'StaticPtr -&gt; m (ClosurePtr 'StaticPtr))
-&gt; ClosurePtr 'StaticPtr -&gt; m (ClosurePtr 'StaticPtr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Constant -&gt; ClosurePtr 'StaticPtr
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkStaticClosurePtr"><span class="hs-identifier hs-var">MkStaticClosurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; ClosurePtr 'StaticPtr)
-&gt; Constant -&gt; ClosurePtr 'StaticPtr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-170"></span><span>        </span><span class="annot"><span class="annottext">Type -&gt; Name -&gt; Constant
</span><span class="hs-identifier hs-var">GlobalReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; AddrSpace -&gt; Type
</span><span class="hs-identifier hs-var">PointerType</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679261245"><span class="hs-identifier hs-var">closureType</span></a></span><span> </span><span class="annot"><span class="annottext">(AddrSpace -&gt; Type) -&gt; AddrSpace -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; AddrSpace
</span><span class="hs-identifier hs-var">AddrSpace</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679261246"><span class="hs-identifier hs-var">closureName</span></a></span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span class="hs-comment">-- | When we dynamically allocate closures, we need to know how much space to</span><span>
</span><span id="line-173"></span><span class="hs-comment">-- allocate for the pointers; for this purpose we are currently assuming that</span><span>
</span><span id="line-174"></span><span class="hs-comment">-- we are running on a 64-bit system.</span><span>
</span><span id="line-175"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#bits"><span class="hs-identifier hs-type">bits</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>
</span><span id="line-176"></span><span id="bits"><span class="annot"><span class="annottext">bits :: Word32
</span><a href="Hachi.Compiler.CodeGen.Closure.html#bits"><span class="hs-identifier hs-var hs-var">bits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">64</span></span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span class="hs-comment">-- | The size of a pointer as an `Operand`. This should correspond to the</span><span>
</span><span id="line-179"></span><span class="hs-comment">-- value given by `bits`.</span><span>
</span><span id="line-180"></span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#ptrSize"><span class="hs-identifier hs-type">ptrSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Operand</span></span><span>
</span><span id="line-181"></span><span id="ptrSize"><span class="annot"><span class="annottext">ptrSize :: Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ptrSize"><span class="hs-identifier hs-var hs-var">ptrSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; Operand) -&gt; Constant -&gt; Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Type -&gt; Constant
</span><span class="hs-identifier hs-var">C.sizeof</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="Hachi.Compiler.CodeGen.Closure.html#bits"><span class="hs-identifier hs-var">bits</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span class="hs-comment">-- | A class of types which represent runtime structures that contain</span><span>
</span><span id="line-184"></span><span class="hs-comment">-- free variables.</span><span>
</span><span id="line-185"></span><span class="hs-keyword">class</span><span> </span><span id="HasFreeVars"><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#HasFreeVars"><span class="hs-identifier hs-var">HasFreeVars</span></a></span></span><span> </span><span id="local-6989586621679261431"><span class="annot"><a href="#local-6989586621679261431"><span class="hs-identifier hs-type">ptr</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-comment">-- | `loadFreeVar` @ptr type index@ loads the free variable at @index@</span><span>
</span><span id="line-187"></span><span>    </span><span class="hs-comment">-- of the closure-like structure pointed to by @ptr@. If required,</span><span>
</span><span id="line-188"></span><span>    </span><span class="hs-comment">-- the resulting `Operand` is cast to @type@.</span><span>
</span><span id="line-189"></span><span>    </span><span id="local-6989586621679261435"><span id="loadFreeVar"><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#loadFreeVar"><span class="hs-identifier hs-type">loadFreeVar</span></a></span></span><span>
</span><span id="line-190"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadModuleBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679261435"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679261435"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679261431"><span class="hs-identifier hs-type">ptr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integer</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679261435"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Operand</span></span></span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span id="local-6989586621679261227"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#HasFreeVars"><span class="hs-identifier hs-type">HasFreeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261227"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-194"></span><span>    </span><span id="local-6989586621679261224"><span class="annot"><span class="annottext">loadFreeVar :: ClosurePtr k -&gt; Type -&gt; Integer -&gt; m Operand
</span><a href="#local-6989586621679261224"><span class="hs-identifier hs-var hs-var hs-var hs-var">loadFreeVar</span></a></span></span><span> </span><span id="local-6989586621679261223"><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679261223"><span class="hs-identifier hs-var">this</span></a></span></span><span> </span><span id="local-6989586621679261222"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679261222"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621679261221"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679261221"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#loadFromClosure"><span class="hs-identifier hs-var">loadFromClosure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; ClosureComponent
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureFreeVar"><span class="hs-identifier hs-var">ClosureFreeVar</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679261221"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679261222"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679261223"><span class="hs-identifier hs-var">this</span></a></span></span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#HasFreeVars"><span class="hs-identifier hs-type">HasFreeVars</span></a></span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#Continuation"><span class="hs-identifier hs-type">Continuation</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-197"></span><span>    </span><span id="local-6989586621679261219"><span class="annot"><span class="annottext">loadFreeVar :: Continuation -&gt; Type -&gt; Integer -&gt; m Operand
</span><a href="#local-6989586621679261219"><span class="hs-identifier hs-var hs-var hs-var hs-var">loadFreeVar</span></a></span></span><span> </span><span id="local-6989586621679261218"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679261218"><span class="hs-identifier hs-var">this</span></a></span></span><span> </span><span id="local-6989586621679261217"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679261217"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621679261216"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679261216"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-198"></span><span>        </span><span id="local-6989586621679261215"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261215"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Operand -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Type -&gt; Operand -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#castIfNeeded"><span class="hs-identifier hs-var">castIfNeeded</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#contTyPtr"><span class="hs-identifier hs-var">contTyPtr</span></a></span><span> </span><span class="annot"><span class="annottext">(Operand -&gt; m Operand) -&gt; Operand -&gt; m Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Continuation -&gt; Operand
</span><a href="Hachi.Compiler.CodeGen.Types.html#contPtr"><span class="hs-identifier hs-var hs-var">contPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679261218"><span class="hs-identifier hs-var">this</span></a></span><span>
</span><span id="line-199"></span><span>        </span><span id="local-6989586621679261212"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261212"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; m Operand
forall (m :: * -&gt; *).
(HasCallStack, MonadIRBuilder m, MonadModuleBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><span class="hs-identifier hs-var">gep</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261215"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-200"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; Integer -&gt; Constant
</span><span class="hs-identifier hs-var">Int</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">32</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; Integer -&gt; Constant
</span><span class="hs-identifier hs-var">Int</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">32</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; Integer -&gt; Constant
</span><span class="hs-identifier hs-var">Int</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">32</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679261216"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-204"></span><span>        </span><span class="annot"><span class="annottext">Operand -&gt; Word32 -&gt; m Operand
forall (m :: * -&gt; *).
(HasCallStack, MonadIRBuilder m, MonadModuleBuilder m) =&gt;
Operand -&gt; Word32 -&gt; m Operand
</span><span class="hs-identifier hs-var">load</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261212"><span class="hs-identifier hs-var">addr</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">m Operand -&gt; (Operand -&gt; m Operand) -&gt; m Operand
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Operand -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Type -&gt; Operand -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#castIfNeeded"><span class="hs-identifier hs-var">castIfNeeded</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#ptrOf"><span class="hs-identifier hs-var">ptrOf</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679261217"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span class="hs-comment">-- | `allocateClosure` @isDelay codePtr printPtr freeVars@ allocates a closure</span><span>
</span><span id="line-207"></span><span class="hs-comment">-- with enough space to store all of @freeVars@ in addition to the code</span><span>
</span><span id="line-208"></span><span class="hs-comment">-- pointers. The code pointers are free variables are stored in the closure and</span><span>
</span><span id="line-209"></span><span class="hs-comment">-- the pointer to the closure is returned.</span><span>
</span><span id="line-210"></span><span id="local-6989586621679261357"><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#allocateClosure"><span class="hs-identifier hs-type">allocateClosure</span></a></span><span>
</span><span id="line-211"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#MonadCodeGen"><span class="hs-identifier hs-type">MonadCodeGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261357"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679261357"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Constant</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Constant</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Operand</span></span><span class="hs-special">]</span><span>
</span><span id="line-213"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679261357"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#DynamicPtr"><span class="hs-identifier hs-type">DynamicPtr</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-214"></span><span id="allocateClosure"><span class="annot"><span class="annottext">allocateClosure :: Bool
-&gt; Constant -&gt; Constant -&gt; [Operand] -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Closure.html#allocateClosure"><span class="hs-identifier hs-var hs-var">allocateClosure</span></a></span></span><span> </span><span id="local-6989586621679261209"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679261209"><span class="hs-identifier hs-var">isDelay</span></a></span></span><span> </span><span id="local-6989586621679261208"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679261208"><span class="hs-identifier hs-var">codePtr</span></a></span></span><span> </span><span id="local-6989586621679261207"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679261207"><span class="hs-identifier hs-var">printPtr</span></a></span></span><span> </span><span id="local-6989586621679261206"><span class="annot"><span class="annottext">[Operand]
</span><a href="#local-6989586621679261206"><span class="hs-identifier hs-var">fvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-215"></span><span>    </span><span class="hs-comment">-- allocate enough space for the closure on the heap:</span><span>
</span><span id="line-216"></span><span>    </span><span class="hs-comment">-- 2 code pointers + one pointer for each free variable</span><span>
</span><span id="line-217"></span><span>    </span><span id="local-6989586621679261205"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261205"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; Operand -&gt; m Operand
forall (m :: * -&gt; *).
(MonadIRBuilder m, MonadModuleBuilder m) =&gt;
Operand -&gt; Operand -&gt; m Operand
</span><span class="hs-identifier hs-var">mul</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ptrSize"><span class="hs-identifier hs-var">ptrSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; Operand) -&gt; Constant -&gt; Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Integer -&gt; Constant
</span><span class="hs-identifier hs-var">Int</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="Hachi.Compiler.CodeGen.Closure.html#bits"><span class="hs-identifier hs-var">bits</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Constant) -&gt; Integer -&gt; Constant
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Integer
forall a. Num a =&gt; a
</span><a href="Hachi.Compiler.CodeGen.Closure.html#closureSize"><span class="hs-identifier hs-var">closureSize</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">[Operand] -&gt; Integer
forall i a. Num i =&gt; [a] -&gt; i
</span><span class="hs-identifier hs-var">genericLength</span></span><span> </span><span class="annot"><span class="annottext">[Operand]
</span><a href="#local-6989586621679261206"><span class="hs-identifier hs-var">fvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>    </span><span id="local-6989586621679261201"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261201"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Operand -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m, MonadCodeGen m) =&gt;
Type -&gt; Operand -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#malloc"><span class="hs-identifier hs-var">malloc</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261205"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-219"></span><span>
</span><span id="line-220"></span><span>    </span><span class="hs-comment">-- store data in the closure: we have the function pointers followed by</span><span>
</span><span id="line-221"></span><span>    </span><span class="hs-comment">-- any pointers to free variables</span><span>
</span><span id="line-222"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261199"><span class="annot"><span class="annottext">storeAt :: [Operand] -&gt; Operand -&gt; m ()
</span><a href="#local-6989586621679261199"><span class="hs-identifier hs-var hs-var">storeAt</span></a></span></span><span> </span><span id="local-6989586621679261198"><span class="annot"><span class="annottext">[Operand]
</span><a href="#local-6989586621679261198"><span class="hs-identifier hs-var">ixs</span></a></span></span><span> </span><span id="local-6989586621679261197"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261197"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-223"></span><span>            </span><span id="local-6989586621679261196"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261196"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; m Operand
forall (m :: * -&gt; *).
(HasCallStack, MonadIRBuilder m, MonadModuleBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><span class="hs-identifier hs-var">gep</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261201"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">([Operand] -&gt; m Operand) -&gt; [Operand] -&gt; m Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; Integer -&gt; Constant
</span><span class="hs-identifier hs-var">Int</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">32</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; [Operand]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Operand]
</span><a href="#local-6989586621679261198"><span class="hs-identifier hs-var">ixs</span></a></span><span>
</span><span id="line-224"></span><span>            </span><span class="annot"><span class="annottext">Operand -&gt; Word32 -&gt; Operand -&gt; m ()
forall (m :: * -&gt; *).
MonadIRBuilder m =&gt;
Operand -&gt; Word32 -&gt; Operand -&gt; m ()
</span><span class="hs-identifier hs-var">store</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261196"><span class="hs-identifier hs-var">addr</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261197"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span>    </span><span class="annot"><span class="annottext">[Operand] -&gt; Operand -&gt; m ()
</span><a href="#local-6989586621679261199"><span class="hs-identifier hs-var">storeAt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClosureComponent -&gt; [Operand]
</span><a href="Hachi.Compiler.CodeGen.Closure.html#indicesForComponent"><span class="hs-identifier hs-var">indicesForComponent</span></a></span><span> </span><span class="annot"><span class="annottext">ClosureComponent
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureCode"><span class="hs-identifier hs-var">ClosureCode</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Operand -&gt; m ()) -&gt; Operand -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679261208"><span class="hs-identifier hs-var">codePtr</span></a></span><span>
</span><span id="line-227"></span><span>    </span><span class="annot"><span class="annottext">[Operand] -&gt; Operand -&gt; m ()
</span><a href="#local-6989586621679261199"><span class="hs-identifier hs-var">storeAt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClosureComponent -&gt; [Operand]
</span><a href="Hachi.Compiler.CodeGen.Closure.html#indicesForComponent"><span class="hs-identifier hs-var">indicesForComponent</span></a></span><span> </span><span class="annot"><span class="annottext">ClosureComponent
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ClosurePrint"><span class="hs-identifier hs-var">ClosurePrint</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Operand -&gt; m ()) -&gt; Operand -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679261207"><span class="hs-identifier hs-var">printPtr</span></a></span><span>
</span><span id="line-228"></span><span>    </span><span class="annot"><span class="annottext">[Operand] -&gt; Operand -&gt; m ()
</span><a href="#local-6989586621679261199"><span class="hs-identifier hs-var">storeAt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClosureComponent -&gt; [Operand]
</span><a href="Hachi.Compiler.CodeGen.Closure.html#indicesForComponent"><span class="hs-identifier hs-var">indicesForComponent</span></a></span><span> </span><span class="annot"><span class="annottext">ClosureComponent
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureFlags"><span class="hs-identifier hs-var">ClosureFlags</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Operand -&gt; m ()) -&gt; Operand -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; Operand) -&gt; Constant -&gt; Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-229"></span><span>        </span><span class="annot"><span class="annottext">Word32 -&gt; Integer -&gt; Constant
</span><span class="hs-identifier hs-var">Int</span></span><span> </span><span class="annot"><span class="annottext">Word32
forall a. Num a =&gt; a
</span><a href="Hachi.Compiler.Platform.html#platformIntSize"><span class="hs-identifier hs-var">platformIntSize</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Constant) -&gt; Integer -&gt; Constant
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Integer
forall a. Integral a =&gt; a -&gt; Integer
</span><span class="hs-identifier hs-var">toInteger</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Integer) -&gt; Int -&gt; Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Int
forall a. Enum a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">fromEnum</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679261209"><span class="hs-identifier hs-var">isDelay</span></a></span><span>
</span><span id="line-230"></span><span>
</span><span id="line-231"></span><span>    </span><span class="annot"><span class="annottext">[(Integer, Operand)] -&gt; ((Integer, Operand) -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Integer] -&gt; [Operand] -&gt; [(Integer, Operand)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Operand]
</span><a href="#local-6989586621679261206"><span class="hs-identifier hs-var">fvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Integer, Operand) -&gt; m ()) -&gt; m ())
-&gt; ((Integer, Operand) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679261193"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679261193"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679261192"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261192"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-232"></span><span>        </span><span id="local-6989586621679261191"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261191"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; Type -&gt; m Operand
forall (m :: * -&gt; *).
MonadIRBuilder m =&gt;
Operand -&gt; Type -&gt; m Operand
</span><span class="hs-identifier hs-var">bitcast</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261192"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#ptrOf"><span class="hs-identifier hs-var">ptrOf</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#i8"><span class="hs-identifier hs-var">i8</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-233"></span><span>        </span><span class="annot"><span class="annottext">[Operand] -&gt; Operand -&gt; m ()
</span><a href="#local-6989586621679261199"><span class="hs-identifier hs-var">storeAt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClosureComponent -&gt; [Operand]
</span><a href="Hachi.Compiler.CodeGen.Closure.html#indicesForComponent"><span class="hs-identifier hs-var">indicesForComponent</span></a></span><span> </span><span class="annot"><span class="annottext">(ClosureComponent -&gt; [Operand]) -&gt; ClosureComponent -&gt; [Operand]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; ClosureComponent
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureFreeVar"><span class="hs-identifier hs-var">ClosureFreeVar</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679261193"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261191"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-234"></span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-comment">-- return an Operand representing a pointer to the dynamic closure that we</span><span>
</span><span id="line-236"></span><span>    </span><span class="hs-comment">-- have just created</span><span>
</span><span id="line-237"></span><span>    </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; m (ClosurePtr 'DynamicPtr)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ClosurePtr 'DynamicPtr -&gt; m (ClosurePtr 'DynamicPtr))
-&gt; ClosurePtr 'DynamicPtr -&gt; m (ClosurePtr 'DynamicPtr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; ClosurePtr 'DynamicPtr
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkClosurePtr"><span class="hs-identifier hs-var">MkClosurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261201"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span class="hs-comment">-- | `withFreeVars` @ptr computation@ runs @computation@ after retrieving all</span><span>
</span><span id="line-240"></span><span class="hs-comment">-- free variables from the closure-like structure pointed to by @ptr@.</span><span>
</span><span id="line-241"></span><span id="local-6989586621679261365"><span id="local-6989586621679261366"><span id="local-6989586621679261367"><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#withFreeVars"><span class="hs-identifier hs-type">withFreeVars</span></a></span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#HasFreeVars"><span class="hs-identifier hs-type">HasFreeVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261367"><span class="hs-identifier hs-type">ptr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#MonadCodeGen"><span class="hs-identifier hs-type">MonadCodeGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261366"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679261366"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679261367"><span class="hs-identifier hs-type">ptr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679261366"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261365"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679261366"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261365"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-244"></span><span id="withFreeVars"><span class="annot"><span class="annottext">withFreeVars :: ptr -&gt; m a -&gt; m a
</span><a href="Hachi.Compiler.CodeGen.Closure.html#withFreeVars"><span class="hs-identifier hs-var hs-var">withFreeVars</span></a></span></span><span> </span><span id="local-6989586621679261188"><span class="annot"><span class="annottext">ptr
</span><a href="#local-6989586621679261188"><span class="hs-identifier hs-var">this</span></a></span></span><span> </span><span id="local-6989586621679261187"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679261187"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-245"></span><span>    </span><span id="local-6989586621679261186"><span class="annot"><span class="annottext">Set (Text, Bool)
</span><a href="#local-6989586621679261186"><span class="hs-identifier hs-var">fvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Set (Text, Bool))
forall (m :: * -&gt; *).
MonadReader CodeGenSt m =&gt;
m (Set (Text, Bool))
</span><a href="Hachi.Compiler.CodeGen.Monad.html#currentFreeVars"><span class="hs-identifier hs-var">currentFreeVars</span></a></span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span>    </span><span class="hs-comment">-- we need to load the free variables from the closure pointed to</span><span>
</span><span id="line-248"></span><span>    </span><span class="hs-comment">-- by `this`, which are stored at offset 3 onwards; note that the</span><span>
</span><span id="line-249"></span><span>    </span><span class="hs-comment">-- free variables are stored in alphabetical order and the code</span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-comment">-- which loads them here must correspond to the code that stores</span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-comment">-- them further down</span><span>
</span><span id="line-252"></span><span>    </span><span id="local-6989586621679261184"><span class="annot"><span class="annottext">[Local]
</span><a href="#local-6989586621679261184"><span class="hs-identifier hs-var">cvars</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Integer, (Text, Bool))]
-&gt; ((Integer, (Text, Bool)) -&gt; m Local) -&gt; m [Local]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Integer] -&gt; [(Text, Bool)] -&gt; [(Integer, (Text, Bool))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">([(Text, Bool)] -&gt; [(Integer, (Text, Bool))])
-&gt; [(Text, Bool)] -&gt; [(Integer, (Text, Bool))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set (Text, Bool) -&gt; [(Text, Bool)]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">Set (Text, Bool)
</span><a href="#local-6989586621679261186"><span class="hs-identifier hs-var">fvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Integer, (Text, Bool)) -&gt; m Local) -&gt; m [Local])
-&gt; ((Integer, (Text, Bool)) -&gt; m Local) -&gt; m [Local]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-253"></span><span>        </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679261181"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679261181"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621679261180"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679261180"><span class="hs-identifier hs-var">isCont</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-254"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679261180"><span class="hs-identifier hs-var">isCont</span></a></span><span>
</span><span id="line-255"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Continuation -&gt; Local
</span><a href="Hachi.Compiler.CodeGen.Types.html#LocalCont"><span class="hs-identifier hs-var">LocalCont</span></a></span><span> </span><span class="annot"><span class="annottext">(Continuation -&gt; Local)
-&gt; (Operand -&gt; Continuation) -&gt; Operand -&gt; Local
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; Continuation
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkCont"><span class="hs-identifier hs-var">MkCont</span></a></span><span> </span><span class="annot"><span class="annottext">(Operand -&gt; Local) -&gt; m Operand -&gt; m Local
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ptr -&gt; Type -&gt; Integer -&gt; m Operand
forall ptr (m :: * -&gt; *).
(HasFreeVars ptr, MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ptr -&gt; Type -&gt; Integer -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#loadFreeVar"><span class="hs-identifier hs-var">loadFreeVar</span></a></span><span> </span><span class="annot"><span class="annottext">ptr
</span><a href="#local-6989586621679261188"><span class="hs-identifier hs-var">this</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#contTyPtr"><span class="hs-identifier hs-var">contTyPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679261181"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-256"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; Local
</span><a href="Hachi.Compiler.CodeGen.Types.html#LocalClosure"><span class="hs-identifier hs-var">LocalClosure</span></a></span><span> </span><span class="annot"><span class="annottext">(ClosurePtr 'DynamicPtr -&gt; Local)
-&gt; (Operand -&gt; ClosurePtr 'DynamicPtr) -&gt; Operand -&gt; Local
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; ClosurePtr 'DynamicPtr
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkClosurePtr"><span class="hs-identifier hs-var">MkClosurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">(Operand -&gt; Local) -&gt; m Operand -&gt; m Local
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span>
</span><span id="line-257"></span><span>                    </span><span class="annot"><span class="annottext">ptr -&gt; Type -&gt; Integer -&gt; m Operand
forall ptr (m :: * -&gt; *).
(HasFreeVars ptr, MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ptr -&gt; Type -&gt; Integer -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#loadFreeVar"><span class="hs-identifier hs-var">loadFreeVar</span></a></span><span> </span><span class="annot"><span class="annottext">ptr
</span><a href="#local-6989586621679261188"><span class="hs-identifier hs-var">this</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679261181"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span>    </span><span class="hs-comment">-- update the local environment with mappings to the free variables</span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-comment">-- we have obtained from the closure represented by `this` and</span><span>
</span><span id="line-261"></span><span>    </span><span class="hs-comment">-- compile the body of the function</span><span>
</span><span id="line-262"></span><span>    </span><span class="annot"><span class="annottext">Set Text -&gt; [Local] -&gt; m a -&gt; m a
forall (m :: * -&gt; *) a.
MonadReader CodeGenSt m =&gt;
Set Text -&gt; [Local] -&gt; m a -&gt; m a
</span><a href="Hachi.Compiler.CodeGen.Monad.html#updateEnv"><span class="hs-identifier hs-var">updateEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Text, Bool) -&gt; Text) -&gt; Set (Text, Bool) -&gt; Set Text
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="annot"><span class="annottext">(Text, Bool) -&gt; Text
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">Set (Text, Bool)
</span><a href="#local-6989586621679261186"><span class="hs-identifier hs-var">fvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Local]
</span><a href="#local-6989586621679261184"><span class="hs-identifier hs-var">cvars</span></a></span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679261187"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span class="hs-comment">-- | `compileDynamicClosure` @isDelay name freeVars var codeFun@ generates code</span><span>
</span><span id="line-265"></span><span class="hs-comment">-- which dynamically creates a new closure when executed. The static parts of</span><span>
</span><span id="line-266"></span><span class="hs-comment">-- the closure use @name@. The set given by @freeVars@ signals which variables</span><span>
</span><span id="line-267"></span><span class="hs-comment">-- should be stored in the closure's free variables array. The name given by</span><span>
</span><span id="line-268"></span><span class="hs-comment">-- @var@ is the variable that is bound by this closure. @codeFun@ is a</span><span>
</span><span id="line-269"></span><span class="hs-comment">-- computation which generates the code for the body of the closure.</span><span>
</span><span id="line-270"></span><span class="hs-comment">-- The function returns a `ClosurePtr` representing the new closure.</span><span>
</span><span id="line-271"></span><span id="local-6989586621679261172"><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#compileDynamicClosure"><span class="hs-identifier hs-type">compileDynamicClosure</span></a></span><span>
</span><span id="line-272"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#MonadCodeGen"><span class="hs-identifier hs-type">MonadCodeGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261172"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-273"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-274"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Operand</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Operand</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#Continuation"><span class="hs-identifier hs-type">Continuation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IRBuilderT</span></span><span> </span><span class="annot"><a href="#local-6989586621679261172"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-275"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IRBuilderT</span></span><span> </span><span class="annot"><a href="#local-6989586621679261172"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#DynamicPtr"><span class="hs-identifier hs-type">DynamicPtr</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-276"></span><span id="compileDynamicClosure"><span class="annot"><span class="annottext">compileDynamicClosure :: Bool
-&gt; String
-&gt; Set (Text, Bool)
-&gt; Text
-&gt; (Operand -&gt; Operand -&gt; Continuation -&gt; IRBuilderT m ())
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Closure.html#compileDynamicClosure"><span class="hs-identifier hs-var hs-var">compileDynamicClosure</span></a></span></span><span> </span><span id="local-6989586621679261171"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679261171"><span class="hs-identifier hs-var">isDelay</span></a></span></span><span> </span><span id="local-6989586621679261170"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261170"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679261169"><span class="annot"><span class="annottext">Set (Text, Bool)
</span><a href="#local-6989586621679261169"><span class="hs-identifier hs-var">fvs</span></a></span></span><span> </span><span id="local-6989586621679261168"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679261168"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span id="local-6989586621679261167"><span class="annot"><span class="annottext">Operand -&gt; Operand -&gt; Continuation -&gt; IRBuilderT m ()
</span><a href="#local-6989586621679261167"><span class="hs-identifier hs-var">codeFun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-277"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261166"><span class="annot"><span class="annottext">entryName :: Name
</span><a href="#local-6989586621679261166"><span class="hs-identifier hs-var hs-var">entryName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">mkName</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Name) -&gt; String -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261170"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_entry&quot;</span></span><span>
</span><span id="line-278"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261165"><span class="annot"><span class="annottext">entryParams :: [(Type, ParameterName)]
</span><a href="#local-6989586621679261165"><span class="hs-identifier hs-var hs-var">entryParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; [(Type, ParameterName)]
</span><a href="Hachi.Compiler.CodeGen.Closure.html#clsEntryParams"><span class="hs-identifier hs-var">clsEntryParams</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679261168"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span>    </span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Operand -&gt; IRBuilderT m Operand
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m Operand -&gt; IRBuilderT m Operand)
-&gt; m Operand -&gt; IRBuilderT m Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name
-&gt; [(Type, ParameterName)]
-&gt; Type
-&gt; (Global -&gt; Global)
-&gt; ([Operand] -&gt; IRBuilderT m ())
-&gt; m Operand
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Name
-&gt; [(Type, ParameterName)]
-&gt; Type
-&gt; (Global -&gt; Global)
-&gt; ([Operand] -&gt; IRBuilderT m ())
-&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#function"><span class="hs-identifier hs-var">IR.function</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679261166"><span class="hs-identifier hs-var">entryName</span></a></span><span> </span><span class="annot"><span class="annottext">[(Type, ParameterName)]
</span><a href="#local-6989586621679261165"><span class="hs-identifier hs-var">entryParams</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Global -&gt; Global
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#plcFunOpts"><span class="hs-identifier hs-var">plcFunOpts</span></a></span><span> </span><span class="annot"><span class="annottext">(([Operand] -&gt; IRBuilderT m ()) -&gt; m Operand)
-&gt; ([Operand] -&gt; IRBuilderT m ()) -&gt; m Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-281"></span><span>        </span><span class="hs-glyph">\</span><span class="hs-special">[</span><span id="local-6989586621679261161"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261161"><span class="hs-identifier hs-var">this</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261160"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261160"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261159"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261159"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-282"></span><span>            </span><span class="annot"><span class="annottext">Set (Text, Bool) -&gt; IRBuilderT m () -&gt; IRBuilderT m ()
forall (m :: * -&gt; *) a.
MonadReader CodeGenSt m =&gt;
Set (Text, Bool) -&gt; m a -&gt; m a
</span><a href="Hachi.Compiler.CodeGen.Monad.html#localFreeVars"><span class="hs-identifier hs-var">localFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Set (Text, Bool)
</span><a href="#local-6989586621679261169"><span class="hs-identifier hs-var">fvs</span></a></span><span> </span><span class="annot"><span class="annottext">(IRBuilderT m () -&gt; IRBuilderT m ())
-&gt; IRBuilderT m () -&gt; IRBuilderT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-283"></span><span>            </span><span class="annot"><span class="annottext">Text -&gt; Local -&gt; IRBuilderT m () -&gt; IRBuilderT m ()
forall (m :: * -&gt; *) a.
MonadReader CodeGenSt m =&gt;
Text -&gt; Local -&gt; m a -&gt; m a
</span><a href="Hachi.Compiler.CodeGen.Monad.html#extendScope"><span class="hs-identifier hs-var">extendScope</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679261168"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; Local
</span><a href="Hachi.Compiler.CodeGen.Types.html#LocalClosure"><span class="hs-identifier hs-var">LocalClosure</span></a></span><span> </span><span class="annot"><span class="annottext">(ClosurePtr 'DynamicPtr -&gt; Local)
-&gt; ClosurePtr 'DynamicPtr -&gt; Local
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; ClosurePtr 'DynamicPtr
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkClosurePtr"><span class="hs-identifier hs-var">MkClosurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261160"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IRBuilderT m () -&gt; IRBuilderT m ())
-&gt; IRBuilderT m () -&gt; IRBuilderT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-284"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; [Operand] -&gt; IRBuilderT m ()
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m) =&gt;
String -&gt; [Operand] -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Common.html#compileTrace"><span class="hs-identifier hs-var">compileTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261170"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_entry&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-285"></span><span>
</span><span id="line-286"></span><span>            </span><span class="hs-comment">-- update the local environment with mappings to the free variables</span><span>
</span><span id="line-287"></span><span>            </span><span class="hs-comment">-- we have obtained from the closure represented by `this` and</span><span>
</span><span id="line-288"></span><span>            </span><span class="hs-comment">-- compile the body of the function</span><span>
</span><span id="line-289"></span><span>            </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; IRBuilderT m () -&gt; IRBuilderT m ()
forall ptr (m :: * -&gt; *) a.
(HasFreeVars ptr, MonadCodeGen m, MonadIRBuilder m) =&gt;
ptr -&gt; m a -&gt; m a
</span><a href="Hachi.Compiler.CodeGen.Closure.html#withFreeVars"><span class="hs-identifier hs-var">withFreeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Operand -&gt; ClosurePtr 'DynamicPtr
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkClosurePtr"><span class="hs-identifier hs-var">MkClosurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261161"><span class="hs-identifier hs-var">this</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IRBuilderT m () -&gt; IRBuilderT m ())
-&gt; IRBuilderT m () -&gt; IRBuilderT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; Operand -&gt; Continuation -&gt; IRBuilderT m ()
</span><a href="#local-6989586621679261167"><span class="hs-identifier hs-var">codeFun</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261161"><span class="hs-identifier hs-var">this</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261160"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Operand -&gt; Continuation
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkCont"><span class="hs-identifier hs-var">MkCont</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261159"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261155"><span class="annot"><span class="annottext">codePtr :: Constant
</span><a href="#local-6989586621679261155"><span class="hs-identifier hs-var hs-var">codePtr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Name -&gt; Constant
</span><span class="hs-identifier hs-var">GlobalReference</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Closure.html#clsEntryTy"><span class="hs-identifier hs-var">clsEntryTy</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679261166"><span class="hs-identifier hs-var">entryName</span></a></span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span>    </span><span id="local-6989586621679261154"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679261154"><span class="hs-identifier hs-var">printPtr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IRBuilderT m Constant
forall (m :: * -&gt; *). MonadCodeGen m =&gt; m Constant
</span><a href="Hachi.Compiler.CodeGen.Closure.html#compileFunPrint"><span class="hs-identifier hs-var">compileFunPrint</span></a></span><span>
</span><span id="line-294"></span><span>
</span><span id="line-295"></span><span>    </span><span id="local-6989586621679261153"><span class="annot"><span class="annottext">Map Text Local
</span><a href="#local-6989586621679261153"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(CodeGenSt -&gt; Map Text Local) -&gt; IRBuilderT m (Map Text Local)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">CodeGenSt -&gt; Map Text Local
</span><a href="Hachi.Compiler.CodeGen.Monad.html#codeGenEnv"><span class="hs-identifier hs-var hs-var">codeGenEnv</span></a></span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span>    </span><span id="local-6989586621679261150"><span class="annot"><span class="annottext">[Local]
</span><a href="#local-6989586621679261150"><span class="hs-identifier hs-var">vals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Text, Bool)]
-&gt; ((Text, Bool) -&gt; IRBuilderT m Local) -&gt; IRBuilderT m [Local]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set (Text, Bool) -&gt; [(Text, Bool)]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">Set (Text, Bool)
</span><a href="#local-6989586621679261169"><span class="hs-identifier hs-var">fvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Text, Bool) -&gt; IRBuilderT m Local) -&gt; IRBuilderT m [Local])
-&gt; ((Text, Bool) -&gt; IRBuilderT m Local) -&gt; IRBuilderT m [Local]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679261149"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679261149"><span class="hs-identifier hs-var">fv</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Map Text Local -&gt; Maybe Local
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679261149"><span class="hs-identifier hs-var">fv</span></a></span><span> </span><span class="annot"><span class="annottext">Map Text Local
</span><a href="#local-6989586621679261153"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-298"></span><span>        </span><span class="hs-comment">-- TODO: handle this a bit more nicely</span><span>
</span><span id="line-299"></span><span>        </span><span class="annot"><span class="annottext">Maybe Local
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IRBuilderT m Local
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Can't find variable&quot;</span></span><span>
</span><span id="line-300"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679261147"><span class="annot"><span class="annottext">Local
</span><a href="#local-6989586621679261147"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Local -&gt; IRBuilderT m Local
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Local
</span><a href="#local-6989586621679261147"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; Constant
-&gt; Constant
-&gt; [Operand]
-&gt; IRBuilderT m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m) =&gt;
Bool
-&gt; Constant -&gt; Constant -&gt; [Operand] -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Closure.html#allocateClosure"><span class="hs-identifier hs-var">allocateClosure</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679261171"><span class="hs-identifier hs-var">isDelay</span></a></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679261155"><span class="hs-identifier hs-var">codePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679261154"><span class="hs-identifier hs-var">printPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Local -&gt; Operand) -&gt; [Local] -&gt; [Operand]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Local -&gt; Operand
</span><a href="Hachi.Compiler.CodeGen.Types.html#localOperand"><span class="hs-identifier hs-var">localOperand</span></a></span><span> </span><span class="annot"><span class="annottext">[Local]
</span><a href="#local-6989586621679261150"><span class="hs-identifier hs-var">vals</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span class="hs-comment">-- | `compileFunPrint` is a computation which generates the shared</span><span>
</span><span id="line-305"></span><span class="hs-comment">-- pretty-printing code for all function closures and returns a</span><span>
</span><span id="line-306"></span><span class="hs-comment">-- reference to it.</span><span>
</span><span id="line-307"></span><span id="local-6989586621679261364"><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#compileFunPrint"><span class="hs-identifier hs-type">compileFunPrint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#MonadCodeGen"><span class="hs-identifier hs-type">MonadCodeGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261364"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679261364"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Constant</span></span></span><span>
</span><span id="line-308"></span><span id="compileFunPrint"><span class="annot"><span class="annottext">compileFunPrint :: m Constant
</span><a href="Hachi.Compiler.CodeGen.Closure.html#compileFunPrint"><span class="hs-identifier hs-var hs-var">compileFunPrint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-comment">-- we need to check whether the code has already been generated or not:</span><span>
</span><span id="line-310"></span><span>    </span><span class="hs-comment">-- for that we try to retrieve it from the environment</span><span>
</span><span id="line-311"></span><span>    </span><span id="local-6989586621679261145"><span class="annot"><span class="annottext">IORef (Maybe Constant)
</span><a href="#local-6989586621679261145"><span class="hs-identifier hs-var">ioRef</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(CodeGenSt -&gt; IORef (Maybe Constant)) -&gt; m (IORef (Maybe Constant))
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">CodeGenSt -&gt; IORef (Maybe Constant)
</span><a href="Hachi.Compiler.CodeGen.Monad.html#codeGenFunPrinter"><span class="hs-identifier hs-var hs-var">codeGenFunPrinter</span></a></span><span>
</span><span id="line-312"></span><span>    </span><span id="local-6989586621679261143"><span class="annot"><span class="annottext">Maybe Constant
</span><a href="#local-6989586621679261143"><span class="hs-identifier hs-var">mRef</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Maybe Constant) -&gt; m (Maybe Constant)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe Constant) -&gt; m (Maybe Constant))
-&gt; IO (Maybe Constant) -&gt; m (Maybe Constant)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe Constant) -&gt; IO (Maybe Constant)
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe Constant)
</span><a href="#local-6989586621679261145"><span class="hs-identifier hs-var">ioRef</span></a></span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Constant
</span><a href="#local-6989586621679261143"><span class="hs-identifier hs-var">mRef</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-315"></span><span>        </span><span class="hs-comment">-- it exists: just return the reference</span><span>
</span><span id="line-316"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679261140"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679261140"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Constant -&gt; m Constant
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679261140"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-317"></span><span>        </span><span class="hs-comment">-- it doesn't: generate the code, store the reference in the</span><span>
</span><span id="line-318"></span><span>        </span><span class="hs-comment">-- environment, and then return it</span><span>
</span><span id="line-319"></span><span>        </span><span class="annot"><span class="annottext">Maybe Constant
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-320"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261139"><span class="annot"><span class="annottext">printName :: Name
</span><a href="#local-6989586621679261139"><span class="hs-identifier hs-var hs-var">printName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">mkName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Function_print&quot;</span></span><span>
</span><span id="line-321"></span><span>
</span><span id="line-322"></span><span>            </span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name
-&gt; [(Type, ParameterName)]
-&gt; Type
-&gt; (Global -&gt; Global)
-&gt; ([Operand] -&gt; IRBuilderT m ())
-&gt; m Operand
forall (m :: * -&gt; *).
MonadModuleBuilder m =&gt;
Name
-&gt; [(Type, ParameterName)]
-&gt; Type
-&gt; (Global -&gt; Global)
-&gt; ([Operand] -&gt; IRBuilderT m ())
-&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#function"><span class="hs-identifier hs-var">IR.function</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679261139"><span class="hs-identifier hs-var">printName</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ParameterName
</span><span class="hs-string">&quot;this&quot;</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier hs-var">VoidType</span></span><span> </span><span class="annot"><span class="annottext">Global -&gt; Global
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#plcFunOpts"><span class="hs-identifier hs-var">plcFunOpts</span></a></span><span> </span><span class="annot"><span class="annottext">(([Operand] -&gt; IRBuilderT m ()) -&gt; m Operand)
-&gt; ([Operand] -&gt; IRBuilderT m ()) -&gt; m Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Operand
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-323"></span><span>                </span><span class="annot"><span class="annottext">String -&gt; [Operand] -&gt; IRBuilderT m ()
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m) =&gt;
String -&gt; [Operand] -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Common.html#compileTrace"><span class="hs-identifier hs-var">compileTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Function_print&quot;</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-324"></span><span>                </span><span class="annot"><span class="annottext">IRBuilderT m Operand -&gt; IRBuilderT m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IRBuilderT m Operand -&gt; IRBuilderT m ())
-&gt; IRBuilderT m Operand -&gt; IRBuilderT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operand
-&gt; [(Operand, [ParameterAttribute])]
-&gt; (Instruction -&gt; Instruction)
-&gt; IRBuilderT m Operand
forall (m :: * -&gt; *).
(HasCallStack, MonadFail m, MonadIRBuilder m,
 MonadModuleBuilder m) =&gt;
Operand
-&gt; [(Operand, [ParameterAttribute])]
-&gt; (Instruction -&gt; Instruction)
-&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#call"><span class="hs-identifier hs-var">call</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="Hachi.Compiler.CodeGen.Externals.html#printfRef"><span class="hs-identifier hs-var">printfRef</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#funErrRef"><span class="hs-identifier hs-var">funErrRef</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Instruction -&gt; Instruction
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#plcCall"><span class="hs-identifier hs-var">plcCall</span></a></span><span>
</span><span id="line-325"></span><span>                </span><span class="annot"><span class="annottext">IRBuilderT m ()
forall (m :: * -&gt; *). MonadIRBuilder m =&gt; m ()
</span><span class="hs-identifier hs-var">retVoid</span></span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261133"><span class="annot"><span class="annottext">ref :: Constant
</span><a href="#local-6989586621679261133"><span class="hs-identifier hs-var hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Name -&gt; Constant
</span><span class="hs-identifier hs-var">GlobalReference</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Closure.html#printFnTy"><span class="hs-identifier hs-var">printFnTy</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679261139"><span class="hs-identifier hs-var">printName</span></a></span><span>
</span><span id="line-328"></span><span>            </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe Constant) -&gt; Maybe Constant -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe Constant)
</span><a href="#local-6989586621679261145"><span class="hs-identifier hs-var">ioRef</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Constant -&gt; IO ()) -&gt; Maybe Constant -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Constant -&gt; Maybe Constant
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679261133"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span>            </span><span class="annot"><span class="annottext">Constant -&gt; m Constant
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679261133"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-333"></span><span>
</span><span id="line-334"></span><span class="hs-comment">-- | `loadFromClosure` @component type ptr@ loads the component described by</span><span>
</span><span id="line-335"></span><span class="hs-comment">-- @component@ from the closure represented by @ptr@ and casts its type to</span><span>
</span><span id="line-336"></span><span class="hs-comment">-- @type@.</span><span>
</span><span id="line-337"></span><span id="local-6989586621679261427"><span id="local-6989586621679261428"><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#loadFromClosure"><span class="hs-identifier hs-type">loadFromClosure</span></a></span><span>
</span><span id="line-338"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadModuleBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679261428"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679261428"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-339"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureComponent"><span class="hs-identifier hs-type">ClosureComponent</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261427"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679261428"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Operand</span></span></span></span><span>
</span><span id="line-340"></span><span id="loadFromClosure"><span class="annot"><span class="annottext">loadFromClosure :: ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#loadFromClosure"><span class="hs-identifier hs-var hs-var">loadFromClosure</span></a></span></span><span> </span><span id="local-6989586621679261131"><span class="annot"><span class="annottext">ClosureComponent
</span><a href="#local-6989586621679261131"><span class="hs-identifier hs-var">prop</span></a></span></span><span> </span><span id="local-6989586621679261130"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679261130"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621679261129"><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679261129"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-341"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261128"><span class="annot"><span class="annottext">ix :: [Operand]
</span><a href="#local-6989586621679261128"><span class="hs-identifier hs-var hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClosureComponent -&gt; [Operand]
</span><a href="Hachi.Compiler.CodeGen.Closure.html#indicesForComponent"><span class="hs-identifier hs-var">indicesForComponent</span></a></span><span> </span><span class="annot"><span class="annottext">ClosureComponent
</span><a href="#local-6989586621679261131"><span class="hs-identifier hs-var">prop</span></a></span><span>
</span><span id="line-342"></span><span>    </span><span id="local-6989586621679261127"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261127"><span class="hs-identifier hs-var">ptrt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#castToClosure"><span class="hs-identifier hs-var">castToClosure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClosurePtr k -&gt; Operand
forall (k :: PtrKind) to. FromClosurePtr k to =&gt; ClosurePtr k -&gt; to
</span><a href="Hachi.Compiler.CodeGen.Types.html#closurePtr"><span class="hs-identifier hs-var">closurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679261129"><span class="hs-identifier hs-var">ptr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-343"></span><span>    </span><span id="local-6989586621679261124"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261124"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; m Operand
forall (m :: * -&gt; *).
(HasCallStack, MonadIRBuilder m, MonadModuleBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><span class="hs-identifier hs-var">gep</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261127"><span class="hs-identifier hs-var">ptrt</span></a></span><span> </span><span class="annot"><span class="annottext">([Operand] -&gt; m Operand) -&gt; [Operand] -&gt; m Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; Integer -&gt; Constant
</span><span class="hs-identifier hs-var">Int</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">32</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; [Operand]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Operand]
</span><a href="#local-6989586621679261128"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-344"></span><span>
</span><span id="line-345"></span><span>    </span><span id="local-6989586621679261123"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261123"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Operand -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Type -&gt; Operand -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#castIfNeeded"><span class="hs-identifier hs-var">castIfNeeded</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#ptrOf"><span class="hs-identifier hs-var">ptrOf</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679261130"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261124"><span class="hs-identifier hs-var">addr</span></a></span><span>
</span><span id="line-346"></span><span>    </span><span class="annot"><span class="annottext">Operand -&gt; Word32 -&gt; m Operand
forall (m :: * -&gt; *).
(HasCallStack, MonadIRBuilder m, MonadModuleBuilder m) =&gt;
Operand -&gt; Word32 -&gt; m Operand
</span><span class="hs-identifier hs-var">load</span></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261123"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">0</span></span><span>
</span><span id="line-347"></span><span>
</span><span id="line-348"></span><span class="hs-comment">-- | `callClosure` @component ptr args@ loads the component described by</span><span>
</span><span id="line-349"></span><span class="hs-comment">-- @component@ from the closure represented by @ptr@, assumes it is a function,</span><span>
</span><span id="line-350"></span><span class="hs-comment">-- and then calls it with @args@ as arguments.</span><span>
</span><span id="line-351"></span><span id="local-6989586621679261334"><span id="local-6989586621679261335"><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#callClosure"><span class="hs-identifier hs-type">callClosure</span></a></span><span>
</span><span id="line-352"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadFail</span></span><span> </span><span class="annot"><a href="#local-6989586621679261335"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadModuleBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679261335"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679261335"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureComponent"><span class="hs-identifier hs-type">ClosureComponent</span></a></span><span>
</span><span id="line-354"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261334"><span class="hs-identifier hs-type">k</span></a></span><span>
</span><span id="line-355"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Operand</span></span><span class="hs-special">]</span><span>
</span><span id="line-356"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679261335"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#DynamicPtr"><span class="hs-identifier hs-type">DynamicPtr</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-357"></span><span id="callClosure"><span class="annot"><span class="annottext">callClosure :: ClosureComponent
-&gt; ClosurePtr k -&gt; [Operand] -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Closure.html#callClosure"><span class="hs-identifier hs-var hs-var">callClosure</span></a></span></span><span> </span><span id="local-6989586621679261122"><span class="annot"><span class="annottext">ClosureComponent
</span><a href="#local-6989586621679261122"><span class="hs-identifier hs-var">prop</span></a></span></span><span> </span><span id="local-6989586621679261121"><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679261121"><span class="hs-identifier hs-var">closure</span></a></span></span><span> </span><span id="local-6989586621679261120"><span class="annot"><span class="annottext">[Operand]
</span><a href="#local-6989586621679261120"><span class="hs-identifier hs-var">argv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-358"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261119"><span class="annot"><span class="annottext">ty :: Type
</span><a href="#local-6989586621679261119"><span class="hs-identifier hs-var hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClosureComponent -&gt; Type
</span><a href="Hachi.Compiler.CodeGen.Closure.html#fnTyForComponent"><span class="hs-identifier hs-var">fnTyForComponent</span></a></span><span> </span><span class="annot"><span class="annottext">ClosureComponent
</span><a href="#local-6989586621679261122"><span class="hs-identifier hs-var">prop</span></a></span><span>
</span><span id="line-359"></span><span>    </span><span id="local-6989586621679261118"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261118"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosureComponent -&gt; Type -&gt; ClosurePtr k -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#loadFromClosure"><span class="hs-identifier hs-var">loadFromClosure</span></a></span><span> </span><span class="annot"><span class="annottext">ClosureComponent
</span><a href="#local-6989586621679261122"><span class="hs-identifier hs-var">prop</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679261119"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679261121"><span class="hs-identifier hs-var">closure</span></a></span><span>
</span><span id="line-360"></span><span>    </span><span id="local-6989586621679261117"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261117"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#castToClosure"><span class="hs-identifier hs-var">castToClosure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClosurePtr k -&gt; Operand
forall (k :: PtrKind) to. FromClosurePtr k to =&gt; ClosurePtr k -&gt; to
</span><a href="Hachi.Compiler.CodeGen.Types.html#closurePtr"><span class="hs-identifier hs-var">closurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679261121"><span class="hs-identifier hs-var">closure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>
</span><span id="line-362"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261116"><span class="annot"><span class="annottext">callArgs :: [(Operand, [ParameterAttribute])]
</span><a href="#local-6989586621679261116"><span class="hs-identifier hs-var hs-var">callArgs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261117"><span class="hs-identifier hs-var">ptr</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Operand, [ParameterAttribute])
-&gt; [(Operand, [ParameterAttribute])]
-&gt; [(Operand, [ParameterAttribute])]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261115"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679261115"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261115"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Operand]
</span><a href="#local-6989586621679261120"><span class="hs-identifier hs-var">argv</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-363"></span><span>
</span><span id="line-364"></span><span>    </span><span class="annot"><span class="annottext">Operand -&gt; ClosurePtr 'DynamicPtr
</span><a href="Hachi.Compiler.CodeGen.Types.html#MkClosurePtr"><span class="hs-identifier hs-var">MkClosurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">(Operand -&gt; ClosurePtr 'DynamicPtr)
-&gt; m Operand -&gt; m (ClosurePtr 'DynamicPtr)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Operand
-&gt; [(Operand, [ParameterAttribute])]
-&gt; (Instruction -&gt; Instruction)
-&gt; m Operand
forall (m :: * -&gt; *).
(HasCallStack, MonadFail m, MonadIRBuilder m,
 MonadModuleBuilder m) =&gt;
Operand
-&gt; [(Operand, [ParameterAttribute])]
-&gt; (Instruction -&gt; Instruction)
-&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#call"><span class="hs-identifier hs-var">call</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261118"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="annot"><span class="annottext">[(Operand, [ParameterAttribute])]
</span><a href="#local-6989586621679261116"><span class="hs-identifier hs-var">callArgs</span></a></span><span> </span><span class="annot"><span class="annottext">Instruction -&gt; Instruction
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#plcCall"><span class="hs-identifier hs-var">plcCall</span></a></span><span>
</span><span id="line-365"></span><span>
</span><span id="line-366"></span><span class="hs-comment">-- `enterClosure` @ptr args@ enters the closure represented by @ptr@ and</span><span>
</span><span id="line-367"></span><span class="hs-comment">-- provides the arguments given by @args@.</span><span>
</span><span id="line-368"></span><span id="local-6989586621679261326"><span id="local-6989586621679261327"><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#enterClosure"><span class="hs-identifier hs-type">enterClosure</span></a></span><span>
</span><span id="line-369"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadFail</span></span><span> </span><span class="annot"><a href="#local-6989586621679261327"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadModuleBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679261327"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679261327"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-370"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261326"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#Continuation"><span class="hs-identifier hs-type">Continuation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Operand</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679261327"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#DynamicPtr"><span class="hs-identifier hs-type">DynamicPtr</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-371"></span><span id="enterClosure"><span class="annot"><span class="annottext">enterClosure :: ClosurePtr k
-&gt; Continuation -&gt; Maybe Operand -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Closure.html#enterClosure"><span class="hs-identifier hs-var hs-var">enterClosure</span></a></span></span><span> </span><span id="local-6989586621679261114"><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679261114"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span id="local-6989586621679261113"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679261113"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679261112"><span class="annot"><span class="annottext">Maybe Operand
</span><a href="#local-6989586621679261112"><span class="hs-identifier hs-var">mArg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-372"></span><span>    </span><span id="local-6989586621679261111"><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261111"><span class="hs-identifier hs-var">targ</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#castToClosure"><span class="hs-identifier hs-var">castToClosure</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261110"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-373"></span><span>    </span><span class="annot"><span class="annottext">ClosureComponent
-&gt; ClosurePtr k -&gt; [Operand] -&gt; m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadFail m, MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosureComponent
-&gt; ClosurePtr k -&gt; [Operand] -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Closure.html#callClosure"><span class="hs-identifier hs-var">callClosure</span></a></span><span> </span><span class="annot"><span class="annottext">ClosureComponent
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ClosureCode"><span class="hs-identifier hs-var">ClosureCode</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679261114"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Operand
</span><a href="#local-6989586621679261111"><span class="hs-identifier hs-var">targ</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Continuation -&gt; Operand
</span><a href="Hachi.Compiler.CodeGen.Types.html#contPtr"><span class="hs-identifier hs-var hs-var">contPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679261113"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-374"></span><span>    </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679261110"><span class="annot"><span class="annottext">arg :: Operand
</span><a href="#local-6989586621679261110"><span class="hs-identifier hs-var hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; Maybe Operand -&gt; Operand
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; Operand) -&gt; Constant -&gt; Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Constant
</span><span class="hs-identifier hs-var">Null</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Operand
</span><a href="#local-6989586621679261112"><span class="hs-identifier hs-var">mArg</span></a></span><span>
</span><span id="line-375"></span><span>
</span><span id="line-376"></span><span class="hs-comment">-- | `printClosure` @ptr@ invokes the pretty-printing function of the closure</span><span>
</span><span id="line-377"></span><span class="hs-comment">-- represented by @ptr@.</span><span>
</span><span id="line-378"></span><span id="local-6989586621679261318"><span id="local-6989586621679261319"><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#printClosure"><span class="hs-identifier hs-type">printClosure</span></a></span><span>
</span><span id="line-379"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadFail</span></span><span> </span><span class="annot"><a href="#local-6989586621679261319"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadModuleBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679261319"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679261319"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-380"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261318"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679261319"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-381"></span><span id="printClosure"><span class="annot"><span class="annottext">printClosure :: ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Closure.html#printClosure"><span class="hs-identifier hs-var hs-var">printClosure</span></a></span></span><span> </span><span id="local-6989586621679261107"><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679261107"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (ClosurePtr 'DynamicPtr) -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m (ClosurePtr 'DynamicPtr) -&gt; m ())
-&gt; m (ClosurePtr 'DynamicPtr) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ClosureComponent
-&gt; ClosurePtr k -&gt; [Operand] -&gt; m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadFail m, MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosureComponent
-&gt; ClosurePtr k -&gt; [Operand] -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Closure.html#callClosure"><span class="hs-identifier hs-var">callClosure</span></a></span><span> </span><span class="annot"><span class="annottext">ClosureComponent
</span><a href="Hachi.Compiler.CodeGen.Closure.html#ClosurePrint"><span class="hs-identifier hs-var">ClosurePrint</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679261107"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-382"></span><span>
</span><span id="line-383"></span><span class="hs-comment">-- | `compileApply` @funClosure argClosure@ generates code which causes the</span><span>
</span><span id="line-384"></span><span class="hs-comment">-- program to enter the closure represented by @funClosure@ with the argument</span><span>
</span><span id="line-385"></span><span class="hs-comment">-- given by @argClosure@.</span><span>
</span><span id="line-386"></span><span id="local-6989586621679261104"><span id="local-6989586621679261105"><span id="local-6989586621679261106"><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#compileApply"><span class="hs-identifier hs-type">compileApply</span></a></span><span>
</span><span id="line-387"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadFail</span></span><span> </span><span class="annot"><a href="#local-6989586621679261106"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadModuleBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679261106"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679261106"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#Continuation"><span class="hs-identifier hs-type">Continuation</span></a></span><span>
</span><span id="line-389"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261105"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-390"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261104"><span class="hs-identifier hs-type">x</span></a></span><span>
</span><span id="line-391"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679261106"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#DynamicPtr"><span class="hs-identifier hs-type">DynamicPtr</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-392"></span><span id="compileApply"><span class="annot"><span class="annottext">compileApply :: Continuation
-&gt; ClosurePtr f -&gt; ClosurePtr x -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Closure.html#compileApply"><span class="hs-identifier hs-var hs-var">compileApply</span></a></span></span><span> </span><span id="local-6989586621679261103"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679261103"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679261102"><span class="annot"><span class="annottext">ClosurePtr f
</span><a href="#local-6989586621679261102"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679261101"><span class="annot"><span class="annottext">ClosurePtr x
</span><a href="#local-6989586621679261101"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-393"></span><span>    </span><span class="hs-comment">-- enter the closure pointed to by f, giving it a pointer to another</span><span>
</span><span id="line-394"></span><span>    </span><span class="hs-comment">-- closure x as argument</span><span>
</span><span id="line-395"></span><span>    </span><span class="annot"><span class="annottext">ClosurePtr f
-&gt; Continuation -&gt; Maybe Operand -&gt; m (ClosurePtr 'DynamicPtr)
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadFail m, MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosurePtr k
-&gt; Continuation -&gt; Maybe Operand -&gt; m (ClosurePtr 'DynamicPtr)
</span><a href="Hachi.Compiler.CodeGen.Closure.html#enterClosure"><span class="hs-identifier hs-var">enterClosure</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr f
</span><a href="#local-6989586621679261102"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679261103"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Operand -&gt; m (ClosurePtr 'DynamicPtr))
-&gt; Maybe Operand -&gt; m (ClosurePtr 'DynamicPtr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; Maybe Operand
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClosurePtr x -&gt; Operand
forall (k :: PtrKind) to. FromClosurePtr k to =&gt; ClosurePtr k -&gt; to
</span><a href="Hachi.Compiler.CodeGen.Types.html#closurePtr"><span class="hs-identifier hs-var">closurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr x
</span><a href="#local-6989586621679261101"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-396"></span><span>
</span><span id="line-397"></span><span class="hs-comment">-- | `lookupVar` @name type@ generates code which retrieves the variable named</span><span>
</span><span id="line-398"></span><span class="hs-comment">-- @name@ from the local environment. If the variable is not in scope, we</span><span>
</span><span id="line-399"></span><span class="hs-comment">-- generate code which prints an error at runtime. For convenience, we cast</span><span>
</span><span id="line-400"></span><span class="hs-comment">-- the type of the resulting `Operand` to @type@, which will normally be</span><span>
</span><span id="line-401"></span><span class="hs-comment">-- `closureTyPtr`.</span><span>
</span><span id="line-402"></span><span id="local-6989586621679261100"><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#lookupVar"><span class="hs-identifier hs-type">lookupVar</span></a></span><span>
</span><span id="line-403"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Monad.html#MonadCodeGen"><span class="hs-identifier hs-type">MonadCodeGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261100"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679261100"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadFail</span></span><span> </span><span class="annot"><a href="#local-6989586621679261100"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-404"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679261100"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Operand</span></span></span><span>
</span><span id="line-405"></span><span id="lookupVar"><span class="annot"><span class="annottext">lookupVar :: Text -&gt; Type -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Closure.html#lookupVar"><span class="hs-identifier hs-var hs-var">lookupVar</span></a></span></span><span> </span><span id="local-6989586621679261099"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679261099"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span id="local-6989586621679261098"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679261098"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-406"></span><span>    </span><span id="local-6989586621679261097"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261097"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; m String
forall (m :: * -&gt; *).
(MonadReader CodeGenSt m, MonadIO m) =&gt;
String -&gt; m String
</span><a href="Hachi.Compiler.CodeGen.Monad.html#mkFresh"><span class="hs-identifier hs-var">mkFresh</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;var&quot;</span></span><span>
</span><span id="line-407"></span><span>
</span><span id="line-408"></span><span>    </span><span class="hs-comment">-- retrieve the current environment to see if this variable is free or not</span><span>
</span><span id="line-409"></span><span>    </span><span class="hs-comment">-- if it is free, we just generate some no-op code so that the pointer to</span><span>
</span><span id="line-410"></span><span>    </span><span class="hs-comment">-- the closure is returned, which will then cause the rts to print the</span><span>
</span><span id="line-411"></span><span>    </span><span class="hs-comment">-- variable name if it ends up being the result of the program</span><span>
</span><span id="line-412"></span><span>    </span><span class="hs-comment">-- otherwise, if the variable is not free, we push the closure that</span><span>
</span><span id="line-413"></span><span>    </span><span class="hs-comment">-- corresponds to variable in scope</span><span>
</span><span id="line-414"></span><span>    </span><span id="local-6989586621679261095"><span class="annot"><span class="annottext">Map Text Local
</span><a href="#local-6989586621679261095"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(CodeGenSt -&gt; Map Text Local) -&gt; m (Map Text Local)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">CodeGenSt -&gt; Map Text Local
</span><a href="Hachi.Compiler.CodeGen.Monad.html#codeGenEnv"><span class="hs-identifier hs-var hs-var">codeGenEnv</span></a></span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Map Text Local -&gt; Maybe Local
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679261099"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">Map Text Local
</span><a href="#local-6989586621679261095"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-417"></span><span>        </span><span class="annot"><span class="annottext">Maybe Local
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-418"></span><span>            </span><span class="hs-comment">-- generate code that prints a suitable error message</span><span>
</span><span id="line-419"></span><span>            </span><span id="local-6989586621679261094"><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679261094"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name -&gt; (Global -&gt; Global) -&gt; m Constant
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadFail m) =&gt;
String -&gt; Name -&gt; (Global -&gt; Global) -&gt; m Constant
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#globalStringPtr"><span class="hs-identifier hs-var">globalStringPtr</span></a></span><span>
</span><span id="line-420"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679261099"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; is not in scope.\n&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">mkName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261097"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Global -&gt; Global) -&gt; m Constant)
-&gt; (Global -&gt; Global) -&gt; m Constant
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-421"></span><span>                </span><span class="annot"><span class="annottext">Linkage -&gt; Global -&gt; Global
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#setLinkage"><span class="hs-identifier hs-var">setLinkage</span></a></span><span> </span><span class="annot"><span class="annottext">Linkage
</span><span class="hs-identifier hs-var">Private</span></span><span>
</span><span id="line-422"></span><span>            </span><span class="annot"><span class="annottext">m Operand -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m Operand -&gt; m ()) -&gt; m Operand -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#printf"><span class="hs-identifier hs-var">printf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="annot"><span class="annottext">Constant
</span><a href="#local-6989586621679261094"><span class="hs-identifier hs-var">ptr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-423"></span><span>            </span><span class="annot"><span class="annottext">m Operand -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m Operand -&gt; m ()) -&gt; m Operand -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Integer -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#exit"><span class="hs-identifier hs-var">exit</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span>            </span><span class="hs-comment">-- this part of the program should not be reachable</span><span>
</span><span id="line-426"></span><span>            </span><span class="annot"><span class="annottext">m ()
forall (m :: * -&gt; *). MonadIRBuilder m =&gt; m ()
</span><span class="hs-identifier hs-var">unreachable</span></span><span>
</span><span id="line-427"></span><span>            </span><span class="annot"><span class="annottext">Operand -&gt; m Operand
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Operand -&gt; m Operand) -&gt; Operand -&gt; m Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Constant -&gt; Operand
</span><span class="hs-identifier hs-var">ConstantOperand</span></span><span> </span><span class="annot"><span class="annottext">(Constant -&gt; Operand) -&gt; Constant -&gt; Operand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Constant
</span><span class="hs-identifier hs-var">Null</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span>
</span><span id="line-428"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#LocalClosure"><span class="hs-identifier hs-type">LocalClosure</span></a></span><span> </span><span id="local-6989586621679261088"><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679261088"><span class="hs-identifier hs-var">ptr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-429"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; [Operand] -&gt; m ()
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m) =&gt;
String -&gt; [Operand] -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Common.html#compileTrace"><span class="hs-identifier hs-var">compileTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Found &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679261099"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; in &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261097"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-430"></span><span>            </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall (m :: * -&gt; *). MonadCodeGen m =&gt; m () -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Common.html#ifTracing"><span class="hs-identifier hs-var">ifTracing</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-431"></span><span>                </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; m ()
forall (m :: * -&gt; *) (k :: PtrKind).
(MonadFail m, MonadModuleBuilder m, MonadIRBuilder m) =&gt;
ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Closure.html#printClosure"><span class="hs-identifier hs-var">printClosure</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679261088"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-432"></span><span>                </span><span class="annot"><span class="annottext">m Operand -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m Operand -&gt; m ()) -&gt; m Operand -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; [Operand] -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; [Operand] -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.Externals.html#printf"><span class="hs-identifier hs-var">printf</span></a></span><span> </span><span class="annot"><span class="annottext">Operand
</span><a href="Hachi.Compiler.CodeGen.Globals.html#nlRef"><span class="hs-identifier hs-var">nlRef</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-433"></span><span>            </span><span class="annot"><span class="annottext">Type -&gt; Operand -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Type -&gt; Operand -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#castIfNeeded"><span class="hs-identifier hs-var">castIfNeeded</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#closureTyPtr"><span class="hs-identifier hs-var">closureTyPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr -&gt; Operand
forall (k :: PtrKind) to. FromClosurePtr k to =&gt; ClosurePtr k -&gt; to
</span><a href="Hachi.Compiler.CodeGen.Types.html#closurePtr"><span class="hs-identifier hs-var">closurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr 'DynamicPtr
</span><a href="#local-6989586621679261088"><span class="hs-identifier hs-var">ptr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#LocalCont"><span class="hs-identifier hs-type">LocalCont</span></a></span><span> </span><span id="local-6989586621679261085"><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679261085"><span class="hs-identifier hs-var">ptr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-435"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; [Operand] -&gt; m ()
forall (m :: * -&gt; *).
(MonadCodeGen m, MonadIRBuilder m) =&gt;
String -&gt; [Operand] -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Common.html#compileTrace"><span class="hs-identifier hs-var">compileTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Found continuation &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679261099"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; in &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261097"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-436"></span><span>            </span><span class="annot"><span class="annottext">Type -&gt; Operand -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Type -&gt; Operand -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#castIfNeeded"><span class="hs-identifier hs-var">castIfNeeded</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Hachi.Compiler.CodeGen.Types.html#contTyPtr"><span class="hs-identifier hs-var">contTyPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Continuation -&gt; Operand
</span><a href="Hachi.Compiler.CodeGen.Types.html#contPtr"><span class="hs-identifier hs-var hs-var">contPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Continuation
</span><a href="#local-6989586621679261085"><span class="hs-identifier hs-var">ptr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-437"></span><span>
</span><span id="line-438"></span><span class="hs-comment">-- | `retClosure` @closurePtr@ returns the pointer represented by @closurePtr@.</span><span>
</span><span id="line-439"></span><span id="local-6989586621679261083"><span id="local-6989586621679261084"><span class="annot"><a href="Hachi.Compiler.CodeGen.Closure.html#retClosure"><span class="hs-identifier hs-type">retClosure</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadModuleBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679261084"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIRBuilder</span></span><span> </span><span class="annot"><a href="#local-6989586621679261084"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hachi.Compiler.CodeGen.Types.html#ClosurePtr"><span class="hs-identifier hs-type">ClosurePtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261083"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679261084"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-440"></span><span id="retClosure"><span class="annot"><span class="annottext">retClosure :: ClosurePtr k -&gt; m ()
</span><a href="Hachi.Compiler.CodeGen.Closure.html#retClosure"><span class="hs-identifier hs-var hs-var">retClosure</span></a></span></span><span> </span><span id="local-6989586621679261082"><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679261082"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Operand -&gt; m Operand
forall (m :: * -&gt; *).
(MonadModuleBuilder m, MonadIRBuilder m) =&gt;
Operand -&gt; m Operand
</span><a href="Hachi.Compiler.CodeGen.IRBuilder.html#castToClosure"><span class="hs-identifier hs-var">castToClosure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClosurePtr k -&gt; Operand
forall (k :: PtrKind) to. FromClosurePtr k to =&gt; ClosurePtr k -&gt; to
</span><a href="Hachi.Compiler.CodeGen.Types.html#closurePtr"><span class="hs-identifier hs-var">closurePtr</span></a></span><span> </span><span class="annot"><span class="annottext">ClosurePtr k
</span><a href="#local-6989586621679261082"><span class="hs-identifier hs-var">ptr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m Operand -&gt; (Operand -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Operand -&gt; m ()
forall (m :: * -&gt; *). MonadIRBuilder m =&gt; Operand -&gt; m ()
</span><span class="hs-identifier hs-var">ret</span></span><span>
</span><span id="line-441"></span><span>
</span><span id="line-442"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-443"></span></pre></body></html>